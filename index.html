<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Force no-cache để đảm bảo luôn load file mới nhất -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>License Manager với Verify Online</title>
    <!-- JSON API Response cho ?verify= -->
    <script>
        // Output JSON ngay đầu file nếu có ?verify= (cho Python requests)
        (function() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const verifyKey = urlParams.get('verify');
                const format = urlParams.get('format');
                const hasHash = window.location.hash && window.location.hash.length > 1;
                const hasOtherParams = Array.from(urlParams.keys()).some(k => k !== 'verify' && k !== 'format');
                
                if (verifyKey && (format === 'json' || (!hasHash && !hasOtherParams))) {
                    // Load licenses từ localStorage
                    let licenses = [];
                    try {
                        const data = localStorage.getItem('licenses');
                        if (data) licenses = JSON.parse(data);
                    } catch(e) {}
                    
                    const license = licenses.find(l => l.key === verifyKey.toUpperCase());
                    const now = new Date();
                    
                    let result;
                    if (!license) {
                        result = {valid: false, key: verifyKey, status: 'expired', message: 'License không tồn tại', days_remaining: 0, timestamp: now.toISOString()};
                    } else {
                        const expiry = new Date(license.expiry);
                        const diffTime = expiry - now;
                        // Dùng Math.floor để tính chính xác số ngày (có thể âm nếu đã hết hạn)
                        const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                        let status, valid;
                        // Hết hạn khi đã qua thời điểm expiry
                        if (diffTime <= 0) { status = 'expired'; valid = false; }
                        else if (diffDays <= 7) { status = 'expiring'; valid = true; }
                        else { status = 'valid'; valid = true; }
                        result = {
                            valid: valid,
                            key: license.key,
                            expiry: license.expiry,
                            status: valid && status !== 'expired' ? 'active' : status,
                            message: valid ? (status === 'expiring' ? 'License sắp hết hạn' : 'License hợp lệ') : 'License đã hết hạn',
                            days_remaining: diffDays,
                            note: license.note || '',
                            timestamp: now.toISOString()
                        };
                    }
                    // Output JSON vào document ngay lập tức
                    document.open('text/plain');
                    document.write(JSON.stringify(result));
                    document.close();
                    if (window.stop) window.stop();
                }
            } catch(e) {}
        })();
    </script>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <style>
        body { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            min-height: 100vh;
            padding-bottom: 20px;
        }
        .container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            padding: 30px;
            margin-top: 30px;
            margin-bottom: 30px;
            position: relative;
            z-index: 1;
        }
        
        /* Đảm bảo tất cả input và button có thể click được */
        input, button, select, textarea, .form-control, .btn {
            pointer-events: auto !important;
            cursor: pointer !important;
            position: relative;
            z-index: 10;
        }
        
        input[type="text"],
        input[type="search"],
        input[type="email"],
        input[type="password"],
        input[type="datetime-local"],
        textarea {
            cursor: text !important;
        }
        
        /* Đảm bảo tab content có thể tương tác */
        .tab-content {
            position: relative;
            z-index: 1;
        }
        
        .tab-pane {
            position: relative;
            z-index: 1;
        }
        
        /* Đảm bảo input group có thể click */
        .input-group {
            position: relative;
            z-index: 10;
        }
        
        .input-group .form-control,
        .input-group .btn {
            position: relative;
            z-index: 11;
        }
        
        /* Modal center fix */
        .modal {
            display: flex !important;
            align-items: center;
            justify-content: center;
            padding: 0 !important;
        }
        .modal-dialog {
            margin: auto;
            max-width: 90%;
            width: auto;
        }
        .modal.show .modal-dialog {
            transform: none !important;
        }
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1040;
        }
        
        /* Đảm bảo modal không block interactions khi đóng */
        .modal:not(.show) {
            display: none !important;
        }
        
        /* Đảm bảo body không bị block khi không có modal */
        body:not(.modal-open) {
            overflow: auto !important;
        }
        
        /* Ensure modal is centered vertically */
        .modal.fade .modal-dialog {
            transition: transform 0.3s ease-out;
            transform: translate(0, -50px);
        }
        .modal.show .modal-dialog {
            transform: translate(0, 0);
        }
        
        /* Responsive for mobile */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
                margin-top: 15px;
                margin-bottom: 15px;
                border-radius: 10px;
            }
            .header h1 {
                font-size: 1.5rem;
            }
            .nav-tabs .nav-link {
                font-size: 0.9rem;
                padding: 8px 12px;
            }
            .license-card {
                padding: 15px;
            }
            .license-card .row > div {
                margin-bottom: 10px;
            }
            .action-btn {
                width: 35px;
                height: 35px;
                font-size: 0.9rem;
            }
            .tab-pane {
                padding: 15px;
            }
            .verify-url {
                font-size: 0.8rem;
                padding: 8px;
            }
            .modal-dialog {
                max-width: 95%;
                margin: 10px;
            }
            .modal-body {
                padding: 15px;
            }
            .btn {
                padding: 8px 16px;
                font-size: 0.9rem;
            }
        }
        
        @media (max-width: 576px) {
            .container {
                padding: 10px;
                margin: 10px;
            }
            .header h1 {
                font-size: 1.25rem;
            }
            .header p {
                font-size: 0.85rem;
            }
            .nav-tabs {
                flex-wrap: wrap;
            }
            .nav-tabs .nav-link {
                font-size: 0.8rem;
                padding: 6px 10px;
            }
            .license-card .row {
                margin: 0;
            }
            .license-card .col-md-3,
            .license-card .col-md-2 {
                margin-bottom: 15px;
            }
            .count-badge {
                font-size: 0.7rem;
                padding: 2px 6px;
            }
            .status-badge {
                font-size: 0.7rem;
                padding: 4px 10px;
            }
        }
        .header { border-bottom: 3px solid #f0f0f0; padding-bottom: 20px; margin-bottom: 30px; }
        .nav-tabs .nav-link.active { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; }
        .nav-tabs .nav-link { border: 1px solid #dee2e6; margin-right: 5px; border-radius: 5px 5px 0 0; }
        .tab-pane { padding: 25px; border: 1px solid #dee2e6; border-top: none; border-radius: 0 0 10px 10px; }
        .license-card { 
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s;
            position: relative;
            z-index: 1;
        }
        .license-card:hover { 
            transform: translateY(-3px); 
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
            z-index: 2;
        }
        .license-card .row {
            align-items: center;
            position: relative;
            z-index: 1;
        }
        .license-card .col-md-3,
        .license-card .col-md-2 {
            display: flex;
            align-items: center;
            min-height: 60px;
            position: relative;
            z-index: 1;
        }
        .license-card .action-btn {
            position: relative !important;
            z-index: 100 !important;
            pointer-events: auto !important;
            cursor: pointer !important;
        }
        
        /* Đảm bảo không có element nào che phủ */
        .license-card * {
            pointer-events: auto;
        }
        .license-key { 
            font-family: 'Courier New', monospace; 
            font-size: 1.1em; 
            font-weight: bold; 
            color: #2c3e50;
            background: #f8f9fa;
            padding: 5px 10px;
            border-radius: 5px;
            border-left: 4px solid #667eea;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: inline-block;
            max-width: 100%;
            min-width: 0;
            word-break: keep-all;
            cursor: pointer;
            transition: all 0.2s ease;
            user-select: none;
        }
        
        .license-key:hover {
            background: #e9ecef;
            border-left-color: #764ba2;
            transform: translateX(2px);
        }
        
        .license-key:active {
            background: #dee2e6;
            transform: translateX(0);
        }
        
        .license-key.copied {
            background: #d4edda;
            border-left-color: #28a745;
            color: #155724;
        }
        
        /* Checkbox styling */
        .license-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
            margin-right: 10px;
        }
        .status-badge {
            font-size: 0.75rem;
            padding: 5px 12px;
            border-radius: 20px;
            font-weight: 600;
        }
        .status-valid { background: linear-gradient(135deg, #4CAF50 0%, #2E7D32 100%); color: white; }
        .status-expiring { background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%); color: white; }
        .status-expired { background: linear-gradient(135deg, #F44336 0%, #C62828 100%); color: white; }
        .action-btn { width: 40px; height: 40px; border-radius: 50%; }
        .verify-url { 
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 10px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            word-break: break-all;
        }
        .qr-code { 
            background: white;
            padding: 10px;
            border-radius: 10px;
            display: inline-block;
            border: 1px solid #dee2e6;
        }
        .api-test-box { 
            background: #f8f9fa; 
            padding: 15px; 
            border-radius: 10px; 
            border-left: 4px solid #667eea;
        }
        .highlight { background-color: #fffacd; padding: 2px 5px; border-radius: 3px; }
        .copy-btn { cursor: pointer; transition: all 0.3s; }
        .copy-btn:hover { transform: scale(1.1); }
        .count-badge { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.8em;
        }
        .empty-state { 
            text-align: center; 
            padding: 50px 20px; 
            color: #6c757d;
            background: #f8f9fa;
            border-radius: 10px;
            border: 2px dashed #dee2e6;
        }
        .note-box {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="text-primary mb-2">
                        <i class="bi bi-shield-check"></i> License Manager Pro
                    </h1>
                    <p class="text-muted mb-0">Quản lý license với tính năng verify online từ bất kỳ ứng dụng nào</p>
                </div>
                <div class="col-md-4 text-end">
                    <div class="d-flex justify-content-end align-items-center gap-2">
                        <span id="totalLicenses" class="count-badge">0 license</span>
                        <button class="btn btn-success" onclick="showAddModal()">
                            <i class="bi bi-plus-lg"></i> Thêm License
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabs -->
        <ul class="nav nav-tabs" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="manage-tab" data-bs-toggle="tab" data-bs-target="#manage" type="button">
                    <i class="bi bi-list-check"></i> Quản lý License
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="verify-tab" data-bs-toggle="tab" data-bs-target="#verify" type="button">
                    <i class="bi bi-search"></i> Verify License
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="api-tab" data-bs-toggle="tab" data-bs-target="#api" type="button">
                    <i class="bi bi-code-slash"></i> API & Integration
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="docs-tab" data-bs-toggle="tab" data-bs-target="#docs" type="button">
                    <i class="bi bi-book"></i> Hướng dẫn API
                </button>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content" id="myTabContent">
            <!-- Tab 1: Quản lý License -->
            <div class="tab-pane fade show active" id="manage" role="tabpanel">
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="input-group">
                            <input type="text" class="form-control" id="searchInput" placeholder="Tìm kiếm license key..." 
                                   style="position: relative; z-index: 101; pointer-events: auto !important; cursor: text !important;"
                                   autocomplete="off">
                            <button class="btn btn-outline-secondary" type="button" onclick="clearSearch()"
                                    style="position: relative; z-index: 102; pointer-events: auto !important; cursor: pointer !important;">
                                <i class="bi bi-x"></i>
                            </button>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <select class="form-select" id="statusFilter" onchange="filterLicenses()">
                            <option value="all">Tất cả trạng thái</option>
                            <option value="valid">Còn hạn</option>
                            <option value="expiring">Sắp hết hạn (≤ 7 ngày)</option>
                            <option value="expired">Hết hạn</option>
                        </select>
                    </div>
                </div>

                <!-- Thống kê -->
                <div class="row mb-4">
                    <div class="col-md-4">
                        <div class="d-flex align-items-center p-3 bg-success bg-opacity-10 rounded">
                            <i class="bi bi-check-circle-fill text-success fs-4 me-3"></i>
                            <div>
                                <h5 class="mb-0" id="validCount">0</h5>
                                <small class="text-muted">Còn hạn</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="d-flex align-items-center p-3 bg-warning bg-opacity-10 rounded">
                            <i class="bi bi-exclamation-triangle-fill text-warning fs-4 me-3"></i>
                            <div>
                                <h5 class="mb-0" id="expiringCount">0</h5>
                                <small class="text-muted">Sắp hết hạn</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="d-flex align-items-center p-3 bg-danger bg-opacity-10 rounded">
                            <i class="bi bi-x-circle-fill text-danger fs-4 me-3"></i>
                            <div>
                                <h5 class="mb-0" id="expiredCount">0</h5>
                                <small class="text-muted">Hết hạn</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Bulk Actions -->
                <div class="row mb-3" id="bulkActionsContainer" style="display: none;">
                    <div class="col-12">
                        <div class="d-flex align-items-center gap-2 p-3 bg-light rounded border">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="selectAllCheckbox" 
                                       onchange="toggleSelectAll(this.checked)">
                                <label class="form-check-label" for="selectAllCheckbox">
                                    <strong>Chọn tất cả</strong>
                                </label>
                            </div>
                            <div class="ms-auto d-flex align-items-center gap-2">
                                <span id="selectedCount" class="text-muted">0 license đã chọn</span>
                                <button class="btn btn-danger btn-sm" onclick="bulkDeleteLicenses()">
                                    <i class="bi bi-trash me-1"></i> Xóa đã chọn
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Danh sách License -->
                <div id="licensesContainer">
                    <!-- License cards sẽ được thêm bằng JavaScript -->
                </div>

                <div id="emptyState" class="empty-state" style="display: none;">
                    <i class="bi bi-key fs-1 text-muted mb-3"></i>
                    <h4>Chưa có license nào</h4>
                    <p class="mb-4">Bắt đầu bằng cách thêm license đầu tiên của bạn</p>
                    <button class="btn btn-primary" onclick="showAddModal()">
                        <i class="bi bi-plus-lg"></i> Thêm License đầu tiên
                    </button>
                </div>

                <!-- Pagination -->
                <nav aria-label="License pagination" id="paginationContainer" style="display: none;">
                    <ul class="pagination justify-content-center mt-4" id="paginationList">
                        <!-- Pagination items sẽ được thêm bằng JavaScript -->
                    </ul>
                </nav>
            </div>

            <!-- Tab 2: Verify License -->
            <div class="tab-pane fade" id="verify" role="tabpanel">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-4">
                            <h4><i class="bi bi-search text-primary"></i> Verify License</h4>
                            <p class="text-muted">Nhập license key để kiểm tra trạng thái</p>
                            <div class="input-group mb-3">
                                <input type="text" class="form-control" id="verifyKeyInput" 
                                       placeholder="Nhập license key cần verify...">
                                <button class="btn btn-primary" onclick="verifyLicense()">
                                    <i class="bi bi-check-lg"></i> Verify
                                </button>
                            </div>
                            <div id="verifyResult"></div>
                        </div>

                        <div class="note-box">
                            <h6><i class="bi bi-lightbulb"></i> Cách sử dụng trong ứng dụng khác:</h6>
                            <p class="mb-2">Sử dụng URL sau trong ứng dụng của bạn để verify license:</p>
                            <div class="verify-url mb-2">
                                <code id="verifyUrl">https://your-domain.com/verify.html?key=LICENSE_KEY_HERE</code>
                            </div>
                            <small class="text-muted">Thay thế LICENSE_KEY_HERE bằng key thực tế</small>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="mb-4">
                            <h4><i class="bi bi-qr-code text-primary"></i> QR Code Generator</h4>
                            <p class="text-muted">Tạo QR code để verify nhanh từ điện thoại</p>
                            <div class="mb-3">
                                <input type="text" class="form-control" id="qrKeyInput" 
                                       placeholder="Nhập license key để tạo QR code">
                            </div>
                            <button class="btn btn-outline-primary mb-3" onclick="generateQRCode()">
                                <i class="bi bi-qr-code"></i> Tạo QR Code
                            </button>
                            <div id="qrCodeContainer" class="text-center"></div>
                        </div>

                        <div class="api-test-box">
                            <h6><i class="bi bi-terminal"></i> Test API Endpoint</h6>
                            <div class="mb-2">
                                <small class="text-muted">GET Request:</small>
                                <div class="verify-url">
                                    <code id="apiUrl">window.location.origin + window.location.pathname + "?verify=LICENSE_KEY"</code>
                                </div>
                            </div>
                            <button class="btn btn-sm btn-outline-success" onclick="testApi()">
                                <i class="bi bi-play-circle"></i> Test API Call
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab 3: API & Integration -->
            <div class="tab-pane fade" id="api" role="tabpanel">
                <div class="row">
                    <div class="col-md-6">
                        <h4><i class="bi bi-plug text-primary"></i> Integration Guide</h4>
                        
                        <div class="mb-4">
                            <h6>1. Verify trong Web App</h6>
                            <pre class="bg-light p-3 rounded"><code>// JavaScript
async function verifyLicense(key) {
    const url = `${window.location.origin}${window.location.pathname}?verify=${key}`;
    const response = await fetch(url);
    const result = await response.json();
    
    if (result.valid) {
        console.log('License hợp lệ đến:', result.expiry);
    } else {
        console.log('License không hợp lệ:', result.message);
    }
}</code></pre>
                        </div>

                        <div class="mb-4">
                            <h6>2. Verify trong Desktop/Mobile App</h6>
                            <pre class="bg-light p-3 rounded"><code>// Python
import requests
import json

def verify_license(key):
    # Lưu file HTML này trên server
    verify_url = "https://your-server.com/license-verify.html"
    response = requests.get(f"{verify_url}?verify={key}")
    data = json.loads(response.text)
    
    return data['valid'], data['message']</code></pre>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <h4><i class="bi bi-shield-check text-primary"></i> Live Verification</h4>
                        
                        <div class="mb-4">
                            <h6>License Verification Endpoint</h6>
                            <p class="text-muted">Endpoint này hoạt động từ bất kỳ domain nào</p>
                            <div class="verify-url mb-2">
                                <code id="liveEndpoint">Loading...</code>
                            </div>
                            <div class="d-flex gap-2">
                                <button class="btn btn-sm btn-outline-primary" onclick="copyEndpoint()">
                                    <i class="bi bi-copy"></i> Copy Endpoint
                                </button>
                                <button class="btn btn-sm btn-outline-success" onclick="refreshEndpoint()">
                                    <i class="bi bi-arrow-clockwise"></i> Refresh
                                </button>
                            </div>
                        </div>

                        <div class="mb-4">
                            <h6>Response Format</h6>
                            <pre class="bg-light p-3 rounded"><code>{
    "valid": true,
    "key": "LICENSE-123",
    "expiry": "2024-12-31T23:59:59",
    "status": "active",
    "message": "License hợp lệ",
    "days_remaining": 45,
    "timestamp": "2024-01-15T10:30:00"
}</code></pre>
                        </div>

                        <div class="note-box">
                            <h6><i class="bi bi-info-circle"></i> Lưu ý quan trọng:</h6>
                            <ul class="mb-0">
                                <li>Lưu file này trên web server để có thể truy cập từ bất kỳ đâu</li>
                                <li>Sử dụng HTTPS để bảo mật</li>
                                <li>Dữ liệu license được lưu trong localStorage của trình duyệt</li>
                                <li>Để đồng bộ nhiều thiết bị, cần lưu file trên server</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab 4: Hướng dẫn API -->
            <div class="tab-pane fade" id="docs" role="tabpanel">
                <div class="row">
                    <div class="col-12 mb-4">
                        <h3><i class="bi bi-book text-primary"></i> Hướng dẫn sử dụng API đầy đủ</h3>
                        <p class="text-muted">Tài liệu chi tiết về cách tích hợp License Verification API vào ứng dụng Python và Java</p>
                    </div>
                </div>

                <div class="row">
                    <!-- Python Section -->
                    <div class="col-md-6">
                        <div class="card mb-4">
                            <div class="card-header bg-primary text-white">
                                <h5 class="mb-0"><i class="bi bi-filetype-py"></i> Python Integration</h5>
                            </div>
                            <div class="card-body">
                                <h6 class="text-primary">1. Cài đặt thư viện</h6>
                                <pre class="bg-light p-3 rounded"><code># Sử dụng requests library
pip install requests

# Hoặc sử dụng urllib (built-in)
# Không cần cài đặt thêm</code></pre>

                                <h6 class="text-primary mt-4">2. Ví dụ cơ bản</h6>
                                <pre class="bg-light p-3 rounded"><code>import requests
import json
from datetime import datetime

def verify_license(license_key, api_url):
    """
    Verify license key từ API endpoint
    
    Args:
        license_key (str): License key cần verify
        api_url (str): URL của API endpoint
    
    Returns:
        dict: Kết quả verify với các trường:
            - valid (bool): License có hợp lệ không
            - status (str): Trạng thái ('active', 'expired', 'expiring')
            - expiry (str): Ngày hết hạn (ISO format)
            - days_remaining (int): Số ngày còn lại
            - message (str): Thông báo
    """
    try:
        # Tạo URL với format=json để đảm bảo nhận JSON response
        url = f"{api_url}?verify={license_key}&format=json"
        
        # Gửi GET request
        response = requests.get(url, timeout=10)
        response.raise_for_status()  # Ném exception nếu status code lỗi
        
        # Parse JSON response
        result = json.loads(response.text)
        
        return result
        
    except requests.exceptions.RequestException as e:
        return {
            'valid': False,
            'status': 'error',
            'message': f'Lỗi kết nối: {str(e)}'
        }
    except json.JSONDecodeError:
        return {
            'valid': False,
            'status': 'error',
            'message': 'Lỗi parse JSON response'
        }

# Sử dụng
api_endpoint = "https://management-license.vercel.app"
license_key = "LIC-W8B61JUL-F7OD"

result = verify_license(license_key, api_endpoint)

if result.get('valid'):
    print(f"✅ License hợp lệ!")
    print(f"   Hết hạn: {result.get('expiry')}")
    print(f"   Còn lại: {result.get('days_remaining')} ngày")
else:
    print(f"❌ License không hợp lệ: {result.get('message')}")</code></pre>

                                <h6 class="text-primary mt-4">3. Ví dụ với urllib (không cần thư viện ngoài)</h6>
                                <pre class="bg-light p-3 rounded"><code>import urllib.request
import json

def verify_license_urllib(license_key, api_url):
    """Verify license sử dụng urllib (built-in)"""
    try:
        url = f"{api_url}?verify={license_key}&format=json"
        
        with urllib.request.urlopen(url, timeout=10) as response:
            data = json.loads(response.read().decode())
            return data
            
    except Exception as e:
        return {
            'valid': False,
            'status': 'error',
            'message': f'Lỗi: {str(e)}'
        }

# Sử dụng
result = verify_license_urllib("LIC-W8B61JUL-F7OD", 
                                "https://management-license.vercel.app")
print(result)</code></pre>

                                <h6 class="text-primary mt-4">4. Class wrapper đầy đủ với error handling</h6>
                                <pre class="bg-light p-3 rounded"><code>import requests
import json
from datetime import datetime
from typing import Dict, Optional

class LicenseVerifier:
    """Class để verify license với các tính năng đầy đủ"""
    
    def __init__(self, api_url: str, timeout: int = 10):
        """
        Khởi tạo License Verifier
        
        Args:
            api_url: URL của API endpoint
            timeout: Timeout cho request (giây)
        """
        self.api_url = api_url.rstrip('/')
        self.timeout = timeout
    
    def verify(self, license_key: str) -> Dict:
        """
        Verify license key
        
        Args:
            license_key: License key cần verify
        
        Returns:
            dict: Kết quả verify
        """
        try:
            url = f"{self.api_url}?verify={license_key}&format=json"
            response = requests.get(url, timeout=self.timeout)
            response.raise_for_status()
            
            result = response.json()
            
            # Validate response structure
            if 'valid' not in result:
                return {
                    'valid': False,
                    'status': 'error',
                    'message': 'Response không hợp lệ'
                }
            
            return result
            
        except requests.exceptions.Timeout:
            return {
                'valid': False,
                'status': 'error',
                'message': 'Request timeout'
            }
        except requests.exceptions.ConnectionError:
            return {
                'valid': False,
                'status': 'error',
                'message': 'Không thể kết nối đến server'
            }
        except requests.exceptions.HTTPError as e:
            return {
                'valid': False,
                'status': 'error',
                'message': f'HTTP Error: {e.response.status_code}'
            }
        except Exception as e:
            return {
                'valid': False,
                'status': 'error',
                'message': f'Lỗi không xác định: {str(e)}'
            }
    
    def is_valid(self, license_key: str) -> bool:
        """Kiểm tra license có hợp lệ không"""
        result = self.verify(license_key)
        return result.get('valid', False)
    
    def get_days_remaining(self, license_key: str) -> Optional[int]:
        """Lấy số ngày còn lại của license"""
        result = self.verify(license_key)
        if result.get('valid'):
            return result.get('days_remaining')
        return None

# Sử dụng
verifier = LicenseVerifier("https://management-license.vercel.app")

# Verify license
result = verifier.verify("LIC-W8B61JUL-F7OD")
if result['valid']:
    print(f"License hợp lệ, còn {result['days_remaining']} ngày")
else:
    print(f"License không hợp lệ: {result['message']}")

# Hoặc dùng helper methods
if verifier.is_valid("LIC-W8B61JUL-F7OD"):
    days = verifier.get_days_remaining("LIC-W8B61JUL-F7OD")
    print(f"Còn {days} ngày")</code></pre>

                                <h6 class="text-primary mt-4">5. Ví dụ tích hợp vào Flask/Django</h6>
                                <pre class="bg-light p-3 rounded"><code># Flask Example
from flask import Flask, request, jsonify
from functools import wraps

app = Flask(__name__)
verifier = LicenseVerifier("https://management-license.vercel.app")

def require_valid_license(f):
    """Decorator để kiểm tra license trước khi cho phép truy cập"""
    @wraps(f)
    def decorated_function(*args, **kwargs):
        license_key = request.headers.get('X-License-Key') or \
                     request.args.get('license_key')
        
        if not license_key:
            return jsonify({'error': 'Thiếu license key'}), 401
        
        result = verifier.verify(license_key)
        if not result.get('valid'):
            return jsonify({
                'error': 'License không hợp lệ',
                'message': result.get('message')
            }), 403
        
        return f(*args, **kwargs)
    return decorated_function

@app.route('/api/protected')
@require_valid_license
def protected_endpoint():
    return jsonify({'message': 'Truy cập thành công!'})

# Django Example
from django.http import JsonResponse
from django.views.decorators.http import require_http_methods

verifier = LicenseVerifier("https://management-license.vercel.app")

@require_http_methods(["GET"])
def protected_view(request):
    license_key = request.GET.get('license_key') or \
                 request.headers.get('X-License-Key')
    
    if not license_key:
        return JsonResponse({'error': 'Thiếu license key'}, status=401)
    
    result = verifier.verify(license_key)
    if not result.get('valid'):
        return JsonResponse({
            'error': 'License không hợp lệ',
            'message': result.get('message')
        }, status=403)
    
    return JsonResponse({'message': 'Truy cập thành công!'})</code></pre>
                            </div>
                        </div>
                    </div>

                    <!-- Java Section -->
                    <div class="col-md-6">
                        <div class="card mb-4">
                            <div class="card-header bg-success text-white">
                                <h5 class="mb-0"><i class="bi bi-filetype-java"></i> Java Integration</h5>
                            </div>
                            <div class="card-body">
                                <h6 class="text-success">1. Thêm dependency (Maven)</h6>
                                <pre class="bg-light p-3 rounded"><code>&lt;!-- pom.xml --&gt;
&lt;dependencies&gt;
    &lt;!-- Apache HttpClient --&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.apache.httpcomponents&lt;/groupId&gt;
        &lt;artifactId&gt;httpclient&lt;/artifactId&gt;
        &lt;version&gt;4.5.14&lt;/version&gt;
    &lt;/dependency&gt;
    
    &lt;!-- Gson cho JSON parsing --&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;com.google.code.gson&lt;/groupId&gt;
        &lt;artifactId&gt;gson&lt;/artifactId&gt;
        &lt;version&gt;2.10.1&lt;/version&gt;
    &lt;/dependency&gt;
&lt;/dependencies&gt;</code></pre>

                                <h6 class="text-success mt-4">2. Ví dụ cơ bản với HttpClient</h6>
                                <pre class="bg-light p-3 rounded"><code>import org.apache.http.client.methods.CloseableHttpResponse;
import org.apache.http.client.methods.HttpGet;
import org.apache.http.impl.client.CloseableHttpClient;
import org.apache.http.impl.client.HttpClients;
import org.apache.http.util.EntityUtils;
import com.google.gson.Gson;
import com.google.gson.JsonObject;
import java.io.IOException;

public class LicenseVerifier {
    private static final String API_URL = 
        "https://management-license.vercel.app";
    private final Gson gson = new Gson();
    
    public LicenseResult verify(String licenseKey) {
        try {
            String url = API_URL + "?verify=" + licenseKey + "&format=json";
            
            CloseableHttpClient httpClient = HttpClients.createDefault();
            HttpGet request = new HttpGet(url);
            
            try (CloseableHttpResponse response = httpClient.execute(request)) {
                String jsonResponse = EntityUtils.toString(
                    response.getEntity()
                );
                
                JsonObject json = gson.fromJson(jsonResponse, JsonObject.class);
                
                return new LicenseResult(
                    json.get("valid").getAsBoolean(),
                    json.get("status").getAsString(),
                    json.get("expiry").getAsString(),
                    json.get("days_remaining").getAsInt(),
                    json.get("message").getAsString()
                );
            }
        } catch (IOException e) {
            return new LicenseResult(
                false, 
                "error", 
                null, 
                0, 
                "Lỗi kết nối: " + e.getMessage()
            );
        }
    }
    
    // Inner class để chứa kết quả
    public static class LicenseResult {
        private final boolean valid;
        private final String status;
        private final String expiry;
        private final int daysRemaining;
        private final String message;
        
        public LicenseResult(boolean valid, String status, String expiry,
                           int daysRemaining, String message) {
            this.valid = valid;
            this.status = status;
            this.expiry = expiry;
            this.daysRemaining = daysRemaining;
            this.message = message;
        }
        
        // Getters
        public boolean isValid() { return valid; }
        public String getStatus() { return status; }
        public String getExpiry() { return expiry; }
        public int getDaysRemaining() { return daysRemaining; }
        public String getMessage() { return message; }
    }
}

// Sử dụng
LicenseVerifier verifier = new LicenseVerifier();
LicenseVerifier.LicenseResult result = 
    verifier.verify("LIC-W8B61JUL-F7OD");

if (result.isValid()) {
    System.out.println("✅ License hợp lệ!");
    System.out.println("   Hết hạn: " + result.getExpiry());
    System.out.println("   Còn lại: " + result.getDaysRemaining() + " ngày");
} else {
    System.out.println("❌ License không hợp lệ: " + result.getMessage());
}</code></pre>

                                <h6 class="text-success mt-4">3. Sử dụng Java 11+ HttpClient (không cần dependency)</h6>
                                <pre class="bg-light p-3 rounded"><code>import java.net.URI;
import java.net.http.HttpClient;
import java.net.http.HttpRequest;
import java.net.http.HttpResponse;
import com.google.gson.Gson;
import com.google.gson.JsonObject;
import java.time.Duration;

public class LicenseVerifierJava11 {
    private static final String API_URL = 
        "https://management-license.vercel.app";
    private final HttpClient httpClient;
    private final Gson gson = new Gson();
    
    public LicenseVerifierJava11() {
        this.httpClient = HttpClient.newBuilder()
            .connectTimeout(Duration.ofSeconds(10))
            .build();
    }
    
    public LicenseResult verify(String licenseKey) {
        try {
            String url = API_URL + "?verify=" + licenseKey + "&format=json";
            
            HttpRequest request = HttpRequest.newBuilder()
                .uri(URI.create(url))
                .timeout(Duration.ofSeconds(10))
                .GET()
                .build();
            
            HttpResponse&lt;String&gt; response = httpClient.send(
                request, 
                HttpResponse.BodyHandlers.ofString()
            );
            
            if (response.statusCode() == 200) {
                JsonObject json = gson.fromJson(
                    response.body(), 
                    JsonObject.class
                );
                
                return new LicenseResult(
                    json.get("valid").getAsBoolean(),
                    json.get("status").getAsString(),
                    json.get("expiry").getAsString(),
                    json.get("days_remaining").getAsInt(),
                    json.get("message").getAsString()
                );
            } else {
                return new LicenseResult(
                    false, 
                    "error", 
                    null, 
                    0, 
                    "HTTP Error: " + response.statusCode()
                );
            }
        } catch (Exception e) {
            return new LicenseResult(
                false, 
                "error", 
                null, 
                0, 
                "Lỗi: " + e.getMessage()
            );
        }
    }
    
    // LicenseResult class giống như trên
}</code></pre>

                                <h6 class="text-success mt-4">4. Class wrapper đầy đủ với error handling</h6>
                                <pre class="bg-light p-3 rounded"><code>import org.apache.http.client.methods.CloseableHttpResponse;
import org.apache.http.client.methods.HttpGet;
import org.apache.http.client.config.RequestConfig;
import org.apache.http.impl.client.CloseableHttpClient;
import org.apache.http.impl.client.HttpClients;
import org.apache.http.util.EntityUtils;
import com.google.gson.Gson;
import com.google.gson.JsonObject;
import java.io.IOException;
import java.util.Optional;

public class LicenseVerifierAdvanced {
    private final String apiUrl;
    private final int timeoutSeconds;
    private final Gson gson = new Gson();
    
    public LicenseVerifierAdvanced(String apiUrl, int timeoutSeconds) {
        this.apiUrl = apiUrl;
        this.timeoutSeconds = timeoutSeconds;
    }
    
    public LicenseResult verify(String licenseKey) {
        try {
            String url = String.format(
                "%s?verify=%s&format=json", 
                apiUrl, 
                licenseKey
            );
            
            CloseableHttpClient httpClient = HttpClients.createDefault();
            HttpGet request = new HttpGet(url);
            
            // Set timeout
            RequestConfig config = RequestConfig.custom()
                .setConnectTimeout(timeoutSeconds * 1000)
                .setSocketTimeout(timeoutSeconds * 1000)
                .build();
            request.setConfig(config);
            
            try (CloseableHttpResponse response = httpClient.execute(request)) {
                int statusCode = response.getStatusLine().getStatusCode();
                
                if (statusCode != 200) {
                    return new LicenseResult(
                        false, 
                        "error", 
                        null, 
                        0, 
                        "HTTP Error: " + statusCode
                    );
                }
                
                String jsonResponse = EntityUtils.toString(
                    response.getEntity()
                );
                
                JsonObject json = gson.fromJson(jsonResponse, JsonObject.class);
                
                // Validate response
                if (!json.has("valid")) {
                    return new LicenseResult(
                        false, 
                        "error", 
                        null, 
                        0, 
                        "Response không hợp lệ"
                    );
                }
                
                return new LicenseResult(
                    json.get("valid").getAsBoolean(),
                    json.has("status") ? json.get("status").getAsString() : "unknown",
                    json.has("expiry") ? json.get("expiry").getAsString() : null,
                    json.has("days_remaining") ? json.get("days_remaining").getAsInt() : 0,
                    json.has("message") ? json.get("message").getAsString() : ""
                );
            }
        } catch (java.net.SocketTimeoutException e) {
            return new LicenseResult(
                false, 
                "error", 
                null, 
                0, 
                "Request timeout"
            );
        } catch (java.net.UnknownHostException e) {
            return new LicenseResult(
                false, 
                "error", 
                null, 
                0, 
                "Không thể kết nối đến server"
            );
        } catch (IOException e) {
            return new LicenseResult(
                false, 
                "error", 
                null, 
                0, 
                "Lỗi IO: " + e.getMessage()
            );
        } catch (Exception e) {
            return new LicenseResult(
                false, 
                "error", 
                null, 
                0, 
                "Lỗi không xác định: " + e.getMessage()
            );
        }
    }
    
    public boolean isValid(String licenseKey) {
        LicenseResult result = verify(licenseKey);
        return result.isValid();
    }
    
    public Optional&lt;Integer&gt; getDaysRemaining(String licenseKey) {
        LicenseResult result = verify(licenseKey);
        if (result.isValid()) {
            return Optional.of(result.getDaysRemaining());
        }
        return Optional.empty();
    }
}</code></pre>

                                <h6 class="text-success mt-4">5. Ví dụ tích hợp vào Spring Boot</h6>
                                <pre class="bg-light p-3 rounded"><code>// Spring Boot Controller
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.bind.annotation.RestController;

@RestController
@RequestMapping("/api")
public class LicenseController {
    
    @Autowired
    private LicenseVerifierAdvanced licenseVerifier;
    
    @GetMapping("/verify")
    public ResponseEntity&lt;LicenseResult&gt; verifyLicense(
            @RequestParam String licenseKey) {
        LicenseResult result = licenseVerifier.verify(licenseKey);
        
        if (result.isValid()) {
            return ResponseEntity.ok(result);
        } else {
            return ResponseEntity.status(HttpStatus.FORBIDDEN).body(result);
        }
    }
}

// Spring Boot Service
import org.springframework.stereotype.Service;

@Service
public class LicenseService {
    
    private final LicenseVerifierAdvanced verifier;
    
    public LicenseService() {
        this.verifier = new LicenseVerifierAdvanced(
            "https://management-license.vercel.app", 
            10
        );
    }
    
    public boolean checkLicense(String licenseKey) {
        return verifier.isValid(licenseKey);
    }
    
    public void validateLicense(String licenseKey) {
        LicenseResult result = verifier.verify(licenseKey);
        if (!result.isValid()) {
            throw new LicenseException(
                "License không hợp lệ: " + result.getMessage()
            );
        }
    }
}

// Custom Exception
public class LicenseException extends RuntimeException {
    public LicenseException(String message) {
        super(message);
    }
}

// Interceptor để kiểm tra license tự động
import org.springframework.web.servlet.HandlerInterceptor;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

@Component
public class LicenseInterceptor implements HandlerInterceptor {
    
    @Autowired
    private LicenseService licenseService;
    
    @Override
    public boolean preHandle(HttpServletRequest request, 
                           HttpServletResponse response, 
                           Object handler) throws Exception {
        String licenseKey = request.getHeader("X-License-Key") != null ?
            request.getHeader("X-License-Key") :
            request.getParameter("license_key");
        
        if (licenseKey == null || !licenseService.checkLicense(licenseKey)) {
            response.setStatus(HttpStatus.FORBIDDEN.value());
            response.getWriter().write("License không hợp lệ");
            return false;
        }
        
        return true;
    }
}</code></pre>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Best Practices Section -->
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header bg-info text-white">
                                <h5 class="mb-0"><i class="bi bi-lightbulb"></i> Best Practices & Lưu ý</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6 class="text-info">✅ Nên làm:</h6>
                                        <ul>
                                            <li>Luôn sử dụng <code>format=json</code> trong URL để đảm bảo nhận JSON response</li>
                                            <li>Xử lý timeout và error handling đầy đủ</li>
                                            <li>Cache kết quả verify trong thời gian ngắn (5-10 phút) để giảm số lượng request</li>
                                            <li>Sử dụng HTTPS để bảo mật</li>
                                            <li>Validate response structure trước khi sử dụng</li>
                                            <li>Log các lỗi để debug dễ dàng</li>
                                            <li>Kiểm tra <code>days_remaining</code> để cảnh báo sớm khi license sắp hết hạn</li>
                                        </ul>
                                    </div>
                                    <div class="col-md-6">
                                        <h6 class="text-danger">❌ Không nên:</h6>
                                        <ul>
                                            <li>Không verify license mỗi request (quá tốn tài nguyên)</li>
                                            <li>Không hardcode API URL trong code (dùng config file)</li>
                                            <li>Không bỏ qua error handling</li>
                                            <li>Không gửi license key trong URL query nếu có thể (dùng header)</li>
                                            <li>Không cache quá lâu (license có thể bị thay đổi)</li>
                                            <li>Không trust response mà không validate</li>
                                        </ul>
                                    </div>
                                </div>

                                <div class="mt-4">
                                    <h6 class="text-warning">⚠️ Response Format:</h6>
                                    <pre class="bg-light p-3 rounded"><code>{
    "valid": true/false,           // License có hợp lệ không
    "key": "LIC-W8B61JUL-F7OD",   // License key
    "expiry": "2024-12-31T23:59:59.000Z",  // Ngày hết hạn (ISO 8601)
    "status": "active|expired|expiring",    // Trạng thái
    "message": "License hợp lệ",           // Thông báo
    "days_remaining": 45,                  // Số ngày còn lại (có thể âm nếu hết hạn)
    "note": "Ghi chú",                     // Ghi chú (nếu có)
    "timestamp": "2024-01-15T10:30:00.000Z" // Thời gian verify
}</code></pre>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal thêm/sửa license -->
    <div class="modal fade" id="licenseModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">Thêm License Mới</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="licenseForm" onsubmit="return saveLicense()">
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">License Key *</label>
                                    <input type="text" class="form-control" id="licenseKey" required
                                           placeholder="VD: PRO-2024-ABC123-XYZ789"
                                           pattern="[A-Z0-9\-]{10,50}"
                                           title="Chỉ chấp nhận chữ hoa, số và dấu gạch ngang">
                                    <div class="form-text">Sử dụng định dạng dễ nhận biết cho verify</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Thời gian hết hạn *</label>
                                    <input type="datetime-local" class="form-control" id="expiryDate" required>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-12">
                                <div class="mb-3">
                                    <label class="form-label">Thông tin thêm (optional)</label>
                                    <input type="text" class="form-control" id="licenseNote"
                                           placeholder="Ghi chú, tên khách hàng, sản phẩm...">
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-12">
                                <div class="mb-3">
                                    <label class="form-label">Thêm nhanh (từ hôm nay)</label>
                                    <div class="d-flex gap-2 flex-wrap">
                                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="addDays(7)">
                                            7 ngày
                                        </button>
                                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="addDays(14)">
                                            14 ngày
                                        </button>
                                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="addDays(30)">
                                            30 ngày
                                        </button>
                                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="addDays(60)">
                                            60 ngày
                                        </button>
                                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="addDays(90)">
                                            90 ngày
                                        </button>
                                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="addDays(180)">
                                            180 ngày
                                        </button>
                                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="addDays(365)">
                                            1 năm
                                        </button>
                                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="addDays(730)">
                                            2 năm
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Tùy chỉnh số ngày</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" id="customDaysInput" 
                                               placeholder="Nhập số ngày" min="1" max="3650">
                                        <button type="button" class="btn btn-outline-primary" onclick="addCustomDays()">
                                            <i class="bi bi-check"></i> Áp dụng
                                        </button>
                                    </div>
                                    <div class="form-check mt-2">
                                        <input class="form-check-input" type="checkbox" id="addToCurrentDate" 
                                               onchange="updateCustomDaysLabel()">
                                        <label class="form-check-label" for="addToCurrentDate">
                                            Cộng thêm vào ngày đã chọn (thay vì tính từ hôm nay)
                                        </label>
                                    </div>
                                    <small class="text-muted" id="customDaysHelp">Nhập số ngày từ hôm nay (1-3650 ngày)</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Actions</label>
                                    <div class="d-flex gap-2">
                                        <button type="button" class="btn btn-outline-secondary flex-fill" onclick="generateRandomKey()">
                                            <i class="bi bi-shuffle"></i> Random
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary flex-fill" onclick="setNow()">
                                            <i class="bi bi-clock"></i> Hết hạn
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="alert alert-info" id="previewSection" style="display: none;">
                            <h6><i class="bi bi-eye"></i> Preview</h6>
                            <div id="previewContent"></div>
                        </div>

                        <div class="alert alert-warning">
                            <h6><i class="bi bi-exclamation-triangle"></i> Lưu ý quan trọng:</h6>
                            <ul class="mb-0 small">
                                <li>License key sẽ được sử dụng để verify từ các ứng dụng khác</li>
                                <li>Lưu file này lên web server để có thể verify online</li>
                                <li>Dữ liệu được lưu trong trình duyệt hiện tại</li>
                            </ul>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                        <button type="submit" class="btn btn-primary" id="modalSaveBtn">Thêm License</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <!-- QRCode.js với fallback -->
    <script>
        // Fallback nếu CDN không load được - Định nghĩa TRƯỚC khi sử dụng
        // Phải định nghĩa trong window để có thể gọi từ onerror attribute
        window.loadQRCodeFallback = function() {
            console.warn('QRCode CDN failed, trying alternative...');
            if (window.QRCodeLoadFailed) {
                console.error('All QRCode CDN sources already failed, skipping retry');
                return;
            }
            const script = document.createElement('script');
            script.src = 'https://unpkg.com/qrcode@1.5.3/build/qrcode.min.js';
            script.onerror = function() {
                console.error('All QRCode CDN sources failed');
                window.QRCodeLoadFailed = true;
            };
            script.onload = function() {
                console.log('QRCode loaded from fallback CDN');
                window.QRCodeLoaded = true;
            };
            document.head.appendChild(script);
        };
        // Cũng định nghĩa global function để tương thích
        var loadQRCodeFallback = window.loadQRCodeFallback;
    </script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js" 
            onerror="if(typeof loadQRCodeFallback !== 'undefined') loadQRCodeFallback(); else if(typeof window.loadQRCodeFallback !== 'undefined') window.loadQRCodeFallback();"></script>
    <script>
        
        // Kiểm tra QRCode đã load chưa sau khi page load
        window.addEventListener('load', function() {
            if (typeof QRCode !== 'undefined') {
                window.QRCodeLoaded = true;
                console.log('QRCode library loaded successfully');
            } else {
                console.warn('QRCode library not loaded, will retry...');
                // Retry sau 1 giây
                setTimeout(function() {
                    if (typeof QRCode === 'undefined' && !window.QRCodeLoadFailed) {
                        loadQRCodeFallback();
                    }
                }, 1000);
            }
        });
    </script>

    <script>
        // Biến toàn cục
        let licenses = [];
        // Snapshot để phát hiện thay đổi localStorage mà không cần reload trang
        let lastLicensesSnapshot = null;
        let currentEditKey = null;
        const STORAGE_KEY = 'licenseManagerData';
        
        // Pagination
        let currentPage = 1;
        const itemsPerPage = 3;
        let filteredLicensesForPagination = [];

        // Hàm escape HTML để tránh XSS
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Kiểm tra xem có phải API request không (từ fetch/XMLHttpRequest)
        function isApiRequest() {
            // Kiểm tra Accept header hoặc User-Agent
            const acceptHeader = navigator.userAgent.includes('fetch') || 
                                navigator.userAgent.includes('XMLHttpRequest');
            // Hoặc kiểm tra nếu có header Accept: application/json trong request
            // (không thể check trực tiếp từ client, nhưng có thể dựa vào context)
            return false; // Mặc định là false, sẽ được override nếu cần
        }

        // Xử lý API verify request TRƯỚC khi DOM load
        (function() {
            const urlParams = new URLSearchParams(window.location.search);
            const verifyKey = urlParams.get('verify');
            
            // Nếu có ?verify= và request có vẻ là API call (không có hash, không có tab)
            // Hoặc có thể check Accept header nếu có cách
            if (verifyKey) {
                // Load licenses từ localStorage trước
                try {
                    const data = localStorage.getItem(STORAGE_KEY);
                    if (data) {
                        licenses = JSON.parse(data);
                    }
                } catch (e) {
                    console.error('Error loading licenses:', e);
                }

                // Gọi API function
                const license = licenses.find(l => l.key === verifyKey.toUpperCase());
                const now = new Date();
                
                let result;
                if (!license) {
                    result = {
                        valid: false,
                        key: verifyKey,
                        status: 'expired',
                        message: 'License không tồn tại',
                        days_remaining: 0,
                        timestamp: now.toISOString()
                    };
                } else {
                    const expiry = new Date(license.expiry);
                    const diffTime = expiry - now;
                    // Dùng Math.floor để tính chính xác số ngày (có thể âm nếu đã hết hạn)
                    const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                    
                    let status, valid;
                    // Nếu days_remaining <= 0 (số âm hoặc 0) thì key hết hạn
                    if (diffDays <= 0 || diffTime <= 0) {
                        status = 'expired';
                        valid = false;
                    } else if (diffDays <= 7) {
                        status = 'expiring';
                        valid = true;
                    } else {
                        status = 'valid';
                        valid = true;
                    }
                    
                    result = {
                        valid: valid,
                        key: license.key,
                        expiry: license.expiry,
                        status: status,
                        message: valid ? 
                            (status === 'expiring' ? 'License sắp hết hạn' : 'License hợp lệ') : 
                            'License đã hết hạn',
                        days_remaining: diffDays,
                        note: license.note || '',
                        timestamp: now.toISOString()
                    };
                }

                // Kiểm tra nếu request có format=json hoặc chỉ có ?verify= (API call từ app.py)
                const format = urlParams.get('format');
                const hasHash = window.location.hash && window.location.hash.length > 1;
                const hasOtherParams = Array.from(urlParams.keys()).some(k => k !== 'verify' && k !== 'format');
                
                // Luôn trả JSON nếu:
                // 1. Có format=json
                // 2. Chỉ có ?verify= và không có hash, không có params khác (API request)
                const isJsonRequest = format === 'json' || 
                                     window.location.search.includes('format=json') ||
                                     (verifyKey && !hasHash && !hasOtherParams); // Chỉ có ?verify= -> API request

                // Nếu là JSON request, trả về JSON ngay và dừng
                if (isJsonRequest) {
                    // Đảm bảo status format đúng với app.py mong đợi
                    // app.py kiểm tra: status in ("active", "đang hoạt động", "") thì hợp lệ
                    // Status "expired" hoặc khác sẽ bị reject
                    if (result.valid && result.status !== 'expired') {
                        // License hợp lệ (kể cả sắp hết hạn) -> status = "active" để app.py chấp nhận
                        result.status = 'active';
                    }
                    // Nếu expired thì giữ nguyên status = 'expired'
                    
                    // Trả về JSON thuần - xóa toàn bộ document và chỉ trả JSON
                    // Đảm bảo không có HTML tags nào trong response
                    document.documentElement.innerHTML = '';
                    document.documentElement.textContent = JSON.stringify(result, null, 2);
                    // Dừng mọi script khác
                    if (window.stop) window.stop();
                    return; // Dừng execution
                }
                // Nếu không phải JSON request, tiếp tục load UI bình thường
            }
        })();

        // Khởi tạo khi trang được tải (chỉ chạy nếu không phải API request)
        document.addEventListener('DOMContentLoaded', function() {
            // Kiểm tra xem đã trả về JSON chưa (nếu có thì không chạy tiếp)
            if (document.body.innerHTML.trim() === '' || document.body.innerHTML.match(/^\s*\{/)) {
                return;
            }

            try {
                // Load licenses từ server trước (async)
                loadLicenses().then(() => {
                    renderLicenses();
                    updateStats();
                    updateLiveEndpoint();
                }).catch((e) => {
                    console.error('[INIT] Error loading licenses:', e);
                    // Vẫn render với dữ liệu rỗng nếu load thất bại
                    renderLicenses();
                    updateStats();
                    updateLiveEndpoint();
                });
                
                // Lắng nghe thay đổi localStorage từ tab khác
                window.addEventListener('storage', refreshLicensesIfChanged);
                
                // Interval để phát hiện thay đổi localStorage trong cùng tab và reload từ GitHub
                // Lưu interval ID để có thể cleanup khi cần
                // Giảm xuống 1 giây để đồng bộ realtime nhanh hơn giữa các thiết bị
                const refreshIntervalId = setInterval(refreshLicensesIfChanged, 1000);
                
                // Reload ngay khi tab/window trở nên visible (user quay lại tab)
                document.addEventListener('visibilitychange', function() {
                    if (!document.hidden) {
                        console.log('[VISIBILITY] Tab became visible, reloading from GitHub...');
                        // Reset lastGitHubRefresh để force reload ngay
                        lastGitHubRefresh = 0;
                        refreshLicensesIfChanged();
                    }
                });
                
                // Reload ngay khi window focus (user quay lại window)
                window.addEventListener('focus', function() {
                    console.log('[FOCUS] Window focused, reloading from GitHub...');
                    // Reset lastGitHubRefresh để force reload ngay
                    lastGitHubRefresh = 0;
                    refreshLicensesIfChanged();
                });
                
                // Cleanup interval khi page unload
                window.addEventListener('beforeunload', function() {
                    if (refreshIntervalId) {
                        clearInterval(refreshIntervalId);
                    }
                });
                
                // Xử lý verify từ URL (chỉ hiển thị UI, không trả JSON)
                handleUrlVerification();
                
                // Cleanup countdowns khi page unload
                window.addEventListener('beforeunload', function() {
                    stopAllCountdowns();
                });
                
                // Thêm event listeners với error handling
                const expiryDateEl = document.getElementById('expiryDate');
                const licenseKeyEl = document.getElementById('licenseKey');
                
                if (expiryDateEl) {
                    expiryDateEl.addEventListener('change', updatePreview);
                }
                if (licenseKeyEl) {
                    licenseKeyEl.addEventListener('input', updatePreview);
                }

                // Thêm event listener cho search input
                const searchInput = document.getElementById('searchInput');
                if (searchInput) {
                    searchInput.addEventListener('input', filterLicenses);
                    searchInput.addEventListener('keypress', function(e) {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            filterLicenses();
                        }
                    });
                }
            } catch (e) {
                console.error('Error initializing app:', e);
            }
        });

        // Xử lý verify từ URL parameters (chỉ cho UI)
        function handleUrlVerification() {
            const urlParams = new URLSearchParams(window.location.search);
            const verifyKey = urlParams.get('verify');
            const format = urlParams.get('format');
            
            // Chỉ xử lý UI nếu không phải JSON request
            if (verifyKey && format !== 'json') {
                try {
                    // Chuyển sang tab verify
                    const verifyTabEl = document.getElementById('verify-tab');
                    if (verifyTabEl) {
                        const verifyTab = new bootstrap.Tab(verifyTabEl);
                        verifyTab.show();
                    }
                    
                    // Điền key và verify
                    const verifyKeyInput = document.getElementById('verifyKeyInput');
                    if (verifyKeyInput) {
                        verifyKeyInput.value = verifyKey;
                        setTimeout(() => {
                            try {
                                verifyLicense();
                            } catch (e) {
                                console.error('Error verifying license:', e);
                            }
                        }, 500);
                    }
                    
                    // Xóa param để tránh verify lại khi refresh
                    const newUrl = window.location.pathname;
                    window.history.replaceState({}, document.title, newUrl);
                } catch (e) {
                    console.error('Error handling URL verification:', e);
                }
            }
        }

        // Tạo key ngẫu nhiên
        function generateRandomKey() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let key = 'LIC-';
            for (let i = 0; i < 8; i++) {
                key += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            key += '-';
            for (let i = 0; i < 4; i++) {
                key += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            document.getElementById('licenseKey').value = key;
            updatePreview();
        }

        // Lưu dữ liệu
        // Sync licenses lên server (optional - để API endpoint có thể đọc)
        async function syncLicensesToServer() {
            try {
                const response = await fetch(`${window.location.origin}/api/sync`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ licenses: licenses })
                });
                const result = await response.json();
                console.log('[SYNC] Full response:', result);
                
                // Xử lý race condition (concurrent update)
                if (result.retry && result.error === 'Concurrent update detected') {
                    console.warn('[SYNC] Race condition detected, reloading and retrying...');
                    // Reload dữ liệu mới nhất từ server trước khi retry
                    try {
                        await loadLicenses();
                        // Retry sync với dữ liệu mới nhất
                        const retryResponse = await fetch(`${window.location.origin}/api/sync`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ licenses: licenses })
                        });
                        const retryResult = await retryResponse.json();
                        if (retryResult.success) {
                            showToast('✅ Đã đồng bộ thành công sau khi reload dữ liệu mới nhất!', 'success', 5000);
                            console.log('[SYNC] Retry successful after reload');
                        } else {
                            showToast('⚠️ Vẫn có conflict sau khi reload. Vui lòng thử lại sau vài giây.', 'warning', 8000);
                        }
                        return; // Không tiếp tục logic bên dưới
                    } catch (retryError) {
                        console.error('[SYNC] Error during retry:', retryError);
                        showToast('⚠️ Có conflict khi sync. Vui lòng reload trang và thử lại.', 'warning', 8000);
                        return;
                    }
                }
                
                if (result.success) {
                    const syncedToKV = result.message && result.message.includes('Vercel KV');
                    const committedToGit = result.commit && result.commit.sha;
                    if (!syncedToKV && !committedToGit) {
                        // Không lưu được lên server/GitHub -> cảnh báo để biết dữ liệu chỉ ở local
                        showToast('⚠️ Sync chưa lưu lên server. Dữ liệu chỉ tồn tại trên thiết bị này. Vui lòng kiểm tra cấu hình GITHUB_TOKEN/Vercel KV.', 'warning', 8000);
                    } else if (committedToGit) {
                        // Nếu commit thành công lên GitHub, reload ngay và retry nếu cần
                        console.log('[SYNC] GitHub commit successful, will reload from GitHub...');
                        
                        // Hàm reload với retry logic
                        const reloadWithRetry = async (attempt = 1, maxAttempts = 3) => {
                            // Tránh reload nếu đang có reload khác đang chạy
                            if (isLoadingFromGitHub) {
                                console.log('[SYNC] Skipping reload, another reload is in progress');
                                return;
                            }
                            
                            try {
                                isLoadingFromGitHub = true;
                                
                                // Thêm delay tăng dần: attempt 1 = 2s (đợi GitHub cập nhật), attempt 2 = 3s, attempt 3 = 4s
                                const delay = (attempt + 1) * 1000; // 2s, 3s, 4s
                                console.log(`[SYNC] Waiting ${delay}ms for GitHub to update (attempt ${attempt})...`);
                                await new Promise(resolve => setTimeout(resolve, delay));
                                
                                // Reset cache-busting để force reload dữ liệu mới
                                lastServerDataHash = null;
                                await loadLicenses();
                                renderLicenses();
                                updateStats();
                                // Cập nhật lastGitHubRefresh để tránh reload lại ngay
                                lastGitHubRefresh = Date.now();
                                console.log(`[SYNC] UI refreshed from GitHub after sync (attempt ${attempt})`);
                                
                                // Nếu đây là attempt đầu tiên và dữ liệu có thể chưa cập nhật, retry thêm 1 lần nữa sau 3 giây
                                if (attempt === 1 && maxAttempts > 1) {
                                    setTimeout(() => reloadWithRetry(2, maxAttempts), 3000);
                                }
                            } catch (e) {
                                console.error(`[SYNC] Error reloading from GitHub (attempt ${attempt}):`, e);
                                // Retry nếu chưa đạt max attempts
                                if (attempt < maxAttempts) {
                                    setTimeout(() => reloadWithRetry(attempt + 1, maxAttempts), delay);
                                }
                            } finally {
                                if (attempt >= maxAttempts) {
                                    isLoadingFromGitHub = false;
                                }
                            }
                        };
                        
                        // Bắt đầu reload ngay lập tức (không đợi)
                        reloadWithRetry(1, 3);
                    }
                    console.log('[SYNC] Sync success:', result);
                } else {
                    // Nếu sync fail
                    const errorMsg = result.error || result.message || 'Unknown error';
                    showToast(`❌ Sync thất bại: ${errorMsg}. Vui lòng kiểm tra console để biết chi tiết.`, 'error', 8000);
                    console.error('[SYNC] Sync failed:', result);
                }
            } catch (e) {
                // Không báo lỗi nếu sync fail (có thể chưa có API endpoint)
                showToast('⚠️ Không thể sync lên server. Dữ liệu chỉ ở thiết bị này (offline?).', 'warning', 6000);
                console.log('[SYNC] Sync to server skipped (optional):', e.message);
            }
        }


        // Hàm lưu và sync licenses
        // QUAN TRỌNG: Hàm này được gọi sau MỌI thay đổi license (thêm, sửa, xóa)
        // Đảm bảo dữ liệu luôn được sync lên server (Vercel KV hoặc file JSON)
        // ƯU TIÊN SERVER - Không cache localStorage, luôn reload từ server sau khi sync
        async function saveLicenses() {
            try {
                const licensesJson = JSON.stringify(licenses);
                
                // BƯỚC 1: Sync lên server TRƯỚC (ưu tiên server, không cache)
                // Mọi thay đổi license (thêm, sửa, xóa) đều phải sync để tự động commit lên GitHub
                try {
                    await syncLicensesToServer();
                    console.log('[SAVE] ✅ Sync to server successful, will reload from server');
                    
                    // Sau khi sync thành công, KHÔNG lưu vào localStorage ngay
                    // Đợi reload từ server để đảm bảo dữ liệu đồng bộ
                    // localStorage sẽ được cập nhật sau khi reload từ server trong loadLicenses()
                    
                    // Force reload từ server ngay sau khi sync (không đợi interval)
                    lastGitHubRefresh = 0; // Force reload
                    lastServerDataHash = null; // Reset hash để force reload
                    await loadLicenses();
                    renderLicenses();
                    updateStats();
                    lastLicensesSnapshot = JSON.stringify(licenses);
                    
                } catch (error) {
                    console.error('[SAVE] Lỗi khi sync lên server:', error);
                    showToast('❌ Sync tự động thất bại. Vui lòng kiểm tra cấu hình GITHUB_TOKEN trong Vercel hoặc xem console để biết chi tiết.', 'error', 8000);
                    
                    // Chỉ lưu vào localStorage nếu sync thất bại (fallback)
                    try {
                        localStorage.setItem(STORAGE_KEY, licensesJson);
                        lastLicensesSnapshot = licensesJson;
                        console.log('[SAVE] ⚠️ Sync failed, saved to localStorage as fallback');
                    } catch (storageError) {
                        if (storageError.name === 'QuotaExceededError' || storageError.code === 22) {
                            console.error('[SAVE] LocalStorage quota exceeded:', storageError);
                            showToast('⚠️ Dữ liệu quá lớn và sync thất bại. Vui lòng thử lại.', 'warning', 8000);
                        } else {
                            throw storageError;
                        }
                    }
                }
            } catch (e) {
                console.error('Error saving licenses:', e);
                showModalAlert('Không thể lưu dữ liệu. Vui lòng kiểm tra cài đặt trình duyệt.', 'Lỗi', 'error');
            }
        }

        // Tải dữ liệu từ server (API endpoint) hoặc localStorage
        async function loadLicenses() {
            // ⚠️ QUAN TRỌNG: Luôn dùng API endpoint /api/licenses, KHÔNG dùng GitHub raw URL trực tiếp
            // Ưu tiên load từ API endpoint (proxy) để tránh CORS và đồng bộ giữa các thiết bị
            let serverLicenses = [];
            try {
                // Cache-busting cực mạnh để ĐẢM BẢO KHÔNG CACHE - Luôn lấy dữ liệu mới nhất từ server
                // Sử dụng timestamp + performance.now() + random + Math.random() để mỗi request đều unique
                const timestamp = Date.now();
                const performanceTime = performance.now();
                const random1 = Math.random().toString(36).substring(7);
                const random2 = Math.random().toString(36).substring(2, 9);
                const userAgentHash = navigator.userAgent ? btoa(navigator.userAgent).substring(0, 8) : 'web';
                const sessionId = sessionStorage.getItem('sessionId') || Math.random().toString(36).substring(2, 15);
                if (!sessionStorage.getItem('sessionId')) {
                    sessionStorage.setItem('sessionId', sessionId);
                }
                // Tạo cache-buster cực mạnh với nhiều tham số để đảm bảo không cache
                const cacheBuster = `_t=${timestamp}&_p=${Math.floor(performanceTime)}&_r1=${random1}&_r2=${random2}&_u=${userAgentHash}&_s=${sessionId}&_nocache=${Date.now()}`;
                // ⚠️ QUAN TRỌNG: Sử dụng API endpoint /api/licenses, KHÔNG dùng GitHub raw URL trực tiếp
                // GitHub raw URL sẽ bị CORS block, phải dùng API endpoint này
                const apiUrl = `${window.location.origin}/api/licenses?${cacheBuster}`;
                
                // Kiểm tra nếu URL có chứa raw.githubusercontent.com thì báo lỗi và dừng
                if (apiUrl.includes('raw.githubusercontent.com')) {
                    console.error('[LOAD] ❌ CRITICAL ERROR: Code đang dùng GitHub raw URL! Phải dùng /api/licenses');
                    console.error('[LOAD] ❌ Vui lòng hard refresh (Ctrl+Shift+R) để load code mới');
                    throw new Error('Invalid URL: Should use /api/licenses endpoint. Please hard refresh browser.');
                }
                
                // Đảm bảo URL đúng format
                if (!apiUrl.includes('/api/licenses')) {
                    console.error('[LOAD] ❌ ERROR: URL không đúng format! Phải chứa /api/licenses');
                    throw new Error('Invalid API URL format');
                }
                
                console.log(`[LOAD] 🔄 Loading from API endpoint (NO CACHE): ${apiUrl.substring(0, 100)}...`);
                
                // Thêm timeout để tránh treo quá lâu
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 giây timeout
                
                try {
                    // Sử dụng API endpoint - không có CORS issue
                    // Force no-cache với nhiều headers và options
                    const response = await fetch(apiUrl, {
                        method: 'GET',
                        cache: 'no-store', // Không cache
                        signal: controller.signal,
                        headers: {
                            'Cache-Control': 'no-cache, no-store, must-revalidate',
                            'Pragma': 'no-cache',
                            'Expires': '0'
                        }
                    });
                    clearTimeout(timeoutId);
                    
                    if (response.ok) {
                        try {
                            const json = await response.json();
                            if (Array.isArray(json)) {
                                // Tính hash của dữ liệu để phát hiện thay đổi
                                // Sử dụng simple hash function hỗ trợ Unicode thay vì btoa()
                                const dataString = JSON.stringify(json);
                                let hash = 0;
                                for (let i = 0; i < dataString.length; i++) {
                                    const char = dataString.charCodeAt(i);
                                    hash = ((hash << 5) - hash) + char;
                                    hash = hash & hash; // Convert to 32bit integer
                                }
                                const dataHash = Math.abs(hash).toString(36).substring(0, 16); // Hash ngắn để so sánh
                                
                                // Chỉ log khi có thay đổi thực sự
                                if (lastServerDataHash !== null && lastServerDataHash !== dataHash) {
                                    console.log('[LOAD] ⚡ Data changed on server! Old hash:', lastServerDataHash.substring(0, 8), 'New hash:', dataHash.substring(0, 8));
                                }
                                
                                serverLicenses = json;
                                lastServerDataHash = dataHash;
                                console.log('[LOAD] Loaded licenses from API:', serverLicenses.length);
                            } else {
                                console.warn('[LOAD] API response is not an array:', typeof json);
                            }
                        } catch (parseError) {
                            console.error('[LOAD] Error parsing JSON from API:', parseError);
                            // Tiếp tục với dữ liệu rỗng, sẽ dùng localStorage
                        }
                    } else if (response.status === 429) {
                        // Rate limit exceeded
                        console.warn('[LOAD] API rate limit exceeded (429)');
                        const retryAfter = response.headers.get('Retry-After');
                        if (retryAfter) {
                            console.warn(`[LOAD] Retry after ${retryAfter} seconds`);
                        }
                        // Tiếp tục với localStorage, không báo lỗi vì có thể retry sau
                    } else {
                        console.warn(`[LOAD] API response status: ${response.status}`);
                    }
                } catch (fetchError) {
                    clearTimeout(timeoutId);
                    if (fetchError.name === 'AbortError') {
                        console.warn('[LOAD] API fetch timeout after 10 seconds');
                    } else {
                        throw fetchError;
                    }
                }
            } catch (e) {
                // Kiểm tra nếu lỗi do dùng GitHub raw URL (code cũ)
                if (e.message && (e.message.includes('raw.githubusercontent.com') || e.message.includes('Invalid URL'))) {
                    console.error('[LOAD] ❌ CRITICAL: Code cũ đang chạy! Vui lòng hard refresh (Ctrl+Shift+R)');
                    console.error('[LOAD] ❌ Browser đang cache file cũ. Hãy xóa cache và reload.');
                    showToast('⚠️ Code cũ đang chạy! Vui lòng hard refresh (Ctrl+Shift+R)', 'warning', 5000);
                } else {
                    console.log('[LOAD] Could not load from API, will try localStorage:', e.message);
                }
            }

            // ƯU TIÊN HOÀN TOÀN SERVER DATA - Không merge với localStorage để đảm bảo đồng bộ
            // Chỉ dùng localStorage khi server không có data hoặc lỗi
            if (serverLicenses.length > 0) {
                // Server có data -> Dùng server data hoàn toàn, bỏ qua localStorage
                licenses = serverLicenses.map(item => {
                    if (item && item.key) {
                        const normalizedKey = String(item.key).trim().toUpperCase();
                        return { ...item, key: normalizedKey };
                    }
                    return item;
                }).filter(item => item && item.key);
                
                console.log(`[LOAD] ✅ Using SERVER data only: ${licenses.length} licenses (ignoring localStorage for sync)`);
                
                // Cập nhật localStorage để đồng bộ với server (nhưng không dùng để merge)
                try {
                    const serverDataJson = JSON.stringify(licenses);
                    localStorage.setItem(STORAGE_KEY, serverDataJson);
                    console.log('[LOAD] Updated localStorage to match server data');
                } catch (e) {
                    console.warn('[LOAD] Could not update localStorage:', e);
                }
            } else {
                // Server không có data -> Fallback về localStorage (chỉ khi offline hoặc server lỗi)
                let localLicenses = [];
                try {
                    const data = localStorage.getItem(STORAGE_KEY);
                    if (data) {
                        const parsed = JSON.parse(data);
                        if (Array.isArray(parsed)) {
                            localLicenses = parsed;
                        }
                    }
                } catch (e) {
                    console.warn('[LOAD] Error reading localStorage:', e);
                }
                
                licenses = localLicenses.map(item => {
                    if (item && item.key) {
                        const normalizedKey = String(item.key).trim().toUpperCase();
                        return { ...item, key: normalizedKey };
                    }
                    return item;
                }).filter(item => item && item.key);
                
                console.log(`[LOAD] ⚠️ Server empty, using localStorage fallback: ${licenses.length} licenses`);
            }
            
            console.log(`[LOAD] Final licenses count: ${licenses.length}`);

            // Lưu snapshot vào localStorage để cache
            // QUAN TRỌNG: Ghi đè dữ liệu cũ trong localStorage bằng dữ liệu từ server
            // Điều này đảm bảo localStorage luôn đồng bộ với server
            try {
                const licensesJson = JSON.stringify(licenses);
                localStorage.setItem(STORAGE_KEY, licensesJson);
                lastLicensesSnapshot = licensesJson;
                console.log(`[LOAD] Saved ${licenses.length} licenses to localStorage (overwritten old data)`);
            } catch (e) {
                // Xử lý lỗi localStorage quota
                if (e.name === 'QuotaExceededError' || e.code === 22) {
                    console.warn('[LOAD] LocalStorage quota exceeded, data too large to cache');
                    // Vẫn tiếp tục, chỉ không cache được
                } else {
                    console.warn('[LOAD] Could not save merged data to localStorage:', e);
                }
            }

            console.log('[LOAD] Final licenses after merge:', licenses.length);
        }

        // Tự động refresh UI khi localStorage thay đổi (cùng tab hoặc tab khác)
        // Cũng reload từ GitHub định kỳ để đồng bộ giữa các thiết bị
        let lastGitHubRefresh = 0;
        const GITHUB_REFRESH_INTERVAL = 1000; // Refresh từ GitHub mỗi 1 giây để đồng bộ realtime nhanh hơn
        let isLoadingFromGitHub = false; // Flag để tránh multiple concurrent reloads
        let lastServerDataHash = null; // Hash của dữ liệu server để phát hiện thay đổi
        
        async function refreshLicensesIfChanged() {
            try {
                const data = localStorage.getItem(STORAGE_KEY);
                // Kiểm tra localStorage thay đổi
                if (data !== lastLicensesSnapshot) {
                    if (data) {
                        const parsed = JSON.parse(data);
                        if (Array.isArray(parsed)) {
                            licenses = parsed;
                            lastLicensesSnapshot = data;
                            renderLicenses();
                            updateStats();
                            console.log('[REFRESH] UI updated from localStorage');
                        }
                    }
                }
                
                // Định kỳ reload từ GitHub để đồng bộ giữa các thiết bị
                // Tránh multiple concurrent reloads
                const now = Date.now();
                // Force reload nếu lastGitHubRefresh = 0 (được set khi visibility/focus)
                const shouldReload = (now - lastGitHubRefresh >= GITHUB_REFRESH_INTERVAL || lastGitHubRefresh === 0) && !isLoadingFromGitHub;
                
                if (shouldReload) {
                    lastGitHubRefresh = now;
                    isLoadingFromGitHub = true;
                    try {
                        // Lưu hash và snapshot trước khi load để so sánh
                        const previousHash = lastServerDataHash;
                        const previousSnapshot = lastLicensesSnapshot;
                        
                        // Reset hash để force reload từ server (không cache)
                        lastServerDataHash = null;
                        
                        // Load từ server (luôn mới, không cache)
                        await loadLicenses();
                        
                        // Luôn render để đảm bảo UI cập nhật với dữ liệu mới nhất từ server
                        const newData = JSON.stringify(licenses);
                        const dataChanged = newData !== previousSnapshot;
                        const serverDataChanged = previousHash !== null && lastServerDataHash !== null && previousHash !== lastServerDataHash;
                        
                        // Luôn render nếu có thay đổi hoặc đây là lần đầu load
                        if (dataChanged || serverDataChanged || previousSnapshot === null) {
                            lastLicensesSnapshot = newData;
                            renderLicenses();
                            updateStats();
                            
                            if (serverDataChanged) {
                                console.log('[REFRESH] ⚡⚡⚡ Server data changed! UI updated from server');
                                // Hiển thị thông báo khi có thay đổi từ thiết bị khác
                                showToast('🔄 Đã cập nhật dữ liệu mới từ server', 'info', 2000);
                            } else if (dataChanged) {
                                console.log('[REFRESH] UI updated from server (data changed)');
                            } else {
                                console.log('[REFRESH] UI updated from server (initial load)');
                            }
                        } else {
                            // Vẫn update stats để đảm bảo số lượng hiển thị đúng
                            updateStats();
                            console.log('[REFRESH] No changes detected, stats updated');
                        }
                    } catch (e) {
                        console.log('[REFRESH] Could not refresh from server:', e.message);
                    } finally {
                        isLoadingFromGitHub = false;
                    }
                }
            } catch (e) {
                console.error('Error refreshing licenses:', e);
                isLoadingFromGitHub = false;
            }
        }

        // Tính trạng thái
        function getLicenseStatus(expiryDate) {
            const expiry = new Date(expiryDate);
            const now = new Date();
            const diffTime = expiry - now;
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            
            // Hết hạn khi đã qua thời điểm hết hạn (diffTime <= 0)
            if (diffTime <= 0) {
                return { status: 'expired', days: diffDays, valid: false };
            } else if (diffDays <= 7) {
                return { status: 'expiring', days: diffDays, valid: true };
            } else {
                return { status: 'valid', days: diffDays, valid: true };
            }
        }

        // Định dạng thời gian
        function formatDateTime(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString('vi-VN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }

        // Format time remaining - hiển thị đầy đủ ngày, giờ, phút, giây
        function formatTimeRemaining(expiryDate) {
            const expiry = new Date(expiryDate);
            const now = new Date();
            const diffMs = expiry - now;
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
            
            // Hết hạn chỉ khi đã qua thời điểm expiry
            if (diffMs <= 0) return 'Đã hết hạn';
            
            const diffHours = Math.floor((diffMs % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const diffMinutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
            const diffSeconds = Math.floor((diffMs % (1000 * 60)) / 1000);
            
            // Luôn hiển thị đầy đủ: ngày, giờ, phút, giây
            if (diffDays > 0) {
                return `${diffDays} ngày ${diffHours} giờ ${diffMinutes} phút ${diffSeconds} giây`;
            } else if (diffHours > 0) {
                return `${diffHours} giờ ${diffMinutes} phút ${diffSeconds} giây`;
            } else if (diffMinutes > 0) {
                return `${diffMinutes} phút ${diffSeconds} giây`;
            } else {
                return `${diffSeconds} giây`;
            }
        }
        
        // Realtime countdown timer - cập nhật mỗi giây
        let countdownIntervals = {};
        
        function startRealtimeCountdown(licenseKey, expiryDate, elementId) {
            // Dừng interval cũ nếu có
            if (countdownIntervals[licenseKey]) {
                clearInterval(countdownIntervals[licenseKey]);
            }
            
            // Cập nhật ngay lập tức
            updateCountdownDisplay(licenseKey, expiryDate, elementId);
            
            // Cập nhật mỗi giây
            countdownIntervals[licenseKey] = setInterval(() => {
                updateCountdownDisplay(licenseKey, expiryDate, elementId);
            }, 1000);
        }
        
        function updateCountdownDisplay(licenseKey, expiryDate, elementId) {
            const element = document.getElementById(elementId);
            if (!element) {
                // Nếu element không tồn tại, dừng interval
                if (countdownIntervals[licenseKey]) {
                    clearInterval(countdownIntervals[licenseKey]);
                    delete countdownIntervals[licenseKey];
                }
                return;
            }
            
            const expiry = new Date(expiryDate);
            const now = new Date();
            const diffMs = expiry - now;
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
            
            // Hết hạn chỉ khi đã qua thời điểm expiry
            if (diffMs <= 0) {
                element.textContent = 'Đã hết hạn';
                element.className = 'text-danger fw-bold';
                // Dừng interval khi hết hạn
                if (countdownIntervals[licenseKey]) {
                    clearInterval(countdownIntervals[licenseKey]);
                    delete countdownIntervals[licenseKey];
                }
                // KHÔNG gọi renderLicenses() ở đây để tránh loop và conflict
                // Status đã được cập nhật đúng trong renderLicenses()
                return;
            }
            const diffHours = Math.floor((diffMs % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const diffMinutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
            const diffSeconds = Math.floor((diffMs % (1000 * 60)) / 1000);
            
            let timeText = '';
            if (diffDays > 0) {
                timeText = `${diffDays} ngày ${diffHours} giờ ${diffMinutes} phút ${diffSeconds} giây`;
            } else if (diffHours > 0) {
                timeText = `${diffHours} giờ ${diffMinutes} phút ${diffSeconds} giây`;
            } else if (diffMinutes > 0) {
                timeText = `${diffMinutes} phút ${diffSeconds} giây`;
            } else {
                timeText = `${diffSeconds} giây`;
            }
            
            element.textContent = timeText;
            element.className = diffDays <= 7 ? 'text-warning fw-bold' : 'text-success fw-bold';
        }
        
        function stopAllCountdowns() {
            Object.keys(countdownIntervals).forEach(key => {
                clearInterval(countdownIntervals[key]);
            });
            countdownIntervals = {};
        }

        // Hiển thị modal thêm
        function showAddModal() {
            currentEditKey = null;
            document.getElementById('modalTitle').textContent = 'Thêm License Mới';
            document.getElementById('modalSaveBtn').textContent = 'Thêm License';
            document.getElementById('licenseKey').value = '';
            document.getElementById('licenseKey').readOnly = false;
            document.getElementById('licenseNote').value = '';
            
            // Reset checkbox và input số ngày
            const addToCurrentCheckbox = document.getElementById('addToCurrentDate');
            if (addToCurrentCheckbox) {
                addToCurrentCheckbox.checked = false;
                updateCustomDaysLabel();
            }
            const customDaysInput = document.getElementById('customDaysInput');
            if (customDaysInput) {
                customDaysInput.value = '';
            }
            
            // Đặt thời gian mặc định
            const defaultDate = new Date();
            defaultDate.setDate(defaultDate.getDate() + 30);
            defaultDate.setMinutes(defaultDate.getMinutes() - defaultDate.getTimezoneOffset());
            document.getElementById('expiryDate').value = defaultDate.toISOString().slice(0, 16);
            
            document.getElementById('previewSection').style.display = 'none';
            
            const modal = new bootstrap.Modal(document.getElementById('licenseModal'));
            modal.show();
        }

        // Hiển thị modal sửa
        function showEditModal(key) {
            const license = licenses.find(l => l.key === key);
            if (!license) return;
            
            currentEditKey = key;
            document.getElementById('modalTitle').textContent = 'Sửa License';
            document.getElementById('modalSaveBtn').textContent = 'Cập nhật';
            document.getElementById('licenseKey').value = license.key;
            document.getElementById('licenseKey').readOnly = true;
            document.getElementById('licenseNote').value = license.note || '';
            
            // Reset checkbox và input số ngày
            const addToCurrentCheckbox = document.getElementById('addToCurrentDate');
            if (addToCurrentCheckbox) {
                addToCurrentCheckbox.checked = false;
                updateCustomDaysLabel();
            }
            const customDaysInput = document.getElementById('customDaysInput');
            if (customDaysInput) {
                customDaysInput.value = '';
            }
            
            // Định dạng ngày
            const expiryDate = new Date(license.expiry);
            expiryDate.setMinutes(expiryDate.getMinutes() - expiryDate.getTimezoneOffset());
            document.getElementById('expiryDate').value = expiryDate.toISOString().slice(0, 16);
            
            updatePreview();
            
            const modal = new bootstrap.Modal(document.getElementById('licenseModal'));
            modal.show();
        }

        // Cập nhật preview
        function updatePreview() {
            const key = document.getElementById('licenseKey').value;
            const expiry = document.getElementById('expiryDate').value;
            
            if (key && expiry) {
                const expiryDate = new Date(expiry);
                const status = getLicenseStatus(expiryDate);
                
                let statusText = '';
                let statusClass = '';
                
                switch(status.status) {
                    case 'valid':
                        statusText = `Còn hạn (${status.days} ngày)`;
                        statusClass = 'status-valid';
                        break;
                    case 'expiring':
                        statusText = `Sắp hết hạn (${status.days} ngày)`;
                        statusClass = 'status-expiring';
                        break;
                    case 'expired':
                        statusText = 'Hết hạn';
                        statusClass = 'status-expired';
                        break;
                }
                
                // Nếu đã hết hạn thì hiển thị "Đã hết hạn", không gọi formatTimeRemaining
                const timeRemainingPreview = status.status === 'expired' ? 'Đã hết hạn' : formatTimeRemaining(expiryDate);
                
                document.getElementById('previewContent').innerHTML = `
                    <div class="row">
                        <div class="col-md-6">
                            <strong>Key:</strong><br>
                            <code class="license-key">${key}</code>
                        </div>
                        <div class="col-md-6">
                            <strong>Hết hạn:</strong><br>
                            ${formatDateTime(expiryDate)}
                        </div>
                    </div>
                    <div class="row mt-2">
                        <div class="col-md-6">
                            <strong>Trạng thái:</strong><br>
                            <span class="status-badge ${statusClass}">${statusText}</span>
                        </div>
                        <div class="col-md-6">
                            <strong>Còn lại:</strong><br>
                            ${timeRemainingPreview}
                        </div>
                    </div>
                `;
                document.getElementById('previewSection').style.display = 'block';
            }
        }

        // Thêm ngày
        function addDays(days) {
            const date = new Date();
            date.setDate(date.getDate() + days);
            date.setMinutes(date.getMinutes() - date.getTimezoneOffset());
            document.getElementById('expiryDate').value = date.toISOString().slice(0, 16);
            updatePreview();
        }

        // Cập nhật label cho tùy chọn số ngày
        function updateCustomDaysLabel() {
            const checkbox = document.getElementById('addToCurrentDate');
            const helpText = document.getElementById('customDaysHelp');
            if (checkbox.checked) {
                helpText.textContent = 'Cộng thêm số ngày vào ngày hết hạn đã chọn (1-3650 ngày)';
            } else {
                helpText.textContent = 'Nhập số ngày từ hôm nay (1-3650 ngày)';
            }
        }

        // Thêm số ngày tùy chỉnh
        function addCustomDays() {
            const customDays = parseInt(document.getElementById('customDaysInput').value);
            if (!customDays || customDays < 1 || customDays > 3650) {
                showModalAlert('Vui lòng nhập số ngày hợp lệ (1-3650 ngày)', 'Số ngày không hợp lệ', 'warning');
                return;
            }
            
            const addToCurrent = document.getElementById('addToCurrentDate').checked;
            if (addToCurrent) {
                // Cộng thêm vào ngày đã chọn
                const expiryInput = document.getElementById('expiryDate').value;
                if (!expiryInput) {
                    showModalAlert('Vui lòng chọn ngày hết hạn trước', 'Thiếu thông tin', 'warning');
                    return;
                }
                const currentDate = new Date(expiryInput);
                currentDate.setDate(currentDate.getDate() + customDays);
                currentDate.setMinutes(currentDate.getMinutes() - currentDate.getTimezoneOffset());
                document.getElementById('expiryDate').value = currentDate.toISOString().slice(0, 16);
            } else {
                // Thêm từ hôm nay (chế độ cũ)
                addDays(customDays);
            }
            document.getElementById('customDaysInput').value = '';
            updatePreview();
        }

        // Đặt thời gian hiện tại
        function setNow() {
            const date = new Date();
            date.setMinutes(date.getMinutes() - date.getTimezoneOffset());
            document.getElementById('expiryDate').value = date.toISOString().slice(0, 16);
            updatePreview();
        }

        // Lưu license (THÊM hoặc SỬA)
        // QUAN TRỌNG: Mọi thay đổi license đều phải gọi saveLicenses() để sync lên server/JSON
        function saveLicense() {
            const key = document.getElementById('licenseKey').value.trim().toUpperCase();
            const expiry = document.getElementById('expiryDate').value;
            const note = document.getElementById('licenseNote').value.trim();
            
            if (!key || !expiry) {
                showModalAlert('Vui lòng nhập đầy đủ thông tin', 'Thiếu thông tin', 'warning');
                return false;
            }
            
            // Validation: Kiểm tra format key (chỉ cho phép chữ, số, dấu gạch ngang và gạch dưới)
            const keyPattern = /^[A-Z0-9\-_]+$/;
            if (!keyPattern.test(key)) {
                showModalAlert('License key chỉ được chứa chữ cái, số, dấu gạch ngang (-) và gạch dưới (_)', 'Key không hợp lệ', 'warning');
                return false;
            }
            
            // Validation: Kiểm tra độ dài key (tối đa 100 ký tự)
            if (key.length > 100) {
                showModalAlert('License key không được vượt quá 100 ký tự', 'Key quá dài', 'warning');
                return false;
            }
            
            // Validation: Kiểm tra độ dài note (tối đa 500 ký tự)
            if (note.length > 500) {
                showModalAlert('Ghi chú không được vượt quá 500 ký tự', 'Ghi chú quá dài', 'warning');
                return false;
            }
            
            // Kiểm tra key trùng
            if (!currentEditKey && licenses.some(l => l.key === key)) {
                showModalAlert('License key đã tồn tại! Vui lòng chọn key khác.', 'Key trùng lặp', 'warning');
                return false;
            }
            
            const expiryDate = new Date(expiry);
            
            // Validation: Kiểm tra date hợp lệ
            if (isNaN(expiryDate.getTime())) {
                showModalAlert('Ngày hết hạn không hợp lệ', 'Lỗi định dạng ngày', 'error');
                return false;
            }
            
            if (currentEditKey) {
                // CẬP NHẬT license hiện có
                // Đảm bảo key không bị thay đổi (mặc dù đã readOnly nhưng cần kiểm tra an toàn)
                const index = licenses.findIndex(l => l.key === currentEditKey);
                if (index !== -1) {
                    // Kiểm tra key có bị thay đổi không (an toàn)
                    if (licenses[index].key !== key) {
                        console.warn('[SAVE] Key mismatch detected, using original key:', currentEditKey);
                        // Nếu key bị thay đổi (không nên xảy ra vì readOnly), vẫn dùng key gốc
                    }
                    licenses[index].expiry = expiryDate.toISOString();
                    licenses[index].note = note;
                    licenses[index].updated = new Date().toISOString();
                    // Đảm bảo key không bị thay đổi
                    licenses[index].key = currentEditKey;
                } else {
                    showModalAlert('Không tìm thấy license để cập nhật', 'Lỗi', 'error');
                    return false;
                }
            } else {
                // THÊM license mới
                licenses.push({
                    key: key,
                    expiry: expiryDate.toISOString(),
                    note: note,
                    created: new Date().toISOString(),
                    updated: new Date().toISOString()
                });
            }
            
            // BẮT BUỘC: Lưu và sync lên server/JSON sau mọi thay đổi
            saveLicenses();
            
            // Render ngay với dữ liệu local để UI responsive
            renderLicenses();
            updateStats();
            
            // Reset edit key sau khi save
            const wasEditing = !!currentEditKey;
            currentEditKey = null;
            
            const modal = bootstrap.Modal.getInstance(document.getElementById('licenseModal'));
            modal.hide();
            
            showToast(wasEditing ? 'Cập nhật thành công! Đang đồng bộ...' : 'Thêm license thành công! Đang đồng bộ...');
            
            // Force reload từ GitHub sau một chút để đảm bảo dữ liệu mới nhất
            // Đặc biệt quan trọng trên mobile khi network có thể chậm
            setTimeout(async () => {
                try {
                    if (!isLoadingFromGitHub) {
                        await loadLicenses();
                        renderLicenses();
                        updateStats();
                        console.log('[SAVE] Force reloaded from GitHub after save');
                    }
                } catch (e) {
                    console.log('[SAVE] Could not force reload from GitHub:', e.message);
                }
            }, 3000); // Đợi 3 giây để GitHub CDN cập nhật
            
            return false;
        }

        // Xóa license với modal xác nhận và mật khẩu
        // QUAN TRỌNG: Sau khi xóa phải gọi saveLicenses() để sync lên server/JSON
        function deleteLicense(key) {
            const deletePassword = 'Nguy3nc0ngd@t';
            const modalId = 'deleteConfirmModal_' + Date.now();
            
            const modalHtml = `
                <div class="modal fade" id="${modalId}" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header bg-danger text-white">
                                <h5 class="modal-title">
                                    <i class="bi bi-exclamation-triangle me-2"></i>Xác nhận xóa License
                                </h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="alert alert-warning">
                                    <i class="bi bi-exclamation-triangle me-2"></i>
                                    <strong>Cảnh báo:</strong> Hành động này không thể hoàn tác!
                                </div>
                                <p>Bạn có chắc chắn muốn xóa license:</p>
                                <div class="alert alert-light">
                                    <code class="license-key">${escapeHtml(key)}</code>
                                </div>
                                <div class="mb-3">
                                    <label for="deletePasswordInput_${modalId}" class="form-label">
                                        <i class="bi bi-lock me-2"></i>Nhập mật khẩu để xác nhận:
                                    </label>
                                    <div class="input-group">
                                        <input type="password" class="form-control" id="deletePasswordInput_${modalId}" 
                                               placeholder="Nhập mật khẩu" autocomplete="off">
                                        <button class="btn btn-outline-secondary" type="button" id="toggleDeletePassword_${modalId}">
                                            <i class="bi bi-eye" id="deletePasswordIcon_${modalId}"></i>
                                        </button>
                                    </div>
                                    <div class="invalid-feedback" id="deletePasswordError_${modalId}"></div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                                <button type="button" class="btn btn-danger" id="confirmDeleteBtn_${modalId}">
                                    <i class="bi bi-trash me-2"></i>Xóa License
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Xóa modal cũ nếu có
            const oldModal = document.querySelector('[id^="deleteConfirmModal_"]');
            if (oldModal) oldModal.remove();
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            const modalEl = document.getElementById(modalId);
            const modal = new bootstrap.Modal(modalEl);
            
            const passwordInput = document.getElementById('deletePasswordInput_' + modalId);
            const confirmBtn = document.getElementById('confirmDeleteBtn_' + modalId);
            const errorDiv = document.getElementById('deletePasswordError_' + modalId);
            const toggleBtn = document.getElementById('toggleDeletePassword_' + modalId);
            const toggleIcon = document.getElementById('deletePasswordIcon_' + modalId);
            
            // Toggle password visibility
            toggleBtn.addEventListener('click', function() {
                const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
                passwordInput.setAttribute('type', type);
                toggleIcon.classList.toggle('bi-eye');
                toggleIcon.classList.toggle('bi-eye-slash');
            });
            
            // Handle Enter key
            passwordInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    confirmBtn.click();
                }
            });
            
            // Handle confirm delete
            confirmBtn.addEventListener('click', function() {
                const enteredPassword = passwordInput.value.trim();
                
                if (!enteredPassword) {
                    passwordInput.classList.add('is-invalid');
                    errorDiv.textContent = 'Vui lòng nhập mật khẩu';
                    return;
                }
                
                if (enteredPassword !== deletePassword) {
                    passwordInput.classList.add('is-invalid');
                    errorDiv.textContent = 'Mật khẩu không đúng';
                    passwordInput.value = '';
                    passwordInput.focus();
                    return;
                }
                
                // Mật khẩu đúng, tiến hành xóa
                passwordInput.classList.remove('is-invalid');
                licenses = licenses.filter(l => l.key !== key);
                
                // BẮT BUỘC: Lưu và sync lên server/JSON sau khi xóa
                saveLicenses();
                renderLicenses();
                updateStats();
                
                modal.hide();
                modalEl.addEventListener('hidden.bs.modal', function() {
                    this.remove();
                });
                
                showToast('Đã xóa license thành công!', 'success');
            });
            
            modal.show();
            setTimeout(() => passwordInput.focus(), 300);
        }

        // Render licenses với pagination
        function renderLicenses(filteredLicenses = null) {
            const container = document.getElementById('licensesContainer');
            const emptyState = document.getElementById('emptyState');
            const paginationContainer = document.getElementById('paginationContainer');
            const data = filteredLicenses || licenses;
            
            // Lưu filtered data để pagination
            filteredLicensesForPagination = data;
            
            if (data.length === 0) {
                container.innerHTML = '';
                emptyState.style.display = 'block';
                paginationContainer.style.display = 'none';
                document.getElementById('totalLicenses').textContent = '0 license';
                return;
            }
            
            emptyState.style.display = 'none';
            document.getElementById('totalLicenses').textContent = `${data.length} license${data.length > 1 ? 's' : ''}`;
            
            // Tính toán pagination
            const totalPages = Math.ceil(data.length / itemsPerPage);
            if (currentPage > totalPages) {
                currentPage = totalPages || 1;
            }
            
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedData = data.slice(startIndex, endIndex);
            
            let html = '';
            paginatedData.forEach((license, index) => {
                const globalIndex = startIndex + index;
                const status = getLicenseStatus(license.expiry);
                // Nếu đã hết hạn thì hiển thị "Đã hết hạn", không gọi formatTimeRemaining
                const timeRemaining = status.status === 'expired' ? 'Đã hết hạn' : formatTimeRemaining(license.expiry);
                const created = formatDateTime(license.created);
                const expiry = formatDateTime(license.expiry);
                
                let statusText = '';
                let statusClass = '';
                let icon = '';
                
                switch(status.status) {
                    case 'valid':
                        statusText = `Còn hạn (${status.days} ngày)`;
                        statusClass = 'status-valid';
                        icon = 'bi-check-circle-fill';
                        break;
                    case 'expiring':
                        statusText = `Sắp hết hạn (${status.days} ngày)`;
                        statusClass = 'status-expiring';
                        icon = 'bi-exclamation-triangle-fill';
                        break;
                    case 'expired':
                        statusText = 'Hết hạn';
                        statusClass = 'status-expired';
                        icon = 'bi-x-circle-fill';
                        break;
                }
                
                const countdownId = `countdown_${license.key}_${globalIndex}`;
                
                html += `
                    <div class="license-card">
                        <div class="row align-items-center">
                            <div class="col-md-3">
                                <div class="d-flex align-items-center">
                                    <input type="checkbox" class="form-check-input license-checkbox" 
                                           data-license-key="${escapeHtml(license.key)}"
                                           onchange="updateBulkActions()"
                                           style="z-index: 100; position: relative;">
                                    <i class="${icon} me-2 fs-4 text-${status.status === 'valid' ? 'success' : status.status === 'expiring' ? 'warning' : 'danger'}"></i>
                                    <div class="flex-grow-1">
                                        <div class="d-flex align-items-center gap-2 mb-1">
                                            <div class="license-key flex-grow-1" 
                                                 onclick="copyLicenseKey('${escapeHtml(license.key).replace(/'/g, "\\'")}', this)" 
                                                 title="Click để copy license key">
                                                ${escapeHtml(license.key)}
                                            </div>
                                        </div>
                                        <small class="text-muted d-block">Tạo: ${created}</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div>
                                    <small class="text-muted d-block mb-1">Hết hạn:</small>
                                    <div class="fw-bold">${expiry}</div>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div>
                                    <small class="text-muted d-block mb-1">Trạng thái:</small>
                                    <div><span class="status-badge ${statusClass}">${statusText}</span></div>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div>
                                    <small class="text-muted d-block mb-1">Còn lại:</small>
                                    <div id="${countdownId}" class="${status.status === 'expired' ? 'text-danger' : status.status === 'expiring' ? 'text-warning' : 'text-success'} fw-bold">
                                        ${timeRemaining}
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-2 text-end">
                                <button class="btn btn-sm btn-outline-primary action-btn me-1" 
                                        onclick="showEditModal('${escapeHtml(license.key)}')" title="Sửa"
                                        style="z-index: 100; position: relative;">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger action-btn me-1" 
                                        onclick="deleteLicense('${escapeHtml(license.key)}')" title="Xóa"
                                        style="z-index: 100; position: relative;">
                                    <i class="bi bi-trash"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-success action-btn" 
                                        onclick="showVerifyUrl('${escapeHtml(license.key)}')" title="Verify URL"
                                        style="z-index: 100; position: relative;">
                                    <i class="bi bi-link"></i>
                                </button>
                            </div>
                        </div>
                        ${license.note ? `<div class="mt-2"><small><i class="bi bi-chat-left-text"></i> ${escapeHtml(license.note)}</small></div>` : ''}
                    </div>
                `;
            });
            
            // Dừng tất cả countdown intervals trước khi render lại để tránh conflict
            stopAllCountdowns();
            
            container.innerHTML = html;
            
            // Khởi động realtime countdown cho licenses trong trang hiện tại
            paginatedData.forEach((license, index) => {
                const globalIndex = startIndex + index;
                const licenseStatus = getLicenseStatus(license.expiry);
                const countdownId = `countdown_${license.key}_${globalIndex}`;
                // Chỉ khởi động countdown cho license chưa hết hạn
                if (licenseStatus.status !== 'expired') {
                    startRealtimeCountdown(license.key, license.expiry, countdownId);
                } else {
                    // Đảm bảo element hiển thị "Đã hết hạn" và không có interval nào chạy
                    const element = document.getElementById(countdownId);
                    if (element) {
                        element.textContent = 'Đã hết hạn';
                        element.className = 'text-danger fw-bold';
                    }
                }
            });
            
            // Render pagination
            renderPagination(totalPages);
            
            // Update bulk actions visibility
            updateBulkActions();
        }
        
        // Render pagination controls
        function renderPagination(totalPages) {
            const paginationContainer = document.getElementById('paginationContainer');
            const paginationList = document.getElementById('paginationList');
            
            if (totalPages <= 1) {
                paginationContainer.style.display = 'none';
                return;
            }
            
            paginationContainer.style.display = 'block';
            let html = '';
            
            // Previous button
            html += `
                <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="goToPage(${currentPage - 1}); return false;" 
                       ${currentPage === 1 ? 'tabindex="-1" aria-disabled="true"' : ''}>
                        <i class="bi bi-chevron-left"></i> Trước
                    </a>
                </li>
            `;
            
            // Page numbers
            const maxVisiblePages = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
            
            if (endPage - startPage < maxVisiblePages - 1) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }
            
            if (startPage > 1) {
                html += `<li class="page-item"><a class="page-link" href="#" onclick="goToPage(1); return false;">1</a></li>`;
                if (startPage > 2) {
                    html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
                }
            }
            
            for (let i = startPage; i <= endPage; i++) {
                html += `
                    <li class="page-item ${i === currentPage ? 'active' : ''}">
                        <a class="page-link" href="#" onclick="goToPage(${i}); return false;">${i}</a>
                    </li>
                `;
            }
            
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
                }
                html += `<li class="page-item"><a class="page-link" href="#" onclick="goToPage(${totalPages}); return false;">${totalPages}</a></li>`;
            }
            
            // Next button
            html += `
                <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="goToPage(${currentPage + 1}); return false;"
                       ${currentPage === totalPages ? 'tabindex="-1" aria-disabled="true"' : ''}>
                        Sau <i class="bi bi-chevron-right"></i>
                    </a>
                </li>
            `;
            
            paginationList.innerHTML = html;
        }
        
        // Điều hướng đến trang
        function goToPage(page) {
            const totalPages = Math.ceil(filteredLicensesForPagination.length / itemsPerPage);
            if (page < 1 || page > totalPages) return;
            
            currentPage = page;
            renderLicenses(filteredLicensesForPagination);
            
            // Scroll to top of container
            document.getElementById('licensesContainer').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        
        // Toggle select all
        function toggleSelectAll(checked) {
            const checkboxes = document.querySelectorAll('.license-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = checked;
            });
            updateBulkActions();
        }
        
        // Update bulk actions UI
        function updateBulkActions() {
            const checkboxes = document.querySelectorAll('.license-checkbox:checked');
            const selectedCount = checkboxes.length;
            const bulkActionsContainer = document.getElementById('bulkActionsContainer');
            const selectedCountSpan = document.getElementById('selectedCount');
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            
            if (selectedCount > 0) {
                bulkActionsContainer.style.display = 'block';
                selectedCountSpan.textContent = `${selectedCount} license${selectedCount > 1 ? 's' : ''} đã chọn`;
            } else {
                bulkActionsContainer.style.display = 'none';
            }
            
            // Update select all checkbox state
            const allCheckboxes = document.querySelectorAll('.license-checkbox');
            if (selectAllCheckbox) {
                selectAllCheckbox.checked = allCheckboxes.length > 0 && selectedCount === allCheckboxes.length;
                selectAllCheckbox.indeterminate = selectedCount > 0 && selectedCount < allCheckboxes.length;
            }
        }
        
        // Bulk delete licenses
        // Xóa nhiều license cùng lúc
        // QUAN TRỌNG: Sau khi xóa phải gọi saveLicenses() để sync lên server/JSON
        function bulkDeleteLicenses() {
            const checkboxes = document.querySelectorAll('.license-checkbox:checked');
            const selectedKeys = Array.from(checkboxes).map(cb => cb.getAttribute('data-license-key'));
            
            if (selectedKeys.length === 0) {
                showModalAlert('Vui lòng chọn ít nhất một license để xóa', 'Chưa chọn license', 'warning');
                return;
            }
            
            const deletePassword = 'Nguy3nc0ngd@t';
            const modalId = 'bulkDeleteModal_' + Date.now();
            
            const modalHtml = `
                <div class="modal fade" id="${modalId}" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header bg-danger text-white">
                                <h5 class="modal-title">
                                    <i class="bi bi-exclamation-triangle me-2"></i>Xác nhận xóa ${selectedKeys.length} License
                                </h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="alert alert-warning">
                                    <i class="bi bi-exclamation-triangle me-2"></i>
                                    <strong>Cảnh báo:</strong> Hành động này không thể hoàn tác!
                                </div>
                                <p>Bạn có chắc chắn muốn xóa <strong>${selectedKeys.length}</strong> license sau:</p>
                                <div class="alert alert-light" style="max-height: 200px; overflow-y: auto;">
                                    ${selectedKeys.map(key => `<div class="mb-1"><code class="license-key">${escapeHtml(key)}</code></div>`).join('')}
                                </div>
                                <div class="mb-3">
                                    <label for="bulkDeletePasswordInput_${modalId}" class="form-label">
                                        <i class="bi bi-lock me-2"></i>Nhập mật khẩu để xác nhận:
                                    </label>
                                    <div class="input-group">
                                        <input type="password" class="form-control" id="bulkDeletePasswordInput_${modalId}" 
                                               placeholder="Nhập mật khẩu" autocomplete="off">
                                        <button class="btn btn-outline-secondary" type="button" id="toggleBulkDeletePassword_${modalId}">
                                            <i class="bi bi-eye" id="bulkDeletePasswordIcon_${modalId}"></i>
                                        </button>
                                    </div>
                                    <div class="invalid-feedback" id="bulkDeletePasswordError_${modalId}"></div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                                <button type="button" class="btn btn-danger" id="confirmBulkDeleteBtn_${modalId}">
                                    <i class="bi bi-trash me-2"></i>Xóa ${selectedKeys.length} License
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Xóa modal cũ nếu có
            const oldModal = document.querySelector('[id^="bulkDeleteModal_"]');
            if (oldModal) oldModal.remove();
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            const modalEl = document.getElementById(modalId);
            const modal = new bootstrap.Modal(modalEl);
            
            const passwordInput = document.getElementById('bulkDeletePasswordInput_' + modalId);
            const confirmBtn = document.getElementById('confirmBulkDeleteBtn_' + modalId);
            const errorDiv = document.getElementById('bulkDeletePasswordError_' + modalId);
            const toggleBtn = document.getElementById('toggleBulkDeletePassword_' + modalId);
            const toggleIcon = document.getElementById('bulkDeletePasswordIcon_' + modalId);
            
            // Toggle password visibility
            toggleBtn.addEventListener('click', function() {
                const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
                passwordInput.setAttribute('type', type);
                toggleIcon.classList.toggle('bi-eye');
                toggleIcon.classList.toggle('bi-eye-slash');
            });
            
            // Handle Enter key
            passwordInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    confirmBtn.click();
                }
            });
            
            // Handle confirm delete
            confirmBtn.addEventListener('click', function() {
                const enteredPassword = passwordInput.value.trim();
                
                if (!enteredPassword) {
                    passwordInput.classList.add('is-invalid');
                    errorDiv.textContent = 'Vui lòng nhập mật khẩu';
                    return;
                }
                
                if (enteredPassword !== deletePassword) {
                    passwordInput.classList.add('is-invalid');
                    errorDiv.textContent = 'Mật khẩu không đúng';
                    passwordInput.value = '';
                    passwordInput.focus();
                    return;
                }
                
                // Mật khẩu đúng, tiến hành xóa
                passwordInput.classList.remove('is-invalid');
                
                // Xóa các licenses đã chọn
                licenses = licenses.filter(l => !selectedKeys.includes(l.key));
                
                // BẮT BUỘC: Lưu và sync lên server/JSON sau khi xóa
                saveLicenses();
                
                // Reset selection
                checkboxes.forEach(cb => cb.checked = false);
                
                renderLicenses();
                updateStats();
                
                modal.hide();
                modalEl.addEventListener('hidden.bs.modal', function() {
                    this.remove();
                });
                
                showToast(`Đã xóa ${selectedKeys.length} license thành công!`, 'success');
            });
            
            modal.show();
            setTimeout(() => passwordInput.focus(), 300);
        }

        // Cập nhật thống kê
        // Cập nhật thống kê - luôn tính toán từ licenses hiện tại để đảm bảo chính xác
        function updateStats() {
            let valid = 0, expiring = 0, expired = 0;
            
            licenses.forEach(license => {
                const status = getLicenseStatus(license.expiry).status;
                if (status === 'valid') valid++;
                else if (status === 'expiring') expiring++;
                else if (status === 'expired') expired++;
            });
            
            document.getElementById('validCount').textContent = valid;
            document.getElementById('expiringCount').textContent = expiring;
            document.getElementById('expiredCount').textContent = expired;
        }

        // Lọc licenses
        function filterLicenses() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            
            let filtered = licenses;
            
            if (searchTerm) {
                filtered = filtered.filter(license => 
                    license.key.toLowerCase().includes(searchTerm) ||
                    (license.note && license.note.toLowerCase().includes(searchTerm))
                );
            }
            
            if (statusFilter !== 'all') {
                filtered = filtered.filter(license => 
                    getLicenseStatus(license.expiry).status === statusFilter
                );
            }
            
            // Reset về trang 1 khi filter
            currentPage = 1;
            renderLicenses(filtered);
        }

        // Xóa tìm kiếm
        function clearSearch() {
            document.getElementById('searchInput').value = '';
            document.getElementById('statusFilter').value = 'all';
            filterLicenses();
        }

        // Verify license
        function verifyLicense() {
            const key = document.getElementById('verifyKeyInput').value.trim().toUpperCase();
            if (!key) {
                showModalAlert('Vui lòng nhập license key', 'Thiếu thông tin', 'warning');
                return;
            }
            
            const license = licenses.find(l => l.key === key);
            const resultDiv = document.getElementById('verifyResult');
            
            if (!license) {
                resultDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <h5><i class="bi bi-x-circle"></i> License không tồn tại</h5>
                        <p class="mb-0">License key <strong>${key}</strong> không tìm thấy trong hệ thống.</p>
                    </div>
                `;
                return;
            }
            
            const status = getLicenseStatus(license.expiry);
            const expiry = formatDateTime(license.expiry);
            // Nếu đã hết hạn thì hiển thị "Đã hết hạn", không gọi formatTimeRemaining
            const timeRemaining = status.status === 'expired' ? 'Đã hết hạn' : formatTimeRemaining(license.expiry);
            
            let alertClass = '';
            let icon = '';
            let title = '';
            
            if (status.valid) {
                alertClass = status.status === 'expiring' ? 'alert-warning' : 'alert-success';
                icon = status.status === 'expiring' ? 'bi-exclamation-triangle' : 'bi-check-circle';
                title = status.status === 'expiring' ? 'Sắp hết hạn' : 'License hợp lệ';
            } else {
                alertClass = 'alert-danger';
                icon = 'bi-x-circle';
                title = 'License đã hết hạn';
            }
            
            resultDiv.innerHTML = `
                <div class="alert ${alertClass}">
                    <h5><i class="bi ${icon}"></i> ${title}</h5>
                    <div class="row">
                        <div class="col-md-6">
                            <strong>License Key:</strong><br>
                            <code class="license-key">${key}</code>
                        </div>
                        <div class="col-md-6">
                            <strong>Hết hạn:</strong><br>
                            ${expiry}
                        </div>
                    </div>
                    <div class="row mt-2">
                        <div class="col-md-6">
                            <strong>Trạng thái:</strong><br>
                            <span class="status-badge ${status.status === 'valid' ? 'status-valid' : status.status === 'expiring' ? 'status-expiring' : 'status-expired'}">
                                ${status.status === 'valid' ? 'Còn hạn' : status.status === 'expiring' ? 'Sắp hết hạn' : 'Hết hạn'}
                            </span>
                        </div>
                        <div class="col-md-6">
                            <strong>Thời gian còn lại:</strong><br>
                            ${timeRemaining}
                        </div>
                    </div>
                    ${license.note ? `<div class="mt-2"><strong>Ghi chú:</strong> ${escapeHtml(license.note)}</div>` : ''}
                    <div class="mt-3">
                        <strong>Verify URL:</strong>
                        <div class="verify-url mt-1">
                            <code>${escapeHtml(getVerifyUrl(key))}</code>
                            <i class="bi bi-copy copy-btn float-end" onclick="copyToClipboard('${escapeHtml(getVerifyUrl(key))}')"></i>
                        </div>
                    </div>
                </div>
            `;
        }

        // Tạo QR code - sử dụng API online hoặc library
        function generateQRCode() {
            const key = document.getElementById('qrKeyInput').value.trim().toUpperCase();
            if (!key) {
                showModalAlert('Vui lòng nhập license key', 'Thiếu thông tin', 'warning');
                return;
            }
            
            const container = document.getElementById('qrCodeContainer');
            if (!container) {
                console.error('QR code container not found');
                return;
            }
            
            const verifyUrl = getVerifyUrl(key);
            container.innerHTML = '<div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div>';
            
            // Ưu tiên dùng QRCode library nếu có
            if (typeof QRCode !== 'undefined') {
                try {
                    QRCode.toCanvas(verifyUrl, { 
                        width: 200,
                        height: 200,
                        margin: 1,
                        color: {
                            dark: '#000000',
                            light: '#FFFFFF'
                        }
                    }, function(error, canvas) {
                        if (error) {
                            generateQRCodeWithAPI(verifyUrl, key, container);
                            return;
                        }
                        
                        if (!canvas) {
                            generateQRCodeWithAPI(verifyUrl, key, container);
                            return;
                        }
                        
                        container.innerHTML = `
                            <div class="mb-2">
                                ${canvas.outerHTML}
                            </div>
                            <div class="verify-url small">
                                <code>${escapeHtml(verifyUrl)}</code>
                            </div>
                            <button class="btn btn-sm btn-outline-primary mt-2" onclick="downloadQRCode('${escapeHtml(key)}')">
                                <i class="bi bi-download"></i> Tải QR Code
                            </button>
                        `;
                    });
                    return;
                } catch (e) {
                    console.warn('QRCode library error, using API fallback:', e);
                }
            }
            
            // Fallback: dùng API online để tạo QR code
            generateQRCodeWithAPI(verifyUrl, key, container);
        }
        
        // Tạo QR code bằng API online (không cần library)
        function generateQRCodeWithAPI(url, key, container) {
            // Sử dụng API QR code miễn phí
            const qrApiUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(url)}`;
            
            const img = document.createElement('img');
            img.src = qrApiUrl;
            img.alt = 'QR Code';
            img.className = 'img-fluid';
            img.style.maxWidth = '200px';
            img.style.height = 'auto';
            img.style.border = '1px solid #dee2e6';
            img.style.borderRadius = '10px';
            img.style.padding = '10px';
            img.style.background = 'white';
            
            img.onload = function() {
                container.innerHTML = `
                    <div class="mb-2">
                        ${img.outerHTML}
                    </div>
                    <div class="verify-url small">
                        <code>${escapeHtml(url)}</code>
                    </div>
                    <button class="btn btn-sm btn-outline-primary mt-2" onclick="downloadQRCodeFromAPI('${escapeHtml(key)}', '${escapeHtml(url)}')">
                        <i class="bi bi-download"></i> Tải QR Code
                    </button>
                `;
            };
            
            img.onerror = function() {
                // Nếu API cũng fail, hiển thị URL để copy
                container.innerHTML = `
                    <div class="alert alert-warning">
                        <h6><i class="bi bi-exclamation-triangle"></i> Không thể tạo QR code</h6>
                        <p class="mb-2">Vui lòng kiểm tra kết nối internet hoặc sử dụng URL sau:</p>
                        <div class="verify-url mt-2 mb-2">
                            <code>${escapeHtml(url)}</code>
                        </div>
                        <button class="btn btn-sm btn-primary" onclick="copyToClipboard('${escapeHtml(url).replace(/'/g, "\\'")}')">
                            <i class="bi bi-copy"></i> Copy URL
                        </button>
                    </div>
                `;
            };
        }
        
        // Download QR code từ API
        function downloadQRCodeFromAPI(key, url) {
            const qrApiUrl = `https://api.qrserver.com/v1/create-qr-code/?size=500x500&data=${encodeURIComponent(url)}`;
            const link = document.createElement('a');
            link.href = qrApiUrl;
            link.download = `license-verify-${key}.png`;
            link.target = '_blank';
            link.click();
        }
        
        // Tải QR code (hỗ trợ cả canvas và img)
        function downloadQRCode(key) {
            const verifyUrl = getVerifyUrl(key);
            const canvas = document.querySelector('#qrCodeContainer canvas');
            const img = document.querySelector('#qrCodeContainer img');
            
            if (canvas) {
                const link = document.createElement('a');
                link.download = `license-verify-${key}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
            } else if (img) {
                // Download từ API
                downloadQRCodeFromAPI(key, verifyUrl);
            }
        }

        let verifyUrlModalInstance = null;
        let verifyUrlModalEl = null;

        // Lấy verify URL
        // Trả về endpoint API verify trực tiếp thay vì trang HTML
        function getVerifyUrl(key) {
            return `${window.location.origin}/api/verify?verify=${encodeURIComponent(key)}`;
        }

        // Hiển thị verify URL
        function showVerifyUrl(key) {
            const url = getVerifyUrl(key);
            const safeKey = escapeHtml(key);
            const safeUrl = escapeHtml(url);
            
            const modalHtml = `
                <div class="modal fade" id="verifyUrlModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">
                                    <i class="bi bi-link-45deg me-2"></i>Verify URL
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <p><strong>Verify URL cho license:</strong> <code>${safeKey}</code></p>
                                <div class="verify-url mb-3">
                                    <code>${safeUrl}</code>
                                </div>
                                <p class="text-muted mb-0">Sao chép URL này để sử dụng trong ứng dụng khác.</p>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                                <button type="button" class="btn btn-primary" onclick="copyToClipboard('${safeUrl.replace(/'/g, "\\'")}'); if (verifyUrlModalInstance) verifyUrlModalInstance.hide();">
                                    <i class="bi bi-copy"></i> Copy URL
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Xóa modal cũ nếu có
            const oldModal = document.getElementById('verifyUrlModal');
            if (oldModal) oldModal.remove();
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            verifyUrlModalEl = document.getElementById('verifyUrlModal');
            verifyUrlModalInstance = new bootstrap.Modal(verifyUrlModalEl);
            verifyUrlModalInstance.show();
            
            verifyUrlModalEl.addEventListener('hidden.bs.modal', function() {
                verifyUrlModalInstance = null;
                this.remove();
            });
        }

        // Copy license key với visual feedback
        function copyLicenseKey(key, element) {
            if (!key || !element) return;
            
            // Copy to clipboard
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(key).then(() => {
                    // Visual feedback
                    element.classList.add('copied');
                    showToast('Đã sao chép license key vào clipboard!', 'success');
                    
                    // Remove copied class after 1.5 seconds
                    setTimeout(() => {
                        element.classList.remove('copied');
                    }, 1500);
                }).catch(err => {
                    console.error('Error copying to clipboard:', err);
                    fallbackCopyToClipboard(key);
                    // Visual feedback even on fallback
                    element.classList.add('copied');
                    setTimeout(() => {
                        element.classList.remove('copied');
                    }, 1500);
                });
            } else {
                fallbackCopyToClipboard(key);
                // Visual feedback
                element.classList.add('copied');
                setTimeout(() => {
                    element.classList.remove('copied');
                }, 1500);
            }
        }

        // Copy to clipboard
        function copyToClipboard(text) {
            if (!text) return;
            
            // Fallback cho trình duyệt cũ
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(() => {
                    showToast('Đã sao chép vào clipboard!');
                }).catch(err => {
                    console.error('Error copying to clipboard:', err);
                    // Fallback method
                    fallbackCopyToClipboard(text);
                });
            } else {
                fallbackCopyToClipboard(text);
            }
        }

        // Fallback copy method
        function fallbackCopyToClipboard(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            textArea.style.top = '-999999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    showToast('Đã sao chép vào clipboard!');
                } else {
                    showToast('Không thể sao chép. Vui lòng sao chép thủ công.');
                }
            } catch (err) {
                console.error('Fallback copy failed:', err);
                showToast('Không thể sao chép. Vui lòng sao chép thủ công.');
            }
            document.body.removeChild(textArea);
        }

        // Cập nhật live endpoint
        function updateLiveEndpoint() {
            try {
                const endpoint = `${window.location.origin}${window.location.pathname}`;
                const liveEndpointEl = document.getElementById('liveEndpoint');
                const verifyUrlEl = document.getElementById('verifyUrl');
                const apiUrlEl = document.getElementById('apiUrl');
                
                if (liveEndpointEl) {
                    liveEndpointEl.textContent = endpoint + '?verify={LICENSE_KEY}&format=json';
                }
                if (verifyUrlEl) {
                    verifyUrlEl.textContent = endpoint + '?verify={LICENSE_KEY}';
                }
                if (apiUrlEl) {
                    apiUrlEl.textContent = endpoint + '?verify={LICENSE_KEY}&format=json';
                }
            } catch (e) {
                console.error('Error updating live endpoint:', e);
            }
        }

        // Copy endpoint
        function copyEndpoint() {
            copyToClipboard(document.getElementById('liveEndpoint').textContent);
        }

        // Refresh endpoint
        function refreshEndpoint() {
            updateLiveEndpoint();
            showToast('Đã làm mới endpoint!');
        }

        // Test API
        async function testApi() {
            const key = await showModalPrompt('Nhập license key để test API:', 'Test API', '');
            if (!key) return;
            
            // Gọi trực tiếp API function thay vì fetch để tránh CORS và network issues
            try {
                const result = window.verifyLicenseApi(key);
                
                // Hiển thị kết quả trong một modal hoặc alert đẹp hơn
                const resultText = JSON.stringify(result, null, 2);
                
                // Tạo modal để hiển thị kết quả
                const modalHtml = `
                    <div class="modal fade" id="apiTestModal" tabindex="-1">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">
                                        <i class="bi bi-code-slash"></i> API Test Result
                                    </h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="mb-3">
                                        <strong>License Key:</strong> <code>${escapeHtml(key)}</code>
                                    </div>
                                    <div class="mb-3">
                                        <strong>API Response:</strong>
                                        <pre class="bg-light p-3 rounded" style="max-height: 400px; overflow-y: auto;"><code>${escapeHtml(resultText)}</code></pre>
                                    </div>
                                    <div class="mb-2">
                                        <strong>Status:</strong> 
                                        <span class="badge ${result.valid ? (result.status === 'expiring' ? 'bg-warning' : 'bg-success') : 'bg-danger'}">
                                            ${result.valid ? (result.status === 'expiring' ? 'Sắp hết hạn' : 'Hợp lệ') : 'Hết hạn/Không hợp lệ'}
                                        </span>
                                    </div>
                                    ${result.message ? `<div class="mb-2"><strong>Message:</strong> ${escapeHtml(result.message)}</div>` : ''}
                                    ${result.days_remaining !== undefined ? `<div class="mb-2"><strong>Days Remaining:</strong> ${result.days_remaining}</div>` : ''}
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                                    <button type="button" class="btn btn-primary" onclick="copyApiTestResult()">
                                        <i class="bi bi-copy"></i> Copy JSON
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Xóa modal cũ nếu có
                const oldModal = document.getElementById('apiTestModal');
                if (oldModal) {
                    oldModal.remove();
                }
                
                // Thêm modal mới
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                
                // Lưu result vào data attribute để có thể copy sau
                const modalEl = document.getElementById('apiTestModal');
                if (modalEl) {
                    modalEl.setAttribute('data-api-result', resultText);
                }
                
                // Hiển thị modal
                const modal = new bootstrap.Modal(modalEl);
                modal.show();
                
                // Xóa modal khi đóng
                modalEl.addEventListener('hidden.bs.modal', function() {
                    this.remove();
                });
                
            } catch (error) {
                showModalAlert('Lỗi khi test API: ' + escapeHtml(error.message), 'Lỗi', 'error');
                console.error('API test error:', error);
            }
        }

        // Copy API test result
        function copyApiTestResult() {
            const modalEl = document.getElementById('apiTestModal');
            if (!modalEl) return;
            
            const resultText = modalEl.getAttribute('data-api-result');
            if (resultText) {
                copyToClipboard(resultText);
            }
        }


        // API endpoint function (đã được xử lý ở trên trong IIFE)
        window.verifyLicenseApi = function(key) {
            const license = licenses.find(l => l.key === key.toUpperCase());
            const now = new Date();
            
            if (!license) {
                return {
                    valid: false,
                    key: key,
                    status: 'expired',
                    message: 'License không tồn tại',
                    timestamp: now.toISOString()
                };
            }
            
            const status = getLicenseStatus(license.expiry);
            const expiry = new Date(license.expiry);
            
            // Đảm bảo status format đúng với app.py mong đợi
            // app.py kiểm tra: status in ("active", "đang hoạt động", "") thì hợp lệ
            let apiStatus = status.status;
            if (status.valid && status.status !== 'expired') {
                // License hợp lệ (kể cả sắp hết hạn) -> status = "active" để app.py chấp nhận
                apiStatus = 'active';
            } else if (status.status === 'expired') {
                apiStatus = 'expired';
            }
            
            return {
                valid: status.valid,
                key: license.key,
                expiry: license.expiry,
                status: apiStatus,
                message: status.valid ? 
                    (status.status === 'expiring' ? 'License sắp hết hạn' : 'License hợp lệ') : 
                    'License đã hết hạn',
                days_remaining: status.days,
                note: license.note || '',
                timestamp: now.toISOString()
            };
        };

        // Hiển thị toast
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = 'position-fixed bottom-0 end-0 p-3';
            toast.style.zIndex = '11';
            
            const bgColor = type === 'success' ? 'bg-success' : type === 'error' ? 'bg-danger' : type === 'warning' ? 'bg-warning' : 'bg-info';
            const icon = type === 'success' ? 'bi-check-circle' : type === 'error' ? 'bi-x-circle' : type === 'warning' ? 'bi-exclamation-triangle' : 'bi-info-circle';
            const title = type === 'success' ? 'Thành công' : type === 'error' ? 'Lỗi' : type === 'warning' ? 'Cảnh báo' : 'Thông tin';
            
            toast.innerHTML = `
                <div class="toast show" role="alert">
                    <div class="toast-header ${bgColor} text-white">
                        <i class="bi ${icon} me-2"></i>
                        <strong class="me-auto">${title}</strong>
                        <button type="button" class="btn-close btn-close-white" onclick="this.parentElement.parentElement.remove()"></button>
                    </div>
                    <div class="toast-body">
                        ${escapeHtml(message)}
                    </div>
                </div>
            `;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 3000);
        }

        // Hiển thị modal alert thay vì alert()
        function showModalAlert(message, title = 'Thông báo', type = 'info') {
            return new Promise((resolve) => {
                const modalId = 'modalAlert_' + Date.now();
                const iconClass = type === 'error' ? 'bi-x-circle text-danger' : type === 'warning' ? 'bi-exclamation-triangle text-warning' : type === 'success' ? 'bi-check-circle text-success' : 'bi-info-circle text-info';
                
                const modalHtml = `
                    <div class="modal fade" id="${modalId}" tabindex="-1">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">
                                        <i class="bi ${iconClass} me-2"></i>${escapeHtml(title)}
                                    </h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <p>${escapeHtml(message)}</p>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-primary" id="alertOkBtn_${modalId}">OK</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                const modalEl = document.getElementById(modalId);
                const modal = new bootstrap.Modal(modalEl);
                
                // Setup event handler
                const okBtn = document.getElementById('alertOkBtn_' + modalId);
                okBtn.addEventListener('click', function() {
                    modal.hide();
                });
                
                modalEl.addEventListener('hidden.bs.modal', function() {
                    this.remove();
                    resolve(true);
                });
                
                modal.show();
            });
        }

        // Hiển thị modal prompt thay vì prompt()
        function showModalPrompt(message, title = 'Nhập liệu', defaultValue = '') {
            return new Promise((resolve) => {
                const modalId = 'modalPrompt_' + Date.now();
                const inputId = 'promptInput_' + Date.now();
                let resolved = false;
                
                const doResolve = (value) => {
                    if (resolved) return;
                    resolved = true;
                    const modalEl = document.getElementById(modalId);
                    if (modalEl) {
                        const modalInstance = bootstrap.Modal.getInstance(modalEl);
                        if (modalInstance) modalInstance.hide();
                        setTimeout(() => {
                            if (modalEl.parentNode) modalEl.remove();
                        }, 300);
                    }
                    resolve(value);
                };
                
                const modalHtml = `
                    <div class="modal fade" id="${modalId}" tabindex="-1">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">
                                        <i class="bi bi-keyboard me-2"></i>${escapeHtml(title)}
                                    </h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <label class="form-label">${escapeHtml(message)}</label>
                                    <input type="text" class="form-control" id="${inputId}" value="${escapeHtml(defaultValue)}" autofocus>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                                    <button type="button" class="btn btn-primary" id="promptOkBtn">OK</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                const modalEl = document.getElementById(modalId);
                const modal = new bootstrap.Modal(modalEl);
                
                // Setup event handlers
                const inputEl = document.getElementById(inputId);
                const okBtn = document.getElementById('promptOkBtn');
                
                okBtn.addEventListener('click', function() {
                    const value = inputEl.value.trim();
                    doResolve(value || null);
                });
                
                inputEl.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        const value = inputEl.value.trim();
                        doResolve(value || null);
                    }
                });
                
                modalEl.addEventListener('hidden.bs.modal', function() {
                    if (!resolved) {
                        doResolve(null);
                    }
                });
                
                // Show modal và focus input
                modal.show();
                setTimeout(() => {
                    inputEl.focus();
                    inputEl.select();
                }, 300);
            });
        }
    </script>
</body>
</html>