<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>License Manager Pro</title>
    <!-- Bootstrap 5.3.0 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons 1.8.1 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <!-- QRCode.js 1.5.3 -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <style>
        :root {
            --primary: #667eea;
            --secondary: #764ba2;
            --success: #28a745;
            --danger: #dc3545;
            --warning: #ffc107;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            min-height: 100vh;
            padding: 20px 0;
        }

        .main-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
            overflow: hidden;
            margin-bottom: 30px;
        }

        .header-section {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 25px 0;
            position: relative;
            overflow: hidden;
        }

        .header-section::after {
            content: '';
            position: absolute;
            bottom: -20px;
            left: 0;
            right: 0;
            height: 40px;
            background: white;
            transform: skewY(-2deg);
            transform-origin: top left;
        }

        .nav-tabs {
            border-bottom: none;
            padding: 0 20px;
        }

        .nav-tabs .nav-link {
            border: none;
            color: #6c757d;
            font-weight: 500;
            padding: 12px 20px;
            border-radius: 10px 10px 0 0;
            margin-right: 5px;
            transition: all 0.3s;
        }

        .nav-tabs .nav-link:hover {
            background-color: rgba(102, 126, 234, 0.1);
        }

        .nav-tabs .nav-link.active {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .license-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 1px solid #dee2e6;
            border-left: 5px solid var(--primary);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .license-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        .license-key {
            font-family: 'Courier New', monospace;
            font-weight: bold;
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 5px;
            padding: 8px 12px;
            display: inline-block;
            margin: 5px 0;
        }

        .status-badge {
            border-radius: 20px;
            padding: 5px 15px;
            font-size: 0.85em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .time-remaining {
            font-family: 'Courier New', monospace;
            font-weight: bold;
            border: 1px dashed #6c757d;
            border-radius: 5px;
            padding: 5px 10px;
            display: inline-block;
        }

        .stats-card {
            border-radius: 10px;
            padding: 20px;
            color: white;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .stats-card.valid {
            background: linear-gradient(135deg, var(--success) 0%, #20c997 100%);
        }

        .stats-card.expiring {
            background: linear-gradient(135deg, var(--warning) 0%, #ffca2c 100%);
        }

        .stats-card.expired {
            background: linear-gradient(135deg, var(--danger) 0%, #c82333 100%);
        }

        .code-block {
            background: #2c3e50;
            color: #ecf0f1;
            font-family: 'Courier New', monospace;
            padding: 15px;
            border-radius: 8px;
            font-size: 14px;
            overflow-x: auto;
            max-height: 300px;
            overflow-y: auto;
        }

        .keyword { color: #5dade2; }
        .function { color: #52be80; }
        .string { color: #ec7063; }
        .comment { color: #52be80; }
        .number { color: #f39c12; }

        .qr-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .api-endpoint-box {
            border: 2px dashed #6c757d;
            border-radius: 8px;
            padding: 15px;
            background: #f8f9fa;
            font-family: 'Courier New', monospace;
            word-break: break-all;
        }

        .response-box {
            max-height: 400px;
            overflow-y: auto;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }

        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1050;
        }

        .toast {
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            border-left: 5px solid var(--primary);
        }

        .tab-content {
            padding: 25px;
        }

        @media (max-width: 768px) {
            .nav-tabs .nav-link {
                padding: 10px 15px;
                font-size: 0.9em;
            }
            
            .license-card {
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <!-- API MODE DETECTION - CHẠY ĐẦU TIÊN -->
    <script>
        (function() {
            const urlParams = new URLSearchParams(window.location.search);
            const apiMode = urlParams.get('api');
            const key = urlParams.get('key');
            
            // Nếu có tham số api=true hoặc key, trả về JSON NGAY LẬP TỨC
            if (apiMode === 'true' || key) {
                // Ngăn chặn render HTML
                document.open();
                document.close();
                
                // Lấy data từ localStorage
                const storageKey = 'licenseManagerDataV3';
                let licenses = [];
                try {
                    const data = localStorage.getItem(storageKey);
                    if (data) licenses = JSON.parse(data);
                } catch (e) {
                    licenses = [];
                }
                
                // Verify logic
                function verifyKey(key) {
                    const now = new Date();
                    
                    if (!key) {
                        return {
                            success: false,
                            valid: false,
                            message: 'Thiếu license key',
                            timestamp: now.toISOString(),
                            request_id: `req_${Date.now()}`
                        };
                    }
                    
                    const license = licenses.find(l => l.key.toUpperCase() === key.toUpperCase());
                    
                    if (!license) {
                        return {
                            success: false,
                            valid: false,
                            key: key,
                            message: 'License không tồn tại',
                            timestamp: now.toISOString(),
                            request_id: `req_${Date.now()}`
                        };
                    }
                    
                    const expiry = new Date(license.expiry);
                    const diffMs = expiry - now;
                    const diffDays = Math.ceil(diffMs / (1000 * 60 * 60 * 24));
                    
                    let status = 'expired';
                    let valid = false;
                    
                    if (diffMs > 0) {
                        valid = true;
                        status = diffDays <= 7 ? 'expiring' : 'valid';
                    }
                    
                    // Format time remaining
                    let timeRemaining = 'Đã hết hạn';
                    if (diffMs > 0) {
                        const days = Math.floor(diffMs / (1000 * 60 * 60 * 24));
                        const hours = Math.floor((diffMs % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                        timeRemaining = days > 0 ? `${days} ngày ${hours} giờ` : `${hours} giờ`;
                    }
                    
                    return {
                        success: true,
                        valid: valid,
                        key: license.key,
                        expiry: license.expiry,
                        status: status,
                        message: valid ? 
                            (status === 'expiring' ? 'License sắp hết hạn' : 'License hợp lệ') : 
                            'License đã hết hạn',
                        days_remaining: diffDays,
                        time_remaining: timeRemaining,
                        note: license.note || '',
                        timestamp: now.toISOString(),
                        created: license.created,
                        request_id: `req_${Date.now()}`
                    };
                }
                
                // Trả về JSON
                const result = verifyKey(key);
                document.body.innerHTML = '<pre style="font-family: monospace; white-space: pre-wrap; word-wrap: break-word;">' + 
                                           JSON.stringify(result, null, 2) + 
                                           '</pre>';
                
                // Ngăn chặn code khác chạy
                throw new Error('API_MODE');
            }
        })();
    </script>

    <div class="container main-container">
        <!-- Header -->
        <div class="header-section">
            <div class="container">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h1 class="display-5 fw-bold mb-3">
                            <i class="bi bi-shield-check me-3"></i>License Manager Pro
                        </h1>
                        <p class="lead mb-0">Quản lý, xác thực và tích hợp license đơn giản, mạnh mẽ</p>
                    </div>
                    <div class="col-md-4 text-end">
                        <button class="btn btn-light btn-lg" id="addLicenseBtn">
                            <i class="bi bi-plus-circle me-2"></i>Thêm License
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <ul class="nav nav-tabs" id="mainTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="tab1-tab" data-bs-toggle="tab" data-bs-target="#tab1" type="button" role="tab">
                    <i class="bi bi-list-check me-2"></i>Quản lý License
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="tab2-tab" data-bs-toggle="tab" data-bs-target="#tab2" type="button" role="tab">
                    <i class="bi bi-search me-2"></i>Verify License
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="tab3-tab" data-bs-toggle="tab" data-bs-target="#tab3" type="button" role="tab">
                    <i class="bi bi-code-slash me-2"></i>API & Integration
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="tab4-tab" data-bs-toggle="tab" data-bs-target="#tab4" type="button" role="tab">
                    <i class="bi bi-link-45deg me-2"></i>Live API Endpoint
                </button>
            </li>
        </ul>

        <!-- Tab Contents -->
        <div class="tab-content" id="tabContent">
            <!-- Tab 1: Quản lý License -->
            <div class="tab-pane fade show active" id="tab1" role="tabpanel">
                <!-- Search and Filter -->
                <div class="row mb-4">
                    <div class="col-md-8">
                        <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-search"></i></span>
                            <input type="text" class="form-control" id="searchInput" placeholder="Tìm kiếm license theo key hoặc note...">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <select class="form-select" id="statusFilter">
                            <option value="all">Tất cả trạng thái</option>
                            <option value="valid">Còn hạn</option>
                            <option value="expiring">Sắp hết hạn</option>
                            <option value="expired">Hết hạn</option>
                        </select>
                    </div>
                </div>

                <!-- Stats Cards -->
                <div class="row mb-4">
                    <div class="col-md-4">
                        <div class="stats-card valid">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h3 class="mb-0" id="validCount">0</h3>
                                    <p class="mb-0">Còn hạn</p>
                                </div>
                                <i class="bi bi-check-circle" style="font-size: 2.5rem;"></i>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="stats-card expiring">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h3 class="mb-0" id="expiringCount">0</h3>
                                    <p class="mb-0">Sắp hết hạn</p>
                                </div>
                                <i class="bi bi-exclamation-triangle" style="font-size: 2.5rem;"></i>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="stats-card expired">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h3 class="mb-0" id="expiredCount">0</h3>
                                    <p class="mb-0">Hết hạn</p>
                                </div>
                                <i class="bi bi-x-circle" style="font-size: 2.5rem;"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- License List -->
                <div id="licenseList"></div>
                
                <!-- Empty State -->
                <div id="emptyState" class="text-center py-5 d-none">
                    <i class="bi bi-key" style="font-size: 4rem; color: #6c757d;"></i>
                    <h3 class="mt-3">Chưa có license nào</h3>
                    <p class="text-muted">Bắt đầu bằng cách thêm license đầu tiên của bạn</p>
                    <button class="btn btn-primary btn-lg" id="addFirstLicenseBtn">
                        <i class="bi bi-plus-circle me-2"></i>Thêm License
                    </button>
                </div>
            </div>

            <!-- Tab 2: Verify License -->
            <div class="tab-pane fade" id="tab2" role="tabpanel">
                <div class="row">
                    <div class="col-lg-6 mb-4">
                        <div class="card">
                            <div class="card-header bg-primary text-white">
                                <h5 class="mb-0"><i class="bi bi-search me-2"></i>Verify License</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label">License Key</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="verifyKeyInput" placeholder="Nhập license key...">
                                        <button class="btn btn-outline-secondary" type="button" id="verifyBtn">Verify</button>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <p class="mb-2">Test nhanh:</p>
                                    <button class="btn btn-sm btn-outline-primary me-2" id="testKey1Btn">LIC-WBB61UL-F700</button>
                                    <button class="btn btn-sm btn-outline-primary" id="testKey2Btn">LICC-WBB61_ULF_F700</button>
                                </div>
                                
                                <div id="verifyResult" class="d-none">
                                    <div class="alert" id="verifyAlert">
                                        <h5 class="alert-heading" id="verifyTitle"></h5>
                                        <hr>
                                        <p class="mb-1"><strong>License Key:</strong> <span id="verifyResultKey" class="license-key"></span></p>
                                        <p class="mb-1"><strong>Ngày hết hạn:</strong> <span id="verifyExpiry"></span></p>
                                        <p class="mb-1"><strong>Trạng thái:</strong> <span id="verifyStatus" class="status-badge"></span></p>
                                        <p class="mb-1"><strong>Thời gian còn lại:</strong> <span id="verifyTimeRemaining" class="time-remaining"></span></p>
                                        <p class="mb-1"><strong>Ghi chú:</strong> <span id="verifyNote"></span></p>
                                        <hr>
                                        <p class="mb-0 small"><strong>Request ID:</strong> <span id="verifyRequestId"></span></p>
                                        <p class="mb-0 small"><strong>Timestamp:</strong> <span id="verifyTimestamp"></span></p>
                                    </div>
                                    
                                    <div class="mt-3">
                                        <label class="form-label">API Endpoint URL</label>
                                        <div class="input-group">
                                            <input type="text" class="form-control api-endpoint-box" id="verifyEndpointUrl" readonly>
                                            <button class="btn btn-outline-secondary" type="button" onclick="copyToClipboard('verifyEndpointUrl')">
                                                <i class="bi bi-clipboard"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-lg-6 mb-4">
                        <div class="card">
                            <div class="card-header bg-success text-white">
                                <h5 class="mb-0"><i class="bi bi-qr-code-scan me-2"></i>QR Code Generator</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label">License Key</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="qrKeyInput" placeholder="Nhập license key để tạo QR...">
                                        <button class="btn btn-success" type="button" id="generateQrBtn">Generate QR</button>
                                    </div>
                                </div>
                                
                                <div class="qr-container" id="qrContainer">
                                    <p class="text-muted">QR Code sẽ hiển thị ở đây</p>
                                </div>
                                
                                <div class="mt-3 text-center" id="qrActions" style="display: none;">
                                    <button class="btn btn-outline-primary me-2" id="downloadQrBtn">
                                        <i class="bi bi-download me-2"></i>Download QR
                                    </button>
                                    <button class="btn btn-outline-secondary" id="copyQrUrlBtn">
                                        <i class="bi bi-clipboard me-2"></i>Copy URL
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab 3: API & Integration -->
            <div class="tab-pane fade" id="tab3" role="tabpanel">
                <div class="row">
                    <div class="col-lg-7 mb-4">
                        <div class="card">
                            <div class="card-header bg-dark text-white">
                                <h5 class="mb-0"><i class="bi bi-code-slash me-2"></i>API Test Console</h5>
                            </div>
                            <div class="card-body">
                                <div class="alert alert-success">
                                    <i class="bi bi-check-circle-fill me-2"></i>Đã fix lỗi JSON parse - API endpoint trả về pure JSON
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Test License Key</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="testApiKey" value="LIC-WBB61UL-F700" placeholder="Nhập license key để test...">
                                        <button class="btn btn-primary" type="button" id="testApiBtn">Test API</button>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">API Response</label>
                                    <div class="response-box">
                                        <pre id="apiResponse">Kết quả sẽ hiển thị ở đây...</pre>
                                    </div>
                                </div>
                                
                                <div class="d-flex gap-2">
                                    <button class="btn btn-outline-success" id="copyResponseBtn">
                                        <i class="bi bi-clipboard me-2"></i>Copy Response
                                    </button>
                                    <button class="btn btn-outline-secondary" id="clearResponseBtn">
                                        <i class="bi bi-trash me-2"></i>Clear
                                    </button>
                                </div>
                                
                                <div class="mt-4">
                                    <h6><i class="bi bi-info-circle me-2"></i>API Response Format</h6>
                                    <div class="code-block">
<span class="comment">// Success Response:</span>
{
  "success": <span class="keyword">true</span>,
  "valid": <span class="keyword">true</span>,
  "key": <span class="string">"LIC-WBB61UL-F700"</span>,
  "expiry": <span class="string">"2027-12-31T23:59:59.000Z"</span>,
  "status": <span class="string">"valid"</span>,
  "message": <span class="string">"License hợp lệ"</span>,
  "days_remaining": <span class="number">1234</span>,
  "time_remaining": <span class="string">"1234 ngày 5 giờ"</span>,
  "note": <span class="string">"Ghi chú license"</span>,
  "timestamp": <span class="string">"2024-01-01T10:30:00.000Z"</span>,
  "created": <span class="string">"2023-01-01T00:00:00.000Z"</span>,
  "request_id": <span class="string">"req_1700000000000"</span>
}

<span class="comment">// Error Response:</span>
{
  "success": <span class="keyword">false</span>,
  "valid": <span class="keyword">false</span>,
  "message": <span class="string">"License không tồn tại"</span>,
  "timestamp": <span class="string">"2024-01-01T10:30:00.000Z"</span>,
  "request_id": <span class="string">"req_1700000000000"</span>
}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-lg-5 mb-4">
                        <div class="card">
                            <div class="card-header bg-info text-white">
                                <h5 class="mb-0"><i class="bi bi-book me-2"></i>Integration Guide</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-4">
                                    <h6>API Endpoint</h6>
                                    <div class="code-block">
<span class="comment">// Base URL</span>
<span class="string">http://your-domain.com/license-manager.html?api=true&key=</span><span class="keyword">{LICENSE_KEY}</span>
                                    </div>
                                </div>
                                
                                <div class="mb-4">
                                    <h6>JavaScript Fetch Example</h6>
                                    <div class="code-block">
<span class="keyword">async</span> <span class="function">function</span> <span class="function">verifyLicense</span>(key) {
  <span class="keyword">const</span> apiUrl = <span class="string">`license-manager.html?api=true&key=${key}`</span>;
  
  <span class="keyword">try</span> {
    <span class="keyword">const</span> response = <span class="keyword">await</span> <span class="function">fetch</span>(apiUrl);
    <span class="keyword">const</span> data = <span class="keyword">await</span> response.<span class="function">json</span>();
    
    <span class="keyword">if</span> (data.valid) {
      <span class="function">console</span>.<span class="function">log</span>(<span class="string">'License hợp lệ'</span>);
      <span class="comment">// Xử lý khi hợp lệ</span>
    } <span class="keyword">else</span> {
      <span class="function">console</span>.<span class="function">log</span>(<span class="string">'License không hợp lệ:'</span>, data.message);
      <span class="comment">// Xử lý khi không hợp lệ</span>
    }
  } <span class="keyword">catch</span> (error) {
    <span class="function">console</span>.<span class="function">error</span>(<span class="string">'Lỗi khi gọi API:'</span>, error);
  }
}
                                    </div>
                                </div>
                                
                                <div class="mb-4">
                                    <h6>Python Requests Example</h6>
                                    <div class="code-block">
<span class="keyword">import</span> requests

<span class="function">def</span> <span class="function">verify_license</span>(key):
    api_url = <span class="string">f"license-manager.html?api=true&key={key}"</span>
    
    <span class="keyword">try</span>:
        response = requests.<span class="function">get</span>(api_url)
        data = response.<span class="function">json</span>()
        
        <span class="keyword">if</span> data[<span class="string">'valid'</span>]:
            <span class="function">print</span>(<span class="string">'License hợp lệ'</span>)
            <span class="comment"># Xử lý khi hợp lệ</span>
        <span class="keyword">else</span>:
            <span class="function">print</span>(<span class="string">f'License không hợp lệ: {data["message"]}'</span>)
            <span class="comment"># Xử lý khi không hợp lệ</span>
    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:
        <span class="function">print</span>(<span class="string">f'Lỗi khi gọi API: {e}'</span>)
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab 4: Live API Endpoint -->
            <div class="tab-pane fade" id="tab4" role="tabpanel">
                <div class="row">
                    <div class="col-lg-8 mb-4">
                        <div class="card">
                            <div class="card-header bg-warning text-dark">
                                <h5 class="mb-0"><i class="bi bi-link-45deg me-2"></i>Live API Endpoint</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label">Primary API Endpoint</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control api-endpoint-box" id="primaryApiEndpoint" readonly>
                                        <button class="btn btn-warning" type="button" onclick="copyToClipboard('primaryApiEndpoint')">
                                            <i class="bi bi-clipboard"></i>
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="row mb-4">
                                    <div class="col-md-4">
                                        <div class="card h-100">
                                            <div class="card-body text-center">
                                                <i class="bi bi-browser-chrome text-primary" style="font-size: 2rem;"></i>
                                                <h5 class="mt-3">Browser Test</h5>
                                                <p class="text-muted small">Mở API endpoint trong tab mới</p>
                                                <button class="btn btn-outline-primary btn-sm" id="browserTestBtn">
                                                    <i class="bi bi-box-arrow-up-right me-1"></i>Test ngay
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="card h-100">
                                            <div class="card-body text-center">
                                                <i class="bi bi-terminal text-success" style="font-size: 2rem;"></i>
                                                <h5 class="mt-3">cURL Command</h5>
                                                <p class="text-muted small">Test từ terminal</p>
                                                <button class="btn btn-outline-success btn-sm" id="curlTestBtn">
                                                    <i class="bi bi-terminal me-1"></i>Xem command
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="card h-100">
                                            <div class="card-body text-center">
                                                <i class="bi bi-send-check text-info" style="font-size: 2rem;"></i>
                                                <h5 class="mt-3">Postman</h5>
                                                <p class="text-muted small">Import vào Postman</p>
                                                <button class="btn btn-outline-info btn-sm" id="postmanBtn">
                                                    <i class="bi bi-send me-1"></i>Hướng dẫn
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <p class="mb-2">Quick Test:</p>
                                    <button class="btn btn-sm btn-success me-2" id="quickTestValidBtn">
                                        <i class="bi bi-check-circle me-1"></i>Test với valid key
                                    </button>
                                    <button class="btn btn-sm btn-danger me-2" id="quickTestInvalidBtn">
                                        <i class="bi bi-x-circle me-1"></i>Test với invalid key
                                    </button>
                                    <button class="btn btn-sm btn-secondary" id="quickTestNoKeyBtn">
                                        <i class="bi bi-question-circle me-1"></i>Test không có key
                                    </button>
                                </div>
                                
                                <div class="mt-4">
                                    <h6>Quick Test Result</h6>
                                    <div class="response-box">
                                        <pre id="quickTestResult">Kết quả test sẽ hiển thị ở đây...</pre>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-lg-4 mb-4">
                        <div class="card h-100">
                            <div class="card-header bg-success text-white">
                                <h5 class="mb-0"><i class="bi bi-activity me-2"></i>API Status</h5>
                            </div>
                            <div class="card-body">
                                <div class="text-center mb-4">
                                    <div id="apiStatusIndicator" class="mb-3">
                                        <i class="bi bi-check-circle-fill text-success" style="font-size: 3rem;"></i>
                                    </div>
                                    <h4 id="apiStatusText">API đang hoạt động</h4>
                                    <p class="text-muted">Tất cả endpoint đều sẵn sàng</p>
                                    <button class="btn btn-outline-success" id="refreshApiStatusBtn">
                                        <i class="bi bi-arrow-clockwise me-2"></i>Kiểm tra lại
                                    </button>
                                </div>
                                
                                <hr>
                                
                                <h6><i class="bi bi-graph-up me-2"></i>API Usage Stats</h6>
                                <div class="mb-3">
                                    <p class="mb-1">Total Requests: <strong id="totalRequests">0</strong></p>
                                    <p class="mb-1">Success Rate:</p>
                                    <div class="progress">
                                        <div class="progress-bar bg-success" id="successRateBar" style="width: 100%"></div>
                                    </div>
                                    <small class="text-muted" id="successRateText">100% thành công</small>
                                </div>
                                
                                <div class="mt-4">
                                    <h6><i class="bi bi-info-circle me-2"></i>Thông tin</h6>
                                    <ul class="small text-muted">
                                        <li>API endpoint trả về JSON thuần túy</li>
                                        <li>Không còn lỗi "Unexpected token '<'"</li>
                                        <li>Xử lý CORS tự động</li>
                                        <li>Real-time verification</li>
                                        <li>Data lưu trong localStorage</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- License Modal -->
    <div class="modal fade" id="licenseModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">Thêm License</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="licenseForm">
                        <div class="mb-3">
                            <label class="form-label">License Key <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="licenseKey" 
                                       pattern="[A-Z0-9\-_]{5,50}" 
                                       placeholder="VD: LIC-XXXXXX-XXXX" required>
                                <button class="btn btn-outline-secondary" type="button" id="generateKeyBtn">
                                    <i class="bi bi-shuffle"></i> Generate
                                </button>
                            </div>
                            <div class="form-text">Chỉ chữ hoa, số, dấu gạch ngang và gạch dưới, 5-50 ký tự</div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Ngày hết hạn <span class="text-danger">*</span></label>
                            <input type="datetime-local" class="form-control" id="expiryDate" required>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Quick Set Expiry</label>
                            <div class="d-flex gap-2">
                                <button type="button" class="btn btn-outline-primary btn-sm" id="expiry30Btn">30 ngày</button>
                                <button type="button" class="btn btn-outline-primary btn-sm" id="expiry90Btn">90 ngày</button>
                                <button type="button" class="btn btn-outline-primary btn-sm" id="expiry1YearBtn">1 năm</button>
                                <button type="button" class="btn btn-outline-danger btn-sm" id="expiryNowBtn">Hết hạn ngay</button>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Ghi chú (tùy chọn)</label>
                            <textarea class="form-control" id="licenseNote" rows="3" placeholder="Ghi chú về license..."></textarea>
                        </div>
                        
                        <div class="card mb-3">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">Live Preview</h6>
                            </div>
                            <div class="card-body">
                                <div id="licensePreview">
                                    <p class="text-muted mb-1">Thông tin sẽ hiển thị sau khi nhập</p>
                                    <p class="mb-1"><strong>Status:</strong> <span id="previewStatus" class="status-badge">-</span></p>
                                    <p class="mb-0"><strong>Time Remaining:</strong> <span id="previewTimeRemaining" class="time-remaining">-</span></p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="alert alert-danger d-none" id="licenseError"></div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="button" class="btn btn-primary" id="saveLicenseBtn">Lưu License</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container"></div>

    <!-- Bootstrap JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // ========== GLOBAL VARIABLES ==========
        const STORAGE_KEY = 'licenseManagerDataV3';
        let licenses = [];
        let editIndex = -1;
        let countdownInterval = null;
        let apiStats = {
            totalRequests: 0,
            successRequests: 0,
            errorRequests: 0
        };

        // ========== HELPER FUNCTIONS ==========
        
        function formatDateTime(date) {
            if (!(date instanceof Date)) {
                date = new Date(date);
            }
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const seconds = String(date.getSeconds()).padStart(2, '0');
            return `${day}/${month}/${year} ${hours}:${minutes}:${seconds}`;
        }

        function formatTimeRemaining(milliseconds) {
            if (milliseconds <= 0) {
                return 'Đã hết hạn';
            }
            
            const days = Math.floor(milliseconds / (1000 * 60 * 60 * 24));
            const hours = Math.floor((milliseconds % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((milliseconds % (1000 * 60 * 60)) / (1000 * 60));
            
            if (days > 0) {
                return `${days} ngày ${hours} giờ`;
            } else if (hours > 0) {
                return `${hours} giờ ${minutes} phút`;
            } else {
                return `${minutes} phút`;
            }
        }

        function getLicenseStatus(expiryDate) {
            const now = new Date();
            const expiry = new Date(expiryDate);
            const diffMs = expiry - now;
            const diffDays = Math.ceil(diffMs / (1000 * 60 * 60 * 24));
            
            if (diffMs <= 0) {
                return { status: 'expired', days: diffDays, valid: false };
            } else if (diffDays <= 7) {
                return { status: 'expiring', days: diffDays, valid: true };
            } else {
                return { status: 'valid', days: diffDays, valid: true };
            }
        }

        function copyToClipboard(elementId) {
            const element = document.getElementById(elementId);
            element.select();
            element.setSelectionRange(0, 99999);
            try {
                navigator.clipboard.writeText(element.value);
                showToast('Đã sao chép vào clipboard!', 'success');
            } catch (err) {
                // Fallback for older browsers
                document.execCommand('copy');
                showToast('Đã sao chép vào clipboard!', 'success');
            }
        }

        function showToast(message, type = 'info') {
            const toastContainer = document.querySelector('.toast-container');
            const toastId = 'toast-' + Date.now();
            
            const toastHtml = `
                <div id="${toastId}" class="toast" role="alert">
                    <div class="toast-header">
                        <i class="bi ${type === 'success' ? 'bi-check-circle-fill text-success' : type === 'error' ? 'bi-x-circle-fill text-danger' : 'bi-info-circle-fill text-primary'} me-2"></i>
                        <strong class="me-auto">Thông báo</strong>
                        <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
                    </div>
                    <div class="toast-body">
                        ${message}
                    </div>
                </div>
            `;
            
            toastContainer.insertAdjacentHTML('beforeend', toastHtml);
            const toastElement = document.getElementById(toastId);
            const toast = new bootstrap.Toast(toastElement, { delay: 3000 });
            toast.show();
            
            // Remove toast after it's hidden
            toastElement.addEventListener('hidden.bs.toast', function () {
                toastElement.remove();
            });
        }

        function generateLicenseKey() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            const prefix = 'LIC-';
            let key = prefix;
            
            // Generate first segment (6 chars)
            for (let i = 0; i < 6; i++) {
                key += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            
            key += '-';
            
            // Generate second segment (4 chars)
            for (let i = 0; i < 4; i++) {
                key += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            
            return key;
        }

        function saveLicenses() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(licenses));
        }

        function loadLicenses() {
            try {
                const data = localStorage.getItem(STORAGE_KEY);
                if (data) {
                    licenses = JSON.parse(data);
                    
                    // Initialize sample data if empty
                    if (licenses.length === 0) {
                        const now = new Date();
                        const sample1 = new Date('2027-12-31T23:59:59');
                        const sample2 = new Date('2026-10-12T23:59:59');
                        
                        licenses = [
                            {
                                key: 'LIC-WBB61UL-F700',
                                expiry: sample1.toISOString(),
                                note: 'Quản lý chăm sóc khách hàng công ty DMI',
                                created: now.toISOString(),
                                updated: now.toISOString()
                            },
                            {
                                key: 'LICC-WBB61_ULF_F700',
                                expiry: sample2.toISOString(),
                                note: 'License đặc biệt cho dự án WBB61',
                                created: now.toISOString(),
                                updated: now.toISOString()
                            }
                        ];
                        saveLicenses();
                    }
                } else {
                    licenses = [];
                }
            } catch (error) {
                console.error('Error loading licenses:', error);
                licenses = [];
                showToast('Lỗi khi tải dữ liệu, đã khởi tạo dữ liệu mẫu', 'error');
            }
        }

        function updateStats() {
            let validCount = 0;
            let expiringCount = 0;
            let expiredCount = 0;
            
            licenses.forEach(license => {
                const status = getLicenseStatus(license.expiry);
                if (status.status === 'valid') validCount++;
                else if (status.status === 'expiring') expiringCount++;
                else if (status.status === 'expired') expiredCount++;
            });
            
            document.getElementById('validCount').textContent = validCount;
            document.getElementById('expiringCount').textContent = expiringCount;
            document.getElementById('expiredCount').textContent = expiredCount;
        }

        function renderLicenses(searchTerm = '', statusFilter = 'all') {
            const licenseList = document.getElementById('licenseList');
            const emptyState = document.getElementById('emptyState');
            
            if (licenses.length === 0) {
                licenseList.innerHTML = '';
                emptyState.classList.remove('d-none');
                return;
            }
            
            emptyState.classList.add('d-none');
            
            let filteredLicenses = licenses.filter(license => {
                // Search filter
                const matchesSearch = searchTerm === '' || 
                    license.key.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    (license.note && license.note.toLowerCase().includes(searchTerm.toLowerCase()));
                
                if (!matchesSearch) return false;
                
                // Status filter
                if (statusFilter === 'all') return true;
                
                const status = getLicenseStatus(license.expiry);
                return status.status === statusFilter;
            });
            
            if (filteredLicenses.length === 0) {
                licenseList.innerHTML = `
                    <div class="text-center py-5">
                        <i class="bi bi-search" style="font-size: 3rem; color: #6c757d;"></i>
                        <h4 class="mt-3">Không tìm thấy license nào</h4>
                        <p class="text-muted">Thử lại với từ khóa tìm kiếm khác hoặc bộ lọc khác</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            filteredLicenses.forEach((license, index) => {
                const status = getLicenseStatus(license.expiry);
                const expiryDate = new Date(license.expiry);
                const now = new Date();
                const timeRemaining = expiryDate - now;
                
                let statusClass = '';
                let statusText = '';
                
                switch (status.status) {
                    case 'valid':
                        statusClass = 'bg-success text-white';
                        statusText = 'CÒN HẠN';
                        break;
                    case 'expiring':
                        statusClass = 'bg-warning text-dark';
                        statusText = 'SẮP HẾT';
                        break;
                    case 'expired':
                        statusClass = 'bg-danger text-white';
                        statusText = 'HẾT HẠN';
                        break;
                }
                
                html += `
                    <div class="license-card">
                        <div class="row align-items-center">
                            <div class="col-md-1 text-center">
                                <span class="badge bg-secondary">${index + 1}</span>
                            </div>
                            <div class="col-md-3">
                                <div class="license-key">${license.key}</div>
                            </div>
                            <div class="col-md-2">
                                <small class="text-muted">Ngày tạo:</small><br>
                                ${formatDateTime(license.created)}
                            </div>
                            <div class="col-md-2">
                                <small class="text-muted">Hết hạn:</small><br>
                                ${formatDateTime(license.expiry)}
                            </div>
                            <div class="col-md-2">
                                <span class="status-badge ${statusClass}">${statusText}</span><br>
                                <small class="time-remaining">${formatTimeRemaining(timeRemaining)}</small>
                            </div>
                            <div class="col-md-2 text-end">
                                <button class="btn btn-sm btn-outline-primary me-1" onclick="editLicense(${index})">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger me-1" onclick="deleteLicense(${index})">
                                    <i class="bi bi-trash"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-success" onclick="copyApiUrl('${license.key}')">
                                    <i class="bi bi-link-45deg"></i>
                                </button>
                            </div>
                        </div>
                        ${license.note ? `
                        <div class="row mt-3">
                            <div class="col-12">
                                <small class="text-muted">Ghi chú:</small>
                                <p class="mb-0">${license.note}</p>
                            </div>
                        </div>
                        ` : ''}
                    </div>
                `;
            });
            
            licenseList.innerHTML = html;
        }

        function editLicense(index) {
            editIndex = index;
            const license = licenses[index];
            
            document.getElementById('modalTitle').textContent = 'Chỉnh sửa License';
            document.getElementById('licenseKey').value = license.key;
            document.getElementById('licenseKey').readOnly = true; // Không cho sửa key khi edit
            document.getElementById('expiryDate').value = license.expiry.substring(0, 16);
            document.getElementById('licenseNote').value = license.note || '';
            
            updatePreview();
            
            const modal = new bootstrap.Modal(document.getElementById('licenseModal'));
            modal.show();
        }

        function deleteLicense(index) {
            if (confirm('Bạn có chắc chắn muốn xóa license này?')) {
                licenses.splice(index, 1);
                saveLicenses();
                renderLicenses();
                updateStats();
                showToast('Đã xóa license thành công!', 'success');
            }
        }

        function copyApiUrl(key) {
            const url = window.location.origin + window.location.pathname + '?api=true&key=' + key;
            navigator.clipboard.writeText(url).then(() => {
                showToast('Đã sao chép API URL vào clipboard!', 'success');
            }).catch(err => {
                console.error('Failed to copy: ', err);
            });
        }

        function updatePreview() {
            const key = document.getElementById('licenseKey').value;
            const expiry = document.getElementById('expiryDate').value;
            const previewStatus = document.getElementById('previewStatus');
            const previewTimeRemaining = document.getElementById('previewTimeRemaining');
            
            if (!key || !expiry) {
                previewStatus.textContent = '-';
                previewTimeRemaining.textContent = '-';
                return;
            }
            
            const expiryDate = new Date(expiry);
            const now = new Date();
            const timeRemaining = expiryDate - now;
            const status = getLicenseStatus(expiry);
            
            let statusClass = '';
            let statusText = '';
            
            switch (status.status) {
                case 'valid':
                    statusClass = 'bg-success text-white';
                    statusText = 'CÒN HẠN';
                    break;
                case 'expiring':
                    statusClass = 'bg-warning text-dark';
                    statusText = 'SẮP HẾT';
                    break;
                case 'expired':
                    statusClass = 'bg-danger text-white';
                    statusText = 'HẾT HẠN';
                    break;
            }
            
            previewStatus.className = `status-badge ${statusClass}`;
            previewStatus.textContent = statusText;
            previewTimeRemaining.textContent = formatTimeRemaining(timeRemaining);
        }

        function verifyLicenseApi(key) {
            const now = new Date();
            
            if (!key) {
                return {
                    success: false,
                    valid: false,
                    message: 'Thiếu license key',
                    timestamp: now.toISOString(),
                    request_id: `req_${Date.now()}`
                };
            }
            
            const license = licenses.find(l => l.key.toUpperCase() === key.toUpperCase());
            
            if (!license) {
                return {
                    success: false,
                    valid: false,
                    key: key,
                    message: 'License không tồn tại',
                    timestamp: now.toISOString(),
                    request_id: `req_${Date.now()}`
                };
            }
            
            const expiry = new Date(license.expiry);
            const diffMs = expiry - now;
            const diffDays = Math.ceil(diffMs / (1000 * 60 * 60 * 24));
            
            let status = 'expired';
            let valid = false;
            
            if (diffMs > 0) {
                valid = true;
                status = diffDays <= 7 ? 'expiring' : 'valid';
            }
            
            return {
                success: true,
                valid: valid,
                key: license.key,
                expiry: license.expiry,
                status: status,
                message: valid ? 
                    (status === 'expiring' ? 'License sắp hết hạn' : 'License hợp lệ') : 
                    'License đã hết hạn',
                days_remaining: diffDays,
                time_remaining: formatTimeRemaining(diffMs),
                note: license.note || '',
                timestamp: now.toISOString(),
                created: license.created,
                request_id: `req_${Date.now()}`
            };
        }

        function generateQrCode(key) {
            const qrContainer = document.getElementById('qrContainer');
            const qrActions = document.getElementById('qrActions');
            const apiUrl = window.location.origin + window.location.pathname + '?api=true&key=' + key;
            
            qrContainer.innerHTML = '';
            
            if (!key) {
                qrContainer.innerHTML = '<p class="text-danger">Vui lòng nhập license key</p>';
                qrActions.style.display = 'none';
                return;
            }
            
            const canvas = document.createElement('canvas');
            qrContainer.appendChild(canvas);
            
            QRCode.toCanvas(canvas, apiUrl, {
                width: 200,
                margin: 1,
                color: {
                    dark: '#000000',
                    light: '#FFFFFF'
                }
            }, function (error) {
                if (error) {
                    console.error(error);
                    qrContainer.innerHTML = '<p class="text-danger">Lỗi khi tạo QR code</p>';
                    qrActions.style.display = 'none';
                } else {
                    qrContainer.innerHTML = '';
                    qrContainer.appendChild(canvas);
                    
                    const urlText = document.createElement('p');
                    urlText.className = 'mt-3 small';
                    urlText.innerHTML = `<code>${apiUrl}</code>`;
                    qrContainer.appendChild(urlText);
                    
                    qrActions.style.display = 'block';
                    
                    // Setup download button
                    document.getElementById('downloadQrBtn').onclick = function() {
                        const link = document.createElement('a');
                        link.download = `license-qr-${key}.png`;
                        link.href = canvas.toDataURL('image/png');
                        link.click();
                    };
                    
                    // Setup copy URL button
                    document.getElementById('copyQrUrlBtn').onclick = function() {
                        navigator.clipboard.writeText(apiUrl).then(() => {
                            showToast('Đã sao chép API URL vào clipboard!', 'success');
                        });
                    };
                }
            });
        }

        function updateCountdowns() {
            const timeElements = document.querySelectorAll('.time-remaining');
            timeElements.forEach(element => {
                // This function will be implemented to update countdowns in real-time
                // For now, we'll rely on re-rendering
            });
        }

        function updatePrimaryEndpoint() {
            const endpoint = window.location.origin + window.location.pathname + '?api=true&key={LICENSE_KEY}';
            document.getElementById('primaryApiEndpoint').value = endpoint;
        }

        function updateApiStats() {
            apiStats.totalRequests = localStorage.getItem('apiTotalRequests') || 0;
            apiStats.successRequests = localStorage.getItem('apiSuccessRequests') || 0;
            
            const total = parseInt(apiStats.totalRequests);
            const success = parseInt(apiStats.successRequests);
            const successRate = total > 0 ? Math.round((success / total) * 100) : 100;
            
            document.getElementById('totalRequests').textContent = total;
            document.getElementById('successRateBar').style.width = `${successRate}%`;
            document.getElementById('successRateText').textContent = `${successRate}% thành công`;
        }

        // ========== INITIALIZATION ==========
        
        document.addEventListener('DOMContentLoaded', function() {
            // Load licenses
            loadLicenses();
            
            // Update primary endpoint
            updatePrimaryEndpoint();
            
            // Render initial view
            renderLicenses();
            updateStats();
            updateApiStats();
            
            // Setup search input
            document.getElementById('searchInput').addEventListener('input', function() {
                renderLicenses(this.value, document.getElementById('statusFilter').value);
            });
            
            // Setup status filter
            document.getElementById('statusFilter').addEventListener('change', function() {
                renderLicenses(document.getElementById('searchInput').value, this.value);
            });
            
            // Add license button
            document.getElementById('addLicenseBtn').addEventListener('click', function() {
                editIndex = -1;
                document.getElementById('modalTitle').textContent = 'Thêm License';
                document.getElementById('licenseForm').reset();
                document.getElementById('licenseKey').readOnly = false;
                
                // Set default expiry (30 days from now)
                const defaultExpiry = new Date();
                defaultExpiry.setDate(defaultExpiry.getDate() + 30);
                document.getElementById('expiryDate').value = defaultExpiry.toISOString().substring(0, 16);
                
                updatePreview();
                
                const modal = new bootstrap.Modal(document.getElementById('licenseModal'));
                modal.show();
            });
            
            // Add first license button
            document.getElementById('addFirstLicenseBtn').addEventListener('click', function() {
                document.getElementById('addLicenseBtn').click();
            });
            
            // Generate key button
            document.getElementById('generateKeyBtn').addEventListener('click', function() {
                document.getElementById('licenseKey').value = generateLicenseKey();
                updatePreview();
            });
            
            // Quick expiry buttons
            document.getElementById('expiry30Btn').addEventListener('click', function() {
                const expiry = new Date();
                expiry.setDate(expiry.getDate() + 30);
                document.getElementById('expiryDate').value = expiry.toISOString().substring(0, 16);
                updatePreview();
            });
            
            document.getElementById('expiry90Btn').addEventListener('click', function() {
                const expiry = new Date();
                expiry.setDate(expiry.getDate() + 90);
                document.getElementById('expiryDate').value = expiry.toISOString().substring(0, 16);
                updatePreview();
            });
            
            document.getElementById('expiry1YearBtn').addEventListener('click', function() {
                const expiry = new Date();
                expiry.setFullYear(expiry.getFullYear() + 1);
                document.getElementById('expiryDate').value = expiry.toISOString().substring(0, 16);
                updatePreview();
            });
            
            document.getElementById('expiryNowBtn').addEventListener('click', function() {
                document.getElementById('expiryDate').value = new Date().toISOString().substring(0, 16);
                updatePreview();
            });
            
            // Live preview updates
            document.getElementById('licenseKey').addEventListener('input', updatePreview);
            document.getElementById('expiryDate').addEventListener('input', updatePreview);
            
            // Save license button
            document.getElementById('saveLicenseBtn').addEventListener('click', function() {
                const key = document.getElementById('licenseKey').value.toUpperCase();
                const expiry = document.getElementById('expiryDate').value;
                const note = document.getElementById('licenseNote').value;
                
                // Validation
                if (!key.match(/^[A-Z0-9\-_]{5,50}$/)) {
                    document.getElementById('licenseError').textContent = 'License key không hợp lệ. Chỉ chữ hoa, số, dấu gạch ngang và gạch dưới, 5-50 ký tự.';
                    document.getElementById('licenseError').classList.remove('d-none');
                    return;
                }
                
                // Check for duplicate key (only when adding new)
                if (editIndex === -1 && licenses.some(license => license.key.toUpperCase() === key)) {
                    document.getElementById('licenseError').textContent = 'License key đã tồn tại. Vui lòng chọn key khác.';
                    document.getElementById('licenseError').classList.remove('d-none');
                    return;
                }
                
                const now = new Date();
                
                if (editIndex === -1) {
                    // Add new license
                    licenses.push({
                        key: key,
                        expiry: new Date(expiry).toISOString(),
                        note: note,
                        created: now.toISOString(),
                        updated: now.toISOString()
                    });
                    showToast('Đã thêm license thành công!', 'success');
                } else {
                    // Update existing license
                    licenses[editIndex] = {
                        ...licenses[editIndex],
                        expiry: new Date(expiry).toISOString(),
                        note: note,
                        updated: now.toISOString()
                    };
                    showToast('Đã cập nhật license thành công!', 'success');
                }
                
                saveLicenses();
                renderLicenses();
                updateStats();
                
                const modal = bootstrap.Modal.getInstance(document.getElementById('licenseModal'));
                modal.hide();
            });
            
            // Verify license button
            document.getElementById('verifyBtn').addEventListener('click', function() {
                const key = document.getElementById('verifyKeyInput').value;
                const result = verifyLicenseApi(key);
                
                document.getElementById('verifyResult').classList.remove('d-none');
                
                let alertClass = '';
                let alertTitle = '';
                
                if (result.valid) {
                    alertClass = result.status === 'expiring' ? 'alert-warning' : 'alert-success';
                    alertTitle = result.status === 'expiring' ? 'License sắp hết hạn' : 'License hợp lệ';
                } else {
                    alertClass = 'alert-danger';
                    alertTitle = 'License không hợp lệ';
                }
                
                document.getElementById('verifyAlert').className = `alert ${alertClass}`;
                document.getElementById('verifyTitle').textContent = alertTitle;
                document.getElementById('verifyResultKey').textContent = result.key || key;
                document.getElementById('verifyExpiry').textContent = result.expiry ? formatDateTime(result.expiry) : 'N/A';
                
                let statusClass = '';
                let statusText = '';
                if (result.status === 'valid') {
                    statusClass = 'bg-success text-white';
                    statusText = 'CÒN HẠN';
                } else if (result.status === 'expiring') {
                    statusClass = 'bg-warning text-dark';
                    statusText = 'SẮP HẾT';
                } else {
                    statusClass = 'bg-danger text-white';
                    statusText = 'HẾT HẠN';
                }
                
                document.getElementById('verifyStatus').className = `status-badge ${statusClass}`;
                document.getElementById('verifyStatus').textContent = statusText;
                document.getElementById('verifyTimeRemaining').textContent = result.time_remaining || 'N/A';
                document.getElementById('verifyNote').textContent = result.note || 'Không có ghi chú';
                document.getElementById('verifyRequestId').textContent = result.request_id;
                document.getElementById('verifyTimestamp').textContent = formatDateTime(result.timestamp);
                
                // Update API endpoint URL
                const endpointUrl = window.location.origin + window.location.pathname + '?api=true&key=' + key;
                document.getElementById('verifyEndpointUrl').value = endpointUrl;
            });
            
            // Test key buttons
            document.getElementById('testKey1Btn').addEventListener('click', function() {
                document.getElementById('verifyKeyInput').value = 'LIC-WBB61UL-F700';
                document.getElementById('verifyBtn').click();
            });
            
            document.getElementById('testKey2Btn').addEventListener('click', function() {
                document.getElementById('verifyKeyInput').value = 'LICC-WBB61_ULF_F700';
                document.getElementById('verifyBtn').click();
            });
            
            // Generate QR button
            document.getElementById('generateQrBtn').addEventListener('click', function() {
                const key = document.getElementById('qrKeyInput').value;
                generateQrCode(key);
            });
            
            // Test API button
            document.getElementById('testApiBtn').addEventListener('click', async function() {
                const key = document.getElementById('testApiKey').value;
                const apiUrl = window.location.origin + window.location.pathname + '?api=true&key=' + key;
                
                try {
                    const response = await fetch(apiUrl);
                    const data = await response.json();
                    
                    // Update API stats
                    let totalRequests = parseInt(localStorage.getItem('apiTotalRequests') || 0);
                    let successRequests = parseInt(localStorage.getItem('apiSuccessRequests') || 0);
                    totalRequests++;
                    if (data.success) successRequests++;
                    
                    localStorage.setItem('apiTotalRequests', totalRequests);
                    localStorage.setItem('apiSuccessRequests', successRequests);
                    updateApiStats();
                    
                    document.getElementById('apiResponse').textContent = JSON.stringify(data, null, 2);
                    showToast('API test thành công!', 'success');
                } catch (error) {
                    console.error('API test error:', error);
                    document.getElementById('apiResponse').textContent = `Lỗi: ${error.message}`;
                    showToast('API test thất bại!', 'error');
                }
            });
            
            // Copy response button
            document.getElementById('copyResponseBtn').addEventListener('click', function() {
                const responseText = document.getElementById('apiResponse').textContent;
                navigator.clipboard.writeText(responseText).then(() => {
                    showToast('Đã sao chép response vào clipboard!', 'success');
                });
            });
            
            // Clear response button
            document.getElementById('clearResponseBtn').addEventListener('click', function() {
                document.getElementById('apiResponse').textContent = 'Kết quả sẽ hiển thị ở đây...';
            });
            
            // Browser test button
            document.getElementById('browserTestBtn').addEventListener('click', function() {
                const testKey = 'LIC-WBB61UL-F700';
                const apiUrl = window.location.origin + window.location.pathname + '?api=true&key=' + testKey;
                window.open(apiUrl, '_blank');
            });
            
            // cURL test button
            document.getElementById('curlTestBtn').addEventListener('click', function() {
                const testKey = 'LIC-WBB61UL-F700';
                const apiUrl = window.location.origin + window.location.pathname + '?api=true&key=' + testKey;
                const curlCommand = `curl "${apiUrl}"`;
                
                showToast(`cURL command: ${curlCommand}`, 'info');
            });
            
            // Postman button
            document.getElementById('postmanBtn').addEventListener('click', function() {
                alert('Để test với Postman:\n1. Tạo request GET\n2. Dán API endpoint URL\n3. Thêm query parameter "key" với giá trị license key\n4. Send request');
            });
            
            // Quick test buttons
            document.getElementById('quickTestValidBtn').addEventListener('click', function() {
                const testKey = 'LIC-WBB61UL-F700';
                const apiUrl = window.location.origin + window.location.pathname + '?api=true&key=' + testKey;
                testApiEndpoint(apiUrl);
            });
            
            document.getElementById('quickTestInvalidBtn').addEventListener('click', function() {
                const testKey = 'INVALID-LICENSE-KEY';
                const apiUrl = window.location.origin + window.location.pathname + '?api=true&key=' + testKey;
                testApiEndpoint(apiUrl);
            });
            
            document.getElementById('quickTestNoKeyBtn').addEventListener('click', function() {
                const apiUrl = window.location.origin + window.location.pathname + '?api=true';
                testApiEndpoint(apiUrl);
            });
            
            // Refresh API status button
            document.getElementById('refreshApiStatusBtn').addEventListener('click', function() {
                const indicator = document.getElementById('apiStatusIndicator');
                const statusText = document.getElementById('apiStatusText');
                
                indicator.innerHTML = '<div class="spinner-border text-success" role="status"></div>';
                statusText.textContent = 'Đang kiểm tra...';
                
                setTimeout(() => {
                    indicator.innerHTML = '<i class="bi bi-check-circle-fill text-success" style="font-size: 3rem;"></i>';
                    statusText.textContent = 'API đang hoạt động';
                    showToast('API status: Hoạt động bình thường', 'success');
                }, 1000);
            });
            
            // Function to test API endpoint
            async function testApiEndpoint(url) {
                try {
                    const response = await fetch(url);
                    const data = await response.json();
                    document.getElementById('quickTestResult').textContent = JSON.stringify(data, null, 2);
                    
                    // Update API stats
                    let totalRequests = parseInt(localStorage.getItem('apiTotalRequests') || 0);
                    let successRequests = parseInt(localStorage.getItem('apiSuccessRequests') || 0);
                    totalRequests++;
                    if (data.success) successRequests++;
                    
                    localStorage.setItem('apiTotalRequests', totalRequests);
                    localStorage.setItem('apiSuccessRequests', successRequests);
                    updateApiStats();
                    
                    showToast('API test thành công!', 'success');
                } catch (error) {
                    document.getElementById('quickTestResult').textContent = `Lỗi: ${error.message}`;
                    showToast('API test thất bại!', 'error');
                }
            }
            
            // Start countdown timer
            countdownInterval = setInterval(() => {
                // Re-render licenses to update countdowns
                renderLicenses(
                    document.getElementById('searchInput').value,
                    document.getElementById('statusFilter').value
                );
            }, 60000); // Update every minute
            
            // Show welcome toast
            setTimeout(() => {
                showToast('Chào mừng đến với License Manager Pro!', 'info');
            }, 1000);
        });
    </script>
</body>
</html>
