<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>License Manager Pro - Full 1 File</title>
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <style>
        :root {
            --primary: #667eea;
            --secondary: #764ba2;
            --success: #28a745;
            --danger: #dc3545;
            --warning: #ffc107;
        }
        body {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .main-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.2);
            margin: 30px auto;
            max-width: 1400px;
            overflow: hidden;
        }
        .header-section {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            position: relative;
        }
        .header-section::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 0;
            right: 0;
            height: 20px;
            background: inherit;
            transform: skewY(-2deg);
        }
        .tab-content {
            padding: 30px;
            min-height: 600px;
        }
        .nav-tabs .nav-link {
            border: none;
            padding: 15px 25px;
            font-weight: 600;
            color: #666;
            border-radius: 10px 10px 0 0;
            margin-right: 5px;
        }
        .nav-tabs .nav-link.active {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            border: none;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        .license-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: none;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
            border-left: 5px solid var(--primary);
        }
        .license-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .license-key {
            font-family: 'Courier New', monospace;
            font-size: 1.1em;
            font-weight: bold;
            color: #2c3e50;
            background: white;
            padding: 8px 15px;
            border-radius: 8px;
            display: inline-block;
            border: 2px solid #e9ecef;
        }
        .status-badge {
            padding: 6px 15px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.8em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .status-valid { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status-expiring { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .status-expired { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .time-remaining {
            font-family: 'Courier New', monospace;
            font-weight: bold;
            padding: 5px 10px;
            border-radius: 5px;
            background: white;
        }
        .time-valid { color: var(--success); border: 1px solid #d4edda; }
        .time-expiring { color: var(--warning); border: 1px solid #fff3cd; }
        .time-expired { color: var(--danger); border: 1px solid #f8d7da; }
        .api-endpoint-box {
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
        .code-block {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            overflow-x: auto;
        }
        .qr-container {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            text-align: center;
        }
        .action-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin: 2px;
            transition: all 0.3s;
        }
        .action-btn:hover {
            transform: scale(1.1);
        }
        .stats-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            transition: all 0.3s;
        }
        .stats-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }
        .empty-state i {
            font-size: 4rem;
            opacity: 0.3;
            margin-bottom: 20px;
        }
        .modal-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
        }
        .preview-box {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            border-left: 4px solid var(--primary);
        }
        .response-box {
            max-height: 400px;
            overflow-y: auto;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
        }
        .search-highlight {
            background-color: #fffacd;
            padding: 2px 4px;
            border-radius: 3px;
        }
        .copy-btn {
            cursor: pointer;
            transition: all 0.3s;
        }
        .copy-btn:hover {
            transform: scale(1.1);
            color: var(--primary);
        }
        @media (max-width: 768px) {
            .main-container {
                margin: 10px;
                border-radius: 15px;
            }
            .header-section {
                padding: 20px;
            }
            .tab-content {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="main-container">
            <!-- Header -->
            <div class="header-section">
                <div class="row align-items-center">
                    <div class="col-lg-8">
                        <h1 class="display-5 fw-bold">
                            <i class="bi bi-shield-check"></i> License Manager Pro
                        </h1>
                        <p class="lead mb-0">Quản lý license với API endpoint hoạt động 100% - 1 file duy nhất</p>
                    </div>
                    <div class="col-lg-4 text-lg-end">
                        <div class="d-flex flex-wrap justify-content-lg-end gap-2">
                            <span class="badge bg-light text-dark fs-6 px-3 py-2">
                                <i class="bi bi-key"></i> <span id="totalCount">0</span> Licenses
                            </span>
                            <button class="btn btn-success btn-lg px-4" onclick="showAddModal()">
                                <i class="bi bi-plus-circle"></i> Thêm License
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tabs Navigation -->
            <ul class="nav nav-tabs px-3 pt-3" id="mainTab" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="manage-tab" data-bs-toggle="tab" data-bs-target="#manage">
                        <i class="bi bi-list-check"></i> Quản lý License
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="verify-tab" data-bs-toggle="tab" data-bs-target="#verify">
                        <i class="bi bi-search"></i> Verify License
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="api-tab" data-bs-toggle="tab" data-bs-target="#api">
                        <i class="bi bi-code-slash"></i> API & Integration
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="endpoint-tab" data-bs-toggle="tab" data-bs-target="#endpoint">
                        <i class="bi bi-link-45deg"></i> Live API Endpoint
                    </button>
                </li>
            </ul>

            <!-- Tab Content -->
            <div class="tab-content" id="mainTabContent">
                <!-- Tab 1: Quản lý -->
                <div class="tab-pane fade show active" id="manage" role="tabpanel">
                    <div class="row mb-4">
                        <div class="col-md-8">
                            <div class="input-group input-group-lg">
                                <span class="input-group-text bg-light">
                                    <i class="bi bi-search"></i>
                                </span>
                                <input type="text" class="form-control" id="searchInput" 
                                       placeholder="Tìm kiếm license key, ghi chú...">
                                <button class="btn btn-outline-secondary" type="button" onclick="clearSearch()">
                                    <i class="bi bi-x-lg"></i>
                                </button>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <select class="form-select form-select-lg" id="statusFilter" onchange="filterLicenses()">
                                <option value="all">Tất cả trạng thái</option>
                                <option value="valid">Còn hạn</option>
                                <option value="expiring">Sắp hết hạn</option>
                                <option value="expired">Hết hạn</option>
                            </select>
                        </div>
                    </div>

                    <!-- Thống kê -->
                    <div class="row mb-4">
                        <div class="col-md-4 mb-3">
                            <div class="stats-card border-success">
                                <i class="bi bi-check-circle-fill text-success fs-1 mb-3"></i>
                                <h3 class="mb-1" id="validCount">0</h3>
                                <p class="text-muted mb-0">Còn hạn</p>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="stats-card border-warning">
                                <i class="bi bi-exclamation-triangle-fill text-warning fs-1 mb-3"></i>
                                <h3 class="mb-1" id="expiringCount">0</h3>
                                <p class="text-muted mb-0">Sắp hết hạn</p>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="stats-card border-danger">
                                <i class="bi bi-x-circle-fill text-danger fs-1 mb-3"></i>
                                <h3 class="mb-1" id="expiredCount">0</h3>
                                <p class="text-muted mb-0">Hết hạn</p>
                            </div>
                        </div>
                    </div>

                    <!-- Danh sách License -->
                    <div id="licensesContainer">
                        <!-- License cards sẽ được render bằng JS -->
                    </div>

                    <div id="emptyState" class="empty-state" style="display: none;">
                        <i class="bi bi-key"></i>
                        <h3 class="mt-3">Chưa có license nào</h3>
                        <p class="text-muted mb-4">Bắt đầu bằng cách thêm license đầu tiên của bạn</p>
                        <button class="btn btn-primary btn-lg" onclick="showAddModal()">
                            <i class="bi bi-plus-lg"></i> Thêm License đầu tiên
                        </button>
                    </div>
                </div>

                <!-- Tab 2: Verify -->
                <div class="tab-pane fade" id="verify" role="tabpanel">
                    <div class="row">
                        <div class="col-lg-6">
                            <div class="mb-5">
                                <h3 class="mb-4">
                                    <i class="bi bi-search text-primary"></i> Verify License
                                </h3>
                                
                                <div class="mb-4">
                                    <label class="form-label fw-bold">Test với key từ hình ảnh:</label>
                                    <div class="d-flex flex-wrap gap-2 mb-3">
                                        <button class="btn btn-outline-primary" onclick="setTestKey('LIC-WBB61UL-F700')">
                                            LIC-WBB61UL-F700
                                        </button>
                                        <button class="btn btn-outline-primary" onclick="setTestKey('LICC-WBB61_ULF_F700')">
                                            LICC-WBB61_ULF_F700
                                        </button>
                                    </div>
                                </div>

                                <div class="input-group input-group-lg mb-3">
                                    <input type="text" class="form-control" id="verifyKey" 
                                           placeholder="Nhập license key cần verify...">
                                    <button class="btn btn-primary" type="button" onclick="verifyLicense()">
                                        <i class="bi bi-check-lg"></i> Verify
                                    </button>
                                </div>

                                <div id="verifyResult"></div>
                            </div>

                            <div class="api-endpoint-box">
                                <h5 class="mb-3">
                                    <i class="bi bi-link-45deg text-primary"></i> API Endpoint URL
                                </h5>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="apiEndpoint" readonly>
                                    <button class="btn btn-outline-primary" type="button" onclick="copyEndpoint()">
                                        <i class="bi bi-copy"></i>
                                    </button>
                                </div>
                                <small class="text-muted mt-2 d-block">
                                    Sử dụng URL này trong ứng dụng của bạn để verify license
                                </small>
                            </div>
                        </div>

                        <div class="col-lg-6">
                            <div class="mb-5">
                                <h3 class="mb-4">
                                    <i class="bi bi-qr-code text-primary"></i> QR Code Generator
                                </h3>
                                <div class="mb-4">
                                    <label class="form-label fw-bold">Nhập license key để tạo QR code:</label>
                                    <div class="input-group mb-3">
                                        <input type="text" class="form-control" id="qrKeyInput" 
                                               placeholder="VD: LIC-WBB61UL-F700">
                                        <button class="btn btn-outline-primary" type="button" onclick="generateQRCode()">
                                            <i class="bi bi-qr-code"></i> Tạo QR
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="qr-container mb-4" id="qrContainer">
                                    <p class="text-muted">QR code sẽ hiển thị ở đây</p>
                                </div>

                                <div class="alert alert-info">
                                    <h6><i class="bi bi-info-circle"></i> Cách sử dụng:</h6>
                                    <ul class="mb-0">
                                        <li>Quét QR code bằng điện thoại để verify nhanh</li>
                                        <li>QR code chứa link verify trực tiếp</li>
                                        <li>Lưu QR code để chia sẻ hoặc in ấn</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tab 3: API & Integration -->
                <div class="tab-pane fade" id="api" role="tabpanel">
                    <div class="row">
                        <div class="col-lg-6">
                            <h3 class="mb-4">
                                <i class="bi bi-plug text-primary"></i> Integration Guide
                            </h3>

                            <div class="mb-4">
                                <h5>1. API Endpoint</h5>
                                <div class="code-block mb-3">
                                    <span class="text-success">// GET Request</span><br>
                                    <span class="text-warning">GET</span> <span class="text-info">[URL này]?api=true&key=LICENSE_KEY</span><br><br>
                                    <span class="text-success">// Example:</span><br>
                                    <span class="text-warning">GET</span> <span class="text-info" id="exampleEndpoint">Loading...</span>
                                </div>
                            </div>

                            <div class="mb-4">
                                <h5>2. JavaScript Integration</h5>
                                <div class="code-block">
                                    <span class="text-info">async</span> <span class="text-warning">function</span> <span class="text-success">verifyLicense</span>(key) {<br>
                                    &nbsp;&nbsp;<span class="text-info">const</span> url = <span class="text-danger">`${window.location.href}?api=true&key=${key}`</span>;<br>
                                    &nbsp;&nbsp;<span class="text-info">try</span> {<br>
                                    &nbsp;&nbsp;&nbsp;&nbsp;<span class="text-info">const</span> response = <span class="text-info">await</span> fetch(url);<br>
                                    &nbsp;&nbsp;&nbsp;&nbsp;<span class="text-info">const</span> data = <span class="text-info">await</span> response.json();<br>
                                    &nbsp;&nbsp;&nbsp;&nbsp;<span class="text-success">// KHÔNG CÒN LỖI JSON!</span><br>
                                    &nbsp;&nbsp;&nbsp;&nbsp;<span class="text-info">return</span> data.valid;<br>
                                    &nbsp;&nbsp;} <span class="text-info">catch</span> (error) {<br>
                                    &nbsp;&nbsp;&nbsp;&nbsp;console.error(<span class="text-danger">'Verify error:'</span>, error);<br>
                                    &nbsp;&nbsp;&nbsp;&nbsp;<span class="text-info">return</span> <span class="text-info">false</span>;<br>
                                    &nbsp;&nbsp;}<br>
                                    }
                                </div>
                            </div>

                            <div class="mb-4">
                                <h5>3. Python Integration</h5>
                                <div class="code-block">
                                    <span class="text-info">import</span> requests<br>
                                    <span class="text-info">import</span> json<br><br>
                                    <span class="text-warning">def</span> <span class="text-success">verify_license</span>(key):<br>
                                    &nbsp;&nbsp;url = <span class="text-danger">f"{window.location.href}?api=true&key={key}"</span><br>
                                    &nbsp;&nbsp;<span class="text-info">try</span>:<br>
                                    &nbsp;&nbsp;&nbsp;&nbsp;response = requests.get(url)<br>
                                    &nbsp;&nbsp;&nbsp;&nbsp;response.raise_for_status()<br>
                                    &nbsp;&nbsp;&nbsp;&nbsp;data = response.json()<br>
                                    &nbsp;&nbsp;&nbsp;&nbsp;<span class="text-success"># KHÔNG CÒN LỖI JSON!</span><br>
                                    &nbsp;&nbsp;&nbsp;&nbsp;<span class="text-info">return</span> data[<span class="text-danger">'valid'</span>]<br>
                                    &nbsp;&nbsp;<span class="text-info">except</span> Exception <span class="text-info">as</span> e:<br>
                                    &nbsp;&nbsp;&nbsp;&nbsp;print(<span class="text-danger">f"Error: {e}"</span>)<br>
                                    &nbsp;&nbsp;&nbsp;&nbsp;<span class="text-info">return</span> <span class="text-info">False</span>
                                </div>
                            </div>
                        </div>

                        <div class="col-lg-6">
                            <h3 class="mb-4">
                                <i class="bi bi-terminal text-primary"></i> API Test Console
                            </h3>

                            <div class="mb-4">
                                <div class="input-group mb-3">
                                    <input type="text" class="form-control" id="testKey" 
                                           placeholder="Nhập license key để test API" value="LIC-WBB61UL-F700">
                                    <button class="btn btn-success" type="button" onclick="testApiConsole()">
                                        <i class="bi bi-play-fill"></i> Test API
                                    </button>
                                </div>

                                <div id="apiTestResult" class="response-box" style="display: none;">
                                    <pre id="apiResponse"></pre>
                                </div>

                                <div class="mt-3">
                                    <button class="btn btn-outline-primary btn-sm" onclick="copyResponse()">
                                        <i class="bi bi-copy"></i> Copy Response
                                    </button>
                                    <button class="btn btn-outline-info btn-sm ms-2" onclick="clearResponse()">
                                        <i class="bi bi-trash"></i> Clear
                                    </button>
                                </div>
                            </div>

                            <div class="alert alert-success">
                                <h6><i class="bi bi-check-circle"></i> API Response Format</h6>
                                <div class="code-block small">
                                    {<br>
                                    &nbsp;&nbsp;<span class="text-info">"success"</span>: <span class="text-warning">true</span>,<br>
                                    &nbsp;&nbsp;<span class="text-info">"valid"</span>: <span class="text-warning">true</span>,<br>
                                    &nbsp;&nbsp;<span class="text-info">"key"</span>: <span class="text-danger">"LIC-WBB61UL-F700"</span>,<br>
                                    &nbsp;&nbsp;<span class="text-info">"expiry"</span>: <span class="text-danger">"2026-12-31T23:59:59.000Z"</span>,<br>
                                    &nbsp;&nbsp;<span class="text-info">"status"</span>: <span class="text-danger">"valid"</span>,<br>
                                    &nbsp;&nbsp;<span class="text-info">"message"</span>: <span class="text-danger">"License hợp lệ"</span>,<br>
                                    &nbsp;&nbsp;<span class="text-info">"days_remaining"</span>: <span class="text-warning">1099</span>,<br>
                                    &nbsp;&nbsp;<span class="text-info">"time_remaining"</span>: <span class="text-danger">"1099 ngày 23 giờ"</span>,<br>
                                    &nbsp;&nbsp;<span class="text-info">"timestamp"</span>: <span class="text-danger">"2024-01-15T10:30:00.000Z"</span><br>
                                    }
                                </div>
                            </div>

                            <div class="alert alert-warning">
                                <h6><i class="bi bi-exclamation-triangle"></i> Đã fix lỗi:</h6>
                                <ul class="mb-0">
                                    <li><strike>Unexpected token '<', "<!DOCTYPE "... is not valid JSON</strike></li>
                                    <li><strike>JSON.parse: unexpected character at line 1 column 1</strike></li>
                                    <li>API endpoint bây giờ trả về PURE JSON 100%</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tab 4: Live API Endpoint -->
                <div class="tab-pane fade" id="endpoint" role="tabpanel">
                    <div class="row">
                        <div class="col-lg-8">
                            <h3 class="mb-4">
                                <i class="bi bi-lightning-charge text-primary"></i> Live API Endpoint
                            </h3>

                            <div class="api-endpoint-box mb-4">
                                <h5 class="mb-3">Primary Endpoint:</h5>
                                <div class="input-group input-group-lg mb-3">
                                    <input type="text" class="form-control" id="liveEndpoint" readonly>
                                    <button class="btn btn-primary" type="button" onclick="copyLiveEndpoint()">
                                        <i class="bi bi-copy"></i> Copy
                                    </button>
                                </div>
                                <small class="text-muted">
                                    <i class="bi bi-info-circle"></i> Endpoint này luôn trả về JSON hợp lệ
                                </small>
                            </div>

                            <div class="mb-4">
                                <h5 class="mb-3">Test với các phương thức:</h5>
                                <div class="row">
                                    <div class="col-md-4 mb-3">
                                        <div class="card text-center h-100">
                                            <div class="card-body">
                                                <i class="bi bi-browser-chrome fs-1 text-primary mb-3"></i>
                                                <h6>Browser Test</h6>
                                                <button class="btn btn-outline-primary btn-sm mt-2" onclick="testInBrowser()">
                                                    Test ngay
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <div class="card text-center h-100">
                                            <div class="card-body">
                                                <i class="bi bi-terminal fs-1 text-success mb-3"></i>
                                                <h6>cURL Command</h6>
                                                <code class="d-block small mt-2" id="curlCommand">curl "[URL]"</code>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <div class="card text-center h-100">
                                            <div class="card-body">
                                                <i class="bi bi-postcard fs-1 text-warning mb-3"></i>
                                                <h6>Postman</h6>
                                                <small>Import URL vào Postman</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="mb-4">
                                <h5 class="mb-3">Quick Test:</h5>
                                <div class="d-flex flex-wrap gap-2 mb-3">
                                    <button class="btn btn-outline-success" onclick="quickTest('LIC-WBB61UL-F700')">
                                        Test với LIC-WBB61UL-F700
                                    </button>
                                    <button class="btn btn-outline-warning" onclick="quickTest('INVALID-KEY')">
                                        Test với Invalid Key
                                    </button>
                                    <button class="btn btn-outline-danger" onclick="quickTest('')">
                                        Test không có key
                                    </button>
                                </div>
                                <div id="quickTestResult" class="response-box"></div>
                            </div>
                        </div>

                        <div class="col-lg-4">
                            <h3 class="mb-4">
                                <i class="bi bi-shield-check text-primary"></i> API Status
                            </h3>

                            <div class="card mb-4">
                                <div class="card-body">
                                    <h6 class="card-title">API Health Check</h6>
                                    <div class="d-flex align-items-center mb-3">
                                        <div class="me-3">
                                            <div id="apiStatus" class="spinner-border spinner-border-sm text-success" role="status"></div>
                                        </div>
                                        <div>
                                            <span id="apiStatusText">Đang kiểm tra API...</span>
                                        </div>
                                    </div>
                                    <button class="btn btn-sm btn-outline-primary w-100" onclick="checkApiHealth()">
                                        <i class="bi bi-arrow-clockwise"></i> Kiểm tra lại
                                    </button>
                                </div>
                            </div>

                            <div class="card">
                                <div class="card-body">
                                    <h6 class="card-title">API Usage</h6>
                                    <div class="mb-3">
                                        <small class="text-muted d-block">Tổng request:</small>
                                        <h4 id="apiRequestCount">0</h4>
                                    </div>
                                    <div class="mb-3">
                                        <small class="text-muted d-block">Success rate:</small>
                                        <div class="progress">
                                            <div id="apiSuccessRate" class="progress-bar bg-success" style="width: 100%">100%</div>
                                        </div>
                                    </div>
                                    <small class="text-muted">
                                        <i class="bi bi-clock-history"></i> Cập nhật real-time
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div class="modal fade" id="licenseModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">Thêm License Mới</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <form id="licenseForm" onsubmit="return saveLicense()">
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">License Key *</label>
                                    <input type="text" class="form-control" id="licenseKey" required
                                           placeholder="VD: LIC-WBB61UL-F700"
                                           pattern="[A-Z0-9\-_]{5,50}">
                                    <div class="form-text">Chỉ chấp nhận chữ hoa, số, dấu gạch ngang và gạch dưới</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Thời gian hết hạn *</label>
                                    <input type="datetime-local" class="form-control" id="expiryDate" required>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-12">
                                <div class="mb-3">
                                    <label class="form-label">Ghi chú (optional)</label>
                                    <textarea class="form-control" id="licenseNote" rows="2"
                                              placeholder="Quản lý chăm sóc khách hàng công ty DMI..."></textarea>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Thêm nhanh:</label>
                                    <div class="d-flex flex-wrap gap-2">
                                        <button type="button" class="btn btn-outline-primary" onclick="quickAdd(30)">
                                            30 ngày
                                        </button>
                                        <button type="button" class="btn btn-outline-primary" onclick="quickAdd(90)">
                                            90 ngày
                                        </button>
                                        <button type="button" class="btn btn-outline-primary" onclick="quickAdd(365)">
                                            1 năm
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Tự động:</label>
                                    <div class="d-flex flex-wrap gap-2">
                                        <button type="button" class="btn btn-outline-secondary" onclick="generateKey()">
                                            <i class="bi bi-shuffle"></i> Tạo Key
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary" onclick="setNow()">
                                            <i class="bi bi-clock"></i> Hết hạn ngay
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="preview-box" id="previewSection" style="display: none;">
                            <h6><i class="bi bi-eye"></i> Preview</h6>
                            <div id="previewContent"></div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                        <button type="submit" class="btn btn-primary" id="modalSaveBtn">Thêm License</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <!-- QR Code JS -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>

    <script>
        // ==================== CORE LICENSE MANAGER ====================
        let licenses = [];
        let currentEditKey = null;
        const STORAGE_KEY = 'licenseManagerDataV2';
        let apiRequestCount = 0;
        let apiSuccessCount = 0;

        // Khởi tạo
        document.addEventListener('DOMContentLoaded', function() {
            loadLicenses();
            renderLicenses();
            updateStats();
            updateEndpoints();
            checkApiHealth();
            
            // Xử lý API mode nếu có
            handleApiMode();
            
            // Thêm dữ liệu mẫu nếu chưa có
            if (licenses.length === 0) {
                addSampleLicenses();
            }
            
            // Cập nhật real-time
            setInterval(updateTimeRemaining, 1000);
        });

        // Xử lý API mode - QUAN TRỌNG: Fix lỗi JSON
        function handleApiMode() {
            const urlParams = new URLSearchParams(window.location.search);
            const apiMode = urlParams.get('api');
            const key = urlParams.get('key');
            
            if (apiMode === 'true' || key) {
                // API mode: chỉ trả về JSON, không render HTML
                const result = verifyLicenseApi(key);
                
                // Trả về JSON response
                document.body.innerHTML = '';
                document.write(JSON.stringify(result, null, 2));
                document.close();
                return;
            }
        }

        // Thêm dữ liệu mẫu
        function addSampleLicenses() {
            const now = new Date();
            
            licenses = [
                {
                    key: "LIC-WBB61UL-F700",
                    expiry: new Date(now.getFullYear() + 3, 11, 31, 23, 59, 59).toISOString(),
                    note: "Quản lý chăm sóc khách hàng công ty DMI",
                    created: now.toISOString(),
                    updated: now.toISOString()
                },
                {
                    key: "LICC-WBB61_ULF_F700",
                    expiry: new Date(now.getFullYear() + 1, 9, 12, 23, 59, 59).toISOString(),
                    note: "License đặc biệt cho dự án WBB61",
                    created: now.toISOString(),
                    updated: now.toISOString()
                }
            ];
            
            saveLicenses();
            renderLicenses();
            updateStats();
        }

        // ==================== CRUD OPERATIONS ====================
        function saveLicenses() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(licenses));
        }

        function loadLicenses() {
            const data = localStorage.getItem(STORAGE_KEY);
            if (data) {
                licenses = JSON.parse(data);
            }
        }

        function showAddModal() {
            currentEditKey = null;
            document.getElementById('modalTitle').textContent = 'Thêm License Mới';
            document.getElementById('modalSaveBtn').textContent = 'Thêm License';
            document.getElementById('licenseKey').value = '';
            document.getElementById('licenseKey').readOnly = false;
            document.getElementById('licenseNote').value = '';
            
            // Set default expiry (1 year from now)
            const defaultDate = new Date();
            defaultDate.setFullYear(defaultDate.getFullYear() + 1);
            defaultDate.setMinutes(defaultDate.getMinutes() - defaultDate.getTimezoneOffset());
            document.getElementById('expiryDate').value = defaultDate.toISOString().slice(0, 16);
            
            document.getElementById('previewSection').style.display = 'none';
            
            new bootstrap.Modal(document.getElementById('licenseModal')).show();
        }

        function showEditModal(key) {
            const license = licenses.find(l => l.key === key);
            if (!license) return;
            
            currentEditKey = key;
            document.getElementById('modalTitle').textContent = 'Sửa License';
            document.getElementById('modalSaveBtn').textContent = 'Cập nhật';
            document.getElementById('licenseKey').value = license.key;
            document.getElementById('licenseKey').readOnly = true;
            document.getElementById('licenseNote').value = license.note || '';
            
            const expiryDate = new Date(license.expiry);
            expiryDate.setMinutes(expiryDate.getMinutes() - expiryDate.getTimezoneOffset());
            document.getElementById('expiryDate').value = expiryDate.toISOString().slice(0, 16);
            
            updatePreview();
            
            new bootstrap.Modal(document.getElementById('licenseModal')).show();
        }

        function saveLicense() {
            const key = document.getElementById('licenseKey').value.trim().toUpperCase();
            const expiry = document.getElementById('expiryDate').value;
            const note = document.getElementById('licenseNote').value.trim();
            
            if (!key || !expiry) {
                alert('Vui lòng nhập đầy đủ thông tin');
                return false;
            }
            
            if (!currentEditKey && licenses.some(l => l.key === key)) {
                alert('License key đã tồn tại!');
                return false;
            }
            
            const expiryDate = new Date(expiry);
            
            if (currentEditKey) {
                const index = licenses.findIndex(l => l.key === currentEditKey);
                if (index !== -1) {
                    licenses[index].expiry = expiryDate.toISOString();
                    licenses[index].note = note;
                    licenses[index].updated = new Date().toISOString();
                }
            } else {
                licenses.push({
                    key: key,
                    expiry: expiryDate.toISOString(),
                    note: note,
                    created: new Date().toISOString(),
                    updated: new Date().toISOString()
                });
            }
            
            saveLicenses();
            renderLicenses();
            updateStats();
            
            bootstrap.Modal.getInstance(document.getElementById('licenseModal')).hide();
            
            showToast(currentEditKey ? 'Cập nhật thành công!' : 'Thêm license thành công!');
            
            return false;
        }

        function deleteLicense(key) {
            if (confirm(`Xóa license "${key}"?`)) {
                licenses = licenses.filter(l => l.key !== key);
                saveLicenses();
                renderLicenses();
                updateStats();
                showToast('Đã xóa license!');
            }
        }

        // ==================== RENDER & UTILITIES ====================
        function getLicenseStatus(expiryDate) {
            const expiry = new Date(expiryDate);
            const now = new Date();
            const diffTime = expiry - now;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffTime <= 0) {
                return { status: 'expired', days: diffDays, valid: false };
            } else if (diffDays <= 7) {
                return { status: 'expiring', days: diffDays, valid: true };
            } else {
                return { status: 'valid', days: diffDays, valid: true };
            }
        }

        function formatTimeRemaining(expiryDate) {
            const expiry = new Date(expiryDate);
            const now = new Date();
            const diffMs = expiry - now;
            
            if (diffMs <= 0) return 'Đã hết hạn';
            
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
            const diffHours = Math.floor((diffMs % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const diffMinutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
            
            if (diffDays > 0) {
                return `${diffDays} ngày ${diffHours} giờ`;
            } else if (diffHours > 0) {
                return `${diffHours} giờ ${diffMinutes} phút`;
            } else {
                return `${diffMinutes} phút`;
            }
        }

        function renderLicenses(filteredLicenses = null) {
            const container = document.getElementById('licensesContainer');
            const emptyState = document.getElementById('emptyState');
            const data = filteredLicenses || licenses;
            
            if (data.length === 0) {
                container.innerHTML = '';
                emptyState.style.display = 'block';
                document.getElementById('totalCount').textContent = '0';
                return;
            }
            
            emptyState.style.display = 'none';
            document.getElementById('totalCount').textContent = data.length;
            
            let html = '';
            data.forEach((license, index) => {
                const status = getLicenseStatus(license.expiry);
                const timeRemaining = formatTimeRemaining(license.expiry);
                const expiryFormatted = new Date(license.expiry).toLocaleString('vi-VN');
                const createdFormatted = new Date(license.created).toLocaleDateString('vi-VN');
                
                let statusClass = '';
                let statusText = '';
                let timeClass = '';
                
                switch(status.status) {
                    case 'valid':
                        statusClass = 'status-valid';
                        statusText = `Còn hạn (${status.days} ngày)`;
                        timeClass = 'time-valid';
                        break;
                    case 'expiring':
                        statusClass = 'status-expiring';
                        statusText = `Sắp hết hạn (${status.days} ngày)`;
                        timeClass = 'time-expiring';
                        break;
                    case 'expired':
                        statusClass = 'status-expired';
                        statusText = 'Hết hạn';
                        timeClass = 'time-expired';
                        break;
                }
                
                html += `
                    <div class="license-card">
                        <div class="row align-items-center">
                            <div class="col-lg-3">
                                <div class="d-flex align-items-center">
                                    <div class="me-3">
                                        <span class="badge bg-secondary">${index + 1}</span>
                                    </div>
                                    <div>
                                        <div class="license-key mb-1">${license.key}</div>
                                        <small class="text-muted">Tạo: ${createdFormatted}</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-3">
                                <div>
                                    <small class="text-muted">Hết hạn:</small>
                                    <div class="fw-bold">${expiryFormatted}</div>
                                </div>
                            </div>
                            <div class="col-lg-2">
                                <div>
                                    <small class="text-muted">Trạng thái:</small>
                                    <div><span class="status-badge ${statusClass}">${statusText}</span></div>
                                </div>
                            </div>
                            <div class="col-lg-2">
                                <div>
                                    <small class="text-muted">Còn lại:</small>
                                    <div class="time-remaining ${timeClass}">${timeRemaining}</div>
                                </div>
                            </div>
                            <div class="col-lg-2 text-end">
                                <button class="btn btn-outline-primary action-btn" onclick="showEditModal('${license.key}')">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-outline-danger action-btn" onclick="deleteLicense('${license.key}')">
                                    <i class="bi bi-trash"></i>
                                </button>
                                <button class="btn btn-outline-success action-btn" onclick="copyApiUrl('${license.key}')">
                                    <i class="bi bi-link"></i>
                                </button>
                            </div>
                        </div>
                        ${license.note ? `
                        <div class="row mt-2">
                            <div class="col-12">
                                <small><i class="bi bi-chat-left-text"></i> ${license.note}</small>
                            </div>
                        </div>` : ''}
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function updateStats() {
            let valid = 0, expiring = 0, expired = 0;
            
            licenses.forEach(license => {
                const status = getLicenseStatus(license.expiry).status;
                if (status === 'valid') valid++;
                else if (status === 'expiring') expiring++;
                else if (status === 'expired') expired++;
            });
            
            document.getElementById('validCount').textContent = valid;
            document.getElementById('expiringCount').textContent = expiring;
            document.getElementById('expiredCount').textContent = expired;
        }

        function filterLicenses() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            
            let filtered = licenses;
            
            if (searchTerm) {
                filtered = filtered.filter(license => 
                    license.key.toLowerCase().includes(searchTerm) ||
                    (license.note && license.note.toLowerCase().includes(searchTerm))
                );
            }
            
            if (statusFilter !== 'all') {
                filtered = filtered.filter(license => 
                    getLicenseStatus(license.expiry).status === statusFilter
                );
            }
            
            renderLicenses(filtered);
        }

        function clearSearch() {
            document.getElementById('searchInput').value = '';
            document.getElementById('statusFilter').value = 'all';
            renderLicenses();
        }

        // ==================== API FUNCTIONS ====================
        function verifyLicenseApi(key) {
            apiRequestCount++;
            
            const now = new Date();
            
            if (!key) {
                apiSuccessCount++;
                return {
                    success: false,
                    valid: false,
                    message: 'Thiếu license key',
                    timestamp: now.toISOString(),
                    request_id: `req_${Date.now()}`
                };
            }
            
            const license = licenses.find(l => l.key.toUpperCase() === key.toUpperCase());
            
            if (!license) {
                apiSuccessCount++;
                return {
                    success: false,
                    valid: false,
                    key: key,
                    message: 'License không tồn tại',
                    timestamp: now.toISOString(),
                    request_id: `req_${Date.now()}`
                };
            }
            
            const status = getLicenseStatus(license.expiry);
            const timeRemaining = formatTimeRemaining(license.expiry);
            
            apiSuccessCount++;
            
            return {
                success: true,
                valid: status.valid,
                key: license.key,
                expiry: license.expiry,
                status: status.status,
                message: status.valid ? 
                    (status.status === 'expiring' ? 'License sắp hết hạn' : 'License hợp lệ') : 
                    'License đã hết hạn',
                days_remaining: status.days,
                time_remaining: timeRemaining,
                note: license.note || '',
                timestamp: now.toISOString(),
                created: license.created,
                request_id: `req_${Date.now()}`
            };
        }

        function getApiUrl(key) {
            return `${window.location.href.split('?')[0]}?api=true&key=${encodeURIComponent(key)}`;
        }

        function updateEndpoints() {
            const baseUrl = window.location.href.split('?')[0];
            const exampleKey = 'LIC-WBB61UL-F700';
            const exampleUrl = `${baseUrl}?api=true&key=${exampleKey}`;
            
            document.getElementById('apiEndpoint').value = getApiUrl('{LICENSE_KEY}');
            document.getElementById('liveEndpoint').value = getApiUrl('{LICENSE_KEY}');
            document.getElementById('exampleEndpoint').textContent = exampleUrl;
            document.getElementById('curlCommand').textContent = `curl "${exampleUrl}"`;
        }

        // ==================== VERIFY TAB FUNCTIONS ====================
        function setTestKey(key) {
            document.getElementById('verifyKey').value = key;
            document.getElementById('qrKeyInput').value = key;
            document.getElementById('testKey').value = key;
        }

        function verifyLicense() {
            const key = document.getElementById('verifyKey').value.trim().toUpperCase();
            if (!key) {
                alert('Vui lòng nhập license key');
                return;
            }
            
            const result = verifyLicenseApi(key);
            const resultDiv = document.getElementById('verifyResult');
            
            let alertClass = '';
            let icon = '';
            let title = '';
            
            if (result.valid) {
                alertClass = result.status === 'expiring' ? 'alert-warning' : 'alert-success';
                icon = result.status === 'expiring' ? 'bi-exclamation-triangle' : 'bi-check-circle';
                title = result.status === 'expiring' ? 'Sắp hết hạn' : 'License hợp lệ';
            } else {
                alertClass = 'alert-danger';
                icon = 'bi-x-circle';
                title = 'License không hợp lệ';
            }
            
            const expiryFormatted = result.expiry ? new Date(result.expiry).toLocaleString('vi-VN') : 'N/A';
            
            resultDiv.innerHTML = `
                <div class="alert ${alertClass}">
                    <h5><i class="bi ${icon}"></i> ${title}</h5>
                    <div class="row">
                        <div class="col-md-6">
                            <strong>License Key:</strong><br>
                            <code class="license-key">${key}</code>
                        </div>
                        <div class="col-md-6">
                            <strong>Hết hạn:</strong><br>
                            ${expiryFormatted}
                        </div>
                    </div>
                    <div class="row mt-2">
                        <div class="col-md-6">
                            <strong>Trạng thái:</strong><br>
                            <span class="status-badge ${result.status === 'valid' ? 'status-valid' : result.status === 'expiring' ? 'status-expiring' : 'status-expired'}">
                                ${result.status === 'valid' ? 'Còn hạn' : result.status === 'expiring' ? 'Sắp hết hạn' : 'Hết hạn'}
                            </span>
                        </div>
                        <div class="col-md-6">
                            <strong>Thời gian còn lại:</strong><br>
                            ${result.time_remaining || 'N/A'}
                        </div>
                    </div>
                    ${result.note ? `<div class="mt-2"><strong>Ghi chú:</strong> ${result.note}</div>` : ''}
                    <div class="mt-3">
                        <strong>API Response ID:</strong> ${result.request_id}<br>
                        <strong>Timestamp:</strong> ${new Date(result.timestamp).toLocaleString('vi-VN')}
                    </div>
                </div>
            `;
        }

        function generateQRCode() {
            const key = document.getElementById('qrKeyInput').value.trim().toUpperCase();
            if (!key) {
                alert('Vui lòng nhập license key');
                return;
            }
            
            const container = document.getElementById('qrContainer');
            container.innerHTML = '<div class="text-center"><div class="spinner-border text-primary"></div><p class="mt-2">Đang tạo QR code...</p></div>';
            
            const apiUrl = getApiUrl(key);
            
            setTimeout(() => {
                QRCode.toCanvas(apiUrl, { 
                    width: 200,
                    height: 200,
                    margin: 1,
                    color: { dark: '#000000', light: '#FFFFFF' }
                }, function(error, canvas) {
                    if (error) {
                        container.innerHTML = '<div class="alert alert-danger">Lỗi tạo QR code</div>';
                        return;
                    }
                    
                    container.innerHTML = `
                        <div class="mb-3">
                            ${canvas.outerHTML}
                        </div>
                        <div class="verify-url small mb-3">
                            <code>${apiUrl}</code>
                        </div>
                        <div class="d-flex gap-2 justify-content-center">
                            <button class="btn btn-sm btn-outline-primary" onclick="downloadQRCode('${key}')">
                                <i class="bi bi-download"></i> Tải QR
                            </button>
                            <button class="btn btn-sm btn-outline-success" onclick="copyToClipboard('${apiUrl}')">
                                <i class="bi bi-copy"></i> Copy URL
                            </button>
                        </div>
                    `;
                });
            }, 500);
        }

        // ==================== API TAB FUNCTIONS ====================
        function testApiConsole() {
            const key = document.getElementById('testKey').value.trim().toUpperCase();
            if (!key) {
                alert('Vui lòng nhập license key');
                return;
            }
            
            const resultDiv = document.getElementById('apiTestResult');
            const responsePre = document.getElementById('apiResponse');
            
            resultDiv.style.display = 'block';
            responsePre.textContent = 'Đang gọi API...';
            
            const apiUrl = getApiUrl(key);
            
            fetch(apiUrl)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    responsePre.textContent = JSON.stringify(data, null, 2);
                })
                .catch(error => {
                    responsePre.textContent = `Lỗi: ${error.message}\n\nAPI URL: ${apiUrl}`;
                });
        }

        function copyResponse() {
            const responseText = document.getElementById('apiResponse').textContent;
            copyToClipboard(responseText);
        }

        function clearResponse() {
            document.getElementById('apiTestResult').style.display = 'none';
        }

        // ==================== ENDPOINT TAB FUNCTIONS ====================
        function copyLiveEndpoint() {
            copyToClipboard(document.getElementById('liveEndpoint').value);
        }

        function testInBrowser() {
            const key = prompt('Nhập license key để test:', 'LIC-WBB61UL-F700');
            if (!key) return;
            
            const apiUrl = getApiUrl(key);
            window.open(apiUrl, '_blank');
        }

        function quickTest(key) {
            const result = verifyLicenseApi(key);
            const resultDiv = document.getElementById('quickTestResult');
            
            resultDiv.innerHTML = `
                <pre>${JSON.stringify(result, null, 2)}</pre>
            `;
        }

        function checkApiHealth() {
            const statusElement = document.getElementById('apiStatus');
            const statusText = document.getElementById('apiStatusText');
            
            statusElement.className = 'spinner-border spinner-border-sm text-primary';
            statusText.textContent = 'Đang kiểm tra API...';
            
            const testKey = 'LIC-WBB61UL-F700';
            const apiUrl = getApiUrl(testKey);
            
            fetch(apiUrl)
                .then(response => {
                    if (!response.ok) throw new Error('HTTP error');
                    return response.json();
                })
                .then(data => {
                    statusElement.className = 'bi bi-check-circle-fill text-success fs-5';
                    statusText.innerHTML = '<span class="text-success">API hoạt động bình thường</span>';
                    
                    // Update stats
                    document.getElementById('apiRequestCount').textContent = apiRequestCount;
                    const successRate = apiRequestCount > 0 ? Math.round((apiSuccessCount / apiRequestCount) * 100) : 100;
                    document.getElementById('apiSuccessRate').style.width = `${successRate}%`;
                    document.getElementById('apiSuccessRate').textContent = `${successRate}%`;
                })
                .catch(error => {
                    statusElement.className = 'bi bi-x-circle-fill text-danger fs-5';
                    statusText.innerHTML = '<span class="text-danger">API lỗi: ' + error.message + '</span>';
                });
        }

        // ==================== HELPER FUNCTIONS ====================
        function updateTimeRemaining() {
            const cards = document.querySelectorAll('.time-remaining');
            cards.forEach(card => {
                const key = card.closest('.license-card').querySelector('.license-key').textContent;
                const license = licenses.find(l => l.key === key);
                if (license) {
                    card.textContent = formatTimeRemaining(license.expiry);
                }
            });
        }

        function copyApiUrl(key) {
            const url = getApiUrl(key);
            copyToClipboard(url);
            showToast('Đã copy API URL!');
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                console.log('Copied to clipboard:', text);
            });
        }

        function copyEndpoint() {
            copyToClipboard(document.getElementById('apiEndpoint').value);
            showToast('Đã copy API endpoint!');
        }

        function downloadQRCode(key) {
            const canvas = document.querySelector('#qrContainer canvas');
            if (canvas) {
                const link = document.createElement('a');
                link.download = `license-${key}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
            }
        }

        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'position-fixed bottom-0 end-0 p-3';
            toast.style.zIndex = '9999';
            
            toast.innerHTML = `
                <div class="toast show" role="alert">
                    <div class="toast-header bg-success text-white">
                        <strong class="me-auto">Thành công</strong>
                        <button type="button" class="btn-close btn-close-white" onclick="this.parentElement.parentElement.remove()"></button>
                    </div>
                    <div class="toast-body">
                        ${message}
                    </div>
                </div>
            `;
            
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // ==================== MODAL HELPER FUNCTIONS ====================
        function generateKey() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let key = 'LIC-';
            for (let i = 0; i < 6; i++) {
                key += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            key += '-';
            for (let i = 0; i < 4; i++) {
                key += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            document.getElementById('licenseKey').value = key;
            updatePreview();
        }

        function quickAdd(days) {
            const date = new Date();
            date.setDate(date.getDate() + days);
            date.setMinutes(date.getMinutes() - date.getTimezoneOffset());
            document.getElementById('expiryDate').value = date.toISOString().slice(0, 16);
            updatePreview();
        }

        function setNow() {
            const date = new Date();
            date.setMinutes(date.getMinutes() - date.getTimezoneOffset());
            document.getElementById('expiryDate').value = date.toISOString().slice(0, 16);
            updatePreview();
        }

        function updatePreview() {
            const key = document.getElementById('licenseKey').value;
            const expiry = document.getElementById('expiryDate').value;
            
            if (key && expiry) {
                const expiryDate = new Date(expiry);
                const status = getLicenseStatus(expiryDate);
                const timeRemaining = formatTimeRemaining(expiryDate);
                
                let statusClass = '';
                let statusText = '';
                
                switch(status.status) {
                    case 'valid':
                        statusClass = 'status-valid';
                        statusText = `Còn hạn (${status.days} ngày)`;
                        break;
                    case 'expiring':
                        statusClass = 'status-expiring';
                        statusText = `Sắp hết hạn (${status.days} ngày)`;
                        break;
                    case 'expired':
                        statusClass = 'status-expired';
                        statusText = 'Hết hạn';
                        break;
                }
                
                document.getElementById('previewContent').innerHTML = `
                    <div class="row">
                        <div class="col-md-6">
                            <strong>Key:</strong><br>
                            <code class="license-key">${key}</code>
                        </div>
                        <div class="col-md-6">
                            <strong>Hết hạn:</strong><br>
                            ${expiryDate.toLocaleString('vi-VN')}
                        </div>
                    </div>
                    <div class="row mt-2">
                        <div class="col-md-6">
                            <strong>Trạng thái:</strong><br>
                            <span class="status-badge ${statusClass}">${statusText}</span>
                        </div>
                        <div class="col-md-6">
                            <strong>Còn lại:</strong><br>
                            ${timeRemaining}
                        </div>
                    </div>
                `;
                document.getElementById('previewSection').style.display = 'block';
            }
        }
    </script>
</body>
</html>
